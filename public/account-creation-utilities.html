<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Creation Utilities</title>
    <link rel="stylesheet" href="global.css">
    <style>
        .utility-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .utility-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .utility-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .test-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .test-form .full-width {
            grid-column: 1 / -1;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .form-control {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="utility-container">
        <h1>ğŸ”§ Account Creation Utilities</h1>
        <p>Tools for testing and debugging account creation functionality</p>

        <!-- Quick Links -->
        <div class="utility-section" style="background: #1a1a2e; border-color: #c9302c;">
            <h3 style="color: #c9302c;">ğŸ“„ Quick Navigation</h3>
            <a href="master-html-list.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                ğŸ“‹ MASTER HTML LIST
            </a>
            <a href="index-reservations.html" class="btn btn-success" style="text-decoration: none; display: inline-block;">
                ğŸ  Dashboard
            </a>
        </div>

        <!-- Test Account Creation -->
        <div class="utility-section">
            <h3>ğŸ“ Test Account Creation from Billing Data</h3>
            <div class="test-form">
                <div>
                    <label for="testFirstName">First Name:</label>
                    <input type="text" id="testFirstName" class="form-control" value="John">
                </div>
                <div>
                    <label for="testLastName">Last Name:</label>
                    <input type="text" id="testLastName" class="form-control" value="Doe">
                </div>
                <div>
                    <label for="testEmail">Email:</label>
                    <input type="email" id="testEmail" class="form-control" value="john@test.com">
                </div>
                <div>
                    <label for="testPhone">Phone:</label>
                    <input type="tel" id="testPhone" class="form-control" value="555-1234">
                </div>
                <div class="full-width">
                    <label for="testCompany">Company:</label>
                    <input type="text" id="testCompany" class="form-control" value="Test Company">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="fillReservationFormAndTest()">
                ğŸ“‹ Fill Reservation Form & Test Create Account
            </button>
            <button class="btn btn-success" onclick="testAccountDraftCreation()">
                ğŸ’¾ Test Draft Creation Only
            </button>
            <button class="btn btn-warning" onclick="openAccountsWithTestDraft()">
                ğŸŒ Open Accounts with Test Draft
            </button>
            <button class="btn btn-danger" onclick="directNavigationTest()">
                ğŸ¯ Direct Test - Go to Reservation Form
            </button>
        </div>

        <!-- Debug Tools -->
        <div class="utility-section">
            <h3>ğŸ› Debug Tools</h3>
            <button class="btn btn-primary" onclick="debugAccountCreation()">
                ğŸ” Debug Account Creation Flow
            </button>
            <button class="btn btn-success" onclick="checkReservationFormElements()">
                ğŸ“‹ Check Reservation Form Elements
            </button>
            <button class="btn btn-warning" onclick="inspectAccountDraft()">
                ğŸ“ Inspect Account Draft
            </button>
            <button class="btn btn-danger" onclick="clearAccountDraft()">
                ğŸ—‘ï¸ Clear Account Draft
            </button>
        </div>

        <!-- Draft Management -->
        <div class="utility-section">
            <h3>ğŸ“‹ Draft Management</h3>
            <button class="btn btn-primary" onclick="viewCurrentDraft()">
                ğŸ‘€ View Current Draft
            </button>
            <button class="btn btn-success" onclick="createManualDraft()">
                âœï¸ Create Manual Draft
            </button>
            <button class="btn btn-danger" onclick="deleteDraft()">
                ğŸ—‘ï¸ Delete Draft
            </button>
        </div>

        <!-- Log Output -->
        <div id="logOutput" class="log-output">Ready for testing...\n</div>
    </div>

    <script>
        // Utility logging function
        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }

        // Clear log
        function clearLog() {
            document.getElementById('logOutput').textContent = 'Log cleared...\n';
        }

        // Test functions
        function fillReservationFormAndTest() {
            log('ğŸš€ Starting reservation form fill and test...');
            
            const firstName = document.getElementById('testFirstName').value;
            const lastName = document.getElementById('testLastName').value;
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const company = document.getElementById('testCompany').value;

            // Store test data in localStorage for the reservation form to read
            const testData = {
                action: 'fillAndTest',
                data: {
                    billingFirstName: firstName,
                    billingLastName: lastName,
                    billingEmail: email,
                    billingPhone: phone,
                    billingCompany: company
                }
            };
            
            localStorage.setItem('relia_test_data', JSON.stringify(testData));
            log('ğŸ’¾ Test data stored in localStorage');

            // Try to open reservation form in new window
            const reservationUrl = 'reservation-form.html?test=1';
            const popup = window.open(reservationUrl, 'ReservationForm', 'width=1200,height=900');
            
            if (popup) {
                log('âœ… Opened reservation form with test parameter');
                
                // Listen for messages from the popup
                const messageHandler = (event) => {
                    if (event.data && event.data.source === 'reservation-form') {
                        switch (event.data.type) {
                            case 'loaded':
                                log('ğŸ“‹ Reservation form loaded');
                                // Send fill command via postMessage
                                popup.postMessage({
                                    source: 'utilities',
                                    type: 'fillBillingData',
                                    data: testData.data
                                }, '*');
                                break;
                            case 'filled':
                                log('âœ… Billing data filled successfully');
                                // Send test command
                                popup.postMessage({
                                    source: 'utilities',
                                    type: 'testCreateAccount'
                                }, '*');
                                break;
                            case 'accountCreated':
                                log('ğŸ‰ Account creation process initiated');
                                break;
                            case 'error':
                                log('âŒ Error from reservation form: ' + event.data.message);
                                break;
                        }
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // Clean up listener after 30 seconds
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    log('ğŸ§¹ Message listener cleaned up');
                }, 30000);
                
            } else {
                log('âŒ Popup blocked, storing test instruction for manual execution');
                localStorage.setItem('relia_auto_test', 'true');
                window.location.href = reservationUrl;
            }
        }

        function testAccountDraftCreation() {
            log('ğŸ’¾ Testing account draft creation...');
            
            const firstName = document.getElementById('testFirstName').value;
            const lastName = document.getElementById('testLastName').value;
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const company = document.getElementById('testCompany').value;

            const draft = {
                first_name: firstName,
                last_name: lastName,
                company_name: company,
                phone: phone,
                cell_phone: phone,
                email: email,
                type: 'individual',
                status: 'active',
                types: {
                    billing: true,
                    passenger: false,
                    booking: false
                },
                address: {
                    address_type: 'billing',
                    address_name: 'Billing',
                    address_line1: '123 Test St',
                    address_line2: 'Suite 100',
                    city: 'Test City',
                    state: 'CA',
                    zip: '12345',
                    country: 'US'
                }
            };

            try {
                localStorage.setItem('relia_account_draft', JSON.stringify(draft));
                log('âœ… Draft created successfully');
                log('ğŸ“‹ Draft content: ' + JSON.stringify(draft, null, 2));
                
                // Verify storage
                const stored = localStorage.getItem('relia_account_draft');
                if (stored) {
                    log('âœ… Draft verified in localStorage');
                } else {
                    log('âŒ Draft not found after storage');
                }
            } catch (error) {
                log('âŒ Error creating draft: ' + error.message);
            }
        }

        function openAccountsWithTestDraft() {
            log('ğŸŒ Opening accounts page with test draft...');
            
            // Create draft first
            testAccountDraftCreation();
            
            // Wait a moment, then open accounts
            setTimeout(() => {
                const url = 'accounts.html?mode=new&from=reservation';
                const popup = window.open(url, 'AccountsForm', 'width=1200,height=900');
                
                if (popup) {
                    log('âœ… Accounts page opened');
                    try { popup.focus(); } catch { /* ignore */ }
                } else {
                    log('âŒ Popup blocked, redirecting same window');
                    window.location.href = url;
                }
            }, 500);
        }

        function debugAccountCreation() {
            log('ğŸ› Running account creation debug...');
            
            // Try to access reservation form if it's open
            const reservationWindows = [window];
            
            // Check for reservation form elements
            let foundForm = false;
            
            reservationWindows.forEach(win => {
                try {
                    const createBtn = win.document.getElementById('createAccountBtn');
                    if (createBtn) {
                        foundForm = true;
                        log('1ï¸âƒ£ Create Account button found: âœ…');
                        log('   - Button text: ' + createBtn.textContent);
                        log('   - Button visible: ' + (createBtn.offsetParent !== null));
                        log('   - Button disabled: ' + createBtn.disabled);
                        
                        // Check billing fields
                        const billingFields = {
                            firstName: win.document.getElementById('billingFirstName'),
                            lastName: win.document.getElementById('billingLastName'),
                            company: win.document.getElementById('billingCompany'),
                            phone: win.document.getElementById('billingPhone'),
                            email: win.document.getElementById('billingEmail')
                        };
                        
                        log('2ï¸âƒ£ Billing form fields:');
                        Object.entries(billingFields).forEach(([name, element]) => {
                            if (element) {
                                log(`   - ${name}: ${element.value || '(empty)'}`);
                            } else {
                                log(`   - ${name}: ELEMENT NOT FOUND`);
                            }
                        });
                        
                        // Check ReservationForm instance
                        log('3ï¸âƒ£ ReservationForm instance: ' + typeof win.reservationForm);
                        if (win.reservationForm) {
                            log('   - Has createAccountFromBilling method: ' + (typeof win.reservationForm.createAccountFromBilling === 'function'));
                        }
                    }
                } catch (error) {
                    // Ignore cross-origin errors
                }
            });
            
            if (!foundForm) {
                log('âŒ No reservation form found. Please open reservation-form.html first.');
            }
            
            // Check localStorage
            const existingDraft = localStorage.getItem('relia_account_draft');
            log('4ï¸âƒ£ Existing account draft: ' + (existingDraft ? 'EXISTS' : 'NOT FOUND'));
            if (existingDraft) {
                try {
                    const parsed = JSON.parse(existingDraft);
                    log('   - Draft preview: ' + JSON.stringify(parsed, null, 2).substring(0, 200) + '...');
                } catch (e) {
                    log('   - Draft parsing error: ' + e.message);
                }
            }
        }

        function checkReservationFormElements() {
            log('ğŸ“‹ Checking reservation form elements...');
            
            // Check if we can access reservation form
            const reservationUrl = 'reservation-form.html';
            log('ğŸ” Checking for reservation form at: ' + reservationUrl);
            
            // If current page is reservation form
            if (window.location.pathname.includes('reservation-form.html')) {
                log('âœ… Currently on reservation form page');
                
                const elements = [
                    'createAccountBtn',
                    'billingFirstName', 
                    'billingLastName',
                    'billingEmail',
                    'billingPhone',
                    'billingCompany'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    log(`${element ? 'âœ…' : 'âŒ'} ${id}: ${element ? 'FOUND' : 'NOT FOUND'}`);
                });
                
            } else {
                log('âš ï¸ Not on reservation form page. Opening reservation form...');
                window.open(reservationUrl, 'ReservationForm', 'width=1200,height=900');
            }
        }

        function inspectAccountDraft() {
            log('ğŸ“ Inspecting account draft...');
            
            const draft = localStorage.getItem('relia_account_draft');
            if (draft) {
                try {
                    const parsed = JSON.parse(draft);
                    log('âœ… Account draft found:');
                    log(JSON.stringify(parsed, null, 2));
                } catch (error) {
                    log('âŒ Error parsing draft: ' + error.message);
                    log('Raw draft: ' + draft);
                }
            } else {
                log('âŒ No account draft found in localStorage');
            }
        }

        function clearAccountDraft() {
            log('ğŸ—‘ï¸ Clearing account draft...');
            
            try {
                localStorage.removeItem('relia_account_draft');
                log('âœ… Account draft cleared');
                
                // Verify
                const check = localStorage.getItem('relia_account_draft');
                if (!check) {
                    log('âœ… Verified: draft no longer exists');
                } else {
                    log('âš ï¸ Warning: draft still exists after removal');
                }
            } catch (error) {
                log('âŒ Error clearing draft: ' + error.message);
            }
        }

        function viewCurrentDraft() {
            inspectAccountDraft();
        }

        function createManualDraft() {
            log('âœï¸ Creating manual draft...');
            testAccountDraftCreation();
        }

        function deleteDraft() {
            clearAccountDraft();
        }

        function directNavigationTest() {
            log('ğŸ¯ Starting direct navigation test...');
            
            const firstName = document.getElementById('testFirstName').value;
            const lastName = document.getElementById('testLastName').value;
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const company = document.getElementById('testCompany').value;

            // Store test instructions in localStorage for manual testing
            const testInstructions = {
                message: 'Manual Test Instructions',
                steps: [
                    '1. Fill these values in the billing section:',
                    `   - First Name: ${firstName}`,
                    `   - Last Name: ${lastName}`,
                    `   - Email: ${email}`,
                    `   - Phone: ${phone}`,
                    `   - Company: ${company}`,
                    '2. Click the "Create Account" button',
                    '3. Watch the browser console for debug messages',
                    '4. Check if the accounts page opens with filled data'
                ],
                testData: {
                    billingFirstName: firstName,
                    billingLastName: lastName,
                    billingEmail: email,
                    billingPhone: phone,
                    billingCompany: company
                }
            };
            
            localStorage.setItem('relia_test_instructions', JSON.stringify(testInstructions));
            log('ğŸ“‹ Test instructions stored for manual testing');
            log('Instructions:');
            testInstructions.steps.forEach(step => log(step));
            
            // Navigate to reservation form
            setTimeout(() => {
                window.location.href = 'reservation-form.html?test=manual';
            }, 3000);
        }

        // Clear log button
        document.addEventListener('DOMContentLoaded', () => {
            const logOutput = document.getElementById('logOutput');
            logOutput.addEventListener('dblclick', () => {
                clearLog();
            });
            
            log('ğŸ”§ Account Creation Utilities loaded');
            log('ğŸ’¡ Double-click this log area to clear it');
        });
    </script>
</body>
</html>