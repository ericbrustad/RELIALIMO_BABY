<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Settings - RELIAüêÇLIMO‚Ñ¢</title>
  <script src="env.js"></script>
  <link rel="stylesheet" href="email-settings.css" />
  <style>
    .config-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-right: 10px;
    }
    .config-status.configured {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
    .config-status.not-configured {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    .config-status.partial {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffcc80;
    }
    .config-status .status-icon { font-size: 16px; }
    
    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 9999;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .toast.success {
      background: #2e7d32;
      color: white;
    }
    .toast.error {
      background: #c62828;
      color: white;
    }
    .toast.warning {
      background: #e65100;
      color: white;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <script>
    if (window.self !== window.top) {
      document.documentElement.classList.add('embedded');
      document.body.classList.add('embedded');
    }
  </script>
  <div class="email-settings-container">
    <aside class="settings-sidebar">
      <nav class="settings-nav">
        <a href="#" class="settings-nav-item">Contact Information</a>
        <a href="#" class="settings-nav-item">Company Preferences</a>
        <a href="#" class="settings-nav-item">System Users</a>
        <a href="#" class="settings-nav-item">Policies</a>
        <a href="#" class="settings-nav-item">ReadBack Script Templates</a>
        <a href="#" class="settings-nav-item">Messaging & Template Settings</a>
        <a href="#" class="settings-nav-item">Calendar Settings</a>
        <a href="#" class="settings-nav-item">Online Reservations</a>
        <a href="#" class="settings-nav-item">Payment Gateway</a>
        <a href="#" class="settings-nav-item">Third-party Plug-ins</a>
        <div class="settings-nav-section">
          <div class="settings-nav-item active-section">System Settings</div>
          <a href="service-types.html" class="settings-nav-subitem">Service Types</a>
          <a href="system-mapping.html" class="settings-nav-subitem">System Mapping</a>
          <a href="portal-settings.html" class="settings-nav-subitem">Portal Settings</a>
          <a href="magic-link.html" class="settings-nav-subitem">Magic Link</a>
          <a href="sms-provider.html" class="settings-nav-subitem">Sms Provider</a>
          <a href="email-settings.html" class="settings-nav-subitem active">Email Settings</a>
          <a href="full-site-test-checklist.html" class="settings-nav-subitem">Test Checklist</a>
          <a href="test-supabase-integration.html" class="settings-nav-subitem">Supabase Integration Test</a>
          <a href="#" class="settings-nav-subitem">Digital Marketing</a>
        </div>
      </nav>
    </aside>

    <main class="email-settings-main">
      <header class="email-settings-header">
        <div>
          <h1 class="email-settings-title">Email Settings</h1>
          <p class="email-settings-subtitle">Configure outgoing email and manage HTML templates with trip and rate tags.</p>
        </div>
        <div class="header-actions">
          <div id="emailConfigStatus" class="config-status">
            <span class="status-icon">‚è≥</span>
            <span class="status-text">Checking...</span>
          </div>
          <button id="loadFromEnvBtn" class="btn primary" style="background: linear-gradient(135deg, #00897b, #004d40); font-weight: bold;" title="Load email settings from Vercel environment variables">üì• Load from ENV</button>
          <button id="quickSetupBothBtn" class="btn primary" style="background: linear-gradient(135deg, #9c27b0, #673ab7); font-weight: bold;" title="Quick setup both SMS and Email with demo values">üîß Quick Setup SMS + Email</button>
          <button id="saveSettingsBtn" class="btn primary">üíæ Save Settings</button>
          <button id="saveSecureBtn" class="btn primary" style="background:#2e7d32;" title="Save to Supabase & create backup">üîí Save Secure</button>
          <button id="downloadEnvBtn" class="btn primary" style="background:#1565c0;" title="Download .env file">‚¨áÔ∏è Download .env</button>
          <button id="testSendBtn" class="btn secondary">üìß Test Email API</button>
        </div>
      </header>

      <section class="card">
        <div class="card-header">
          <h2>Email Test</h2>
        </div>
        <div class="card-body">
          <label class="form-row">Test Email Address
            <input id="testEmailInput" type="email" placeholder="test@example.com" />
          </label>
          <div class="hint">Uses /api/email-send endpoint with server environment variables for security.</div>
          <div class="hint" style="color: #2e7d32; margin-top: 8px;">
            <strong>Vercel Setup:</strong> 1) Add RESEND_API_KEY & EMAIL_FROM to environment variables 2) Redeploy
          </div>
          <div class="hint" style="color: #f57c00; margin-top: 4px; font-size: 12px;">
            Local: Run <code>npm start</code> for local development server.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Outgoing Email (SMTP / Provider)</h2>
        </div>
        <div class="card-body grid-2">
          <label class="form-row">From Name
            <input id="fromNameInput" type="text" placeholder="Dispatch Team" />
          </label>
          <label class="form-row">From Email
            <input id="fromEmailInput" type="email" placeholder="dispatch@example.com" />
          </label>
          <label class="form-row">Reply-To
            <input id="replyToInput" type="email" placeholder="support@example.com" />
          </label>
          <label class="form-row">SMTP Host / API Endpoint
            <input id="smtpHostInput" type="text" placeholder="smtp.sendgrid.net" />
          </label>
          <label class="form-row">Port
            <input id="smtpPortInput" type="number" placeholder="587" />
          </label>
          <label class="form-row">Username
            <input id="smtpUserInput" type="text" placeholder="apikey or username" />
          </label>
          <label class="form-row">Password / Token
            <input id="smtpPassInput" type="password" placeholder="password or token" />
          </label>
          <label class="form-row checkbox-row">
            <input id="tlsInput" type="checkbox" /> Use TLS/STARTTLS
          </label>
        </div>
        <div class="card-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
          <button id="testEmailFormBtn" class="btn secondary" style="display: flex; align-items: center; gap: 6px;">
            üìß Send Test Email
          </button>
          <button id="saveEmailFormBtn" class="btn primary" style="display: flex; align-items: center; gap: 6px;">
            üíæ Save Email Settings
          </button>
        </div>
        <div class="hint">Saved locally only. Wire to your email provider backend to send for real.</div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Template Editor</h2>
          <div class="card-actions">
            <input id="templateNameInput" type="text" placeholder="Template name (e.g., Trip Confirmation)" />
            <button id="saveTemplateBtn" class="btn primary">Save Template</button>
          </div>
        </div>
        <div class="card-body">
          <label class="form-row">Subject
            <input id="subjectInput" type="text" placeholder="Your trip on #TRIP_DATE#" />
          </label>

          <!-- Send Rules Section -->
          <div id="sendRulesSection" class="send-rules-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; padding: 20px; margin: 20px 0; border: 1px solid #90caf9;">
            <h3 style="margin: 0 0 15px 0; color: #1565c0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
              <span>‚öôÔ∏è</span> Send Rules
              <span style="font-size: 12px; font-weight: normal; color: #666;">(When should this template be sent?)</span>
            </h3>
            
            <div style="display: grid; gap: 12px;">
              <!-- Trigger Events -->
              <div style="background: #fff; border-radius: 8px; padding: 15px;">
                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">üìå Trigger Events</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleNewAccount" class="send-rule-checkbox" value="new_account">
                    <span style="font-size: 13px;">üÜï New Account Created</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleNewReservation" class="send-rule-checkbox" value="new_reservation">
                    <span style="font-size: 13px;">üìÖ New Reservation Saved</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleReservationUpdated" class="send-rule-checkbox" value="reservation_updated">
                    <span style="font-size: 13px;">‚úèÔ∏è Reservation Updated</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleDriverAssigned" class="send-rule-checkbox" value="driver_assigned">
                    <span style="font-size: 13px;">üöó Driver Assigned</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleTripReminder" class="send-rule-checkbox" value="trip_reminder">
                    <span style="font-size: 13px;">‚è∞ Trip Reminder</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleTripComplete" class="send-rule-checkbox" value="trip_complete">
                    <span style="font-size: 13px;">‚úÖ Trip Completed</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="rulePaymentReceived" class="send-rule-checkbox" value="payment_received">
                    <span style="font-size: 13px;">üí≥ Payment Received</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="ruleManualSend" class="send-rule-checkbox" value="manual" checked>
                    <span style="font-size: 13px;">üëÜ Manual Send Only</span>
                  </label>
                </div>
              </div>
              
              <!-- Recipient Options -->
              <div style="background: #fff; border-radius: 8px; padding: 15px;">
                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">üìß Send To</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="recipientBilling" class="recipient-checkbox" value="billing" checked>
                    <span style="font-size: 13px;">üíº Billing Contact</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="recipientPassenger" class="recipient-checkbox" value="passenger">
                    <span style="font-size: 13px;">üß≥ Passenger</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="recipientDriver" class="recipient-checkbox" value="driver">
                    <span style="font-size: 13px;">üöó Driver</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #f5f5f5;">
                    <input type="checkbox" id="recipientBooking" class="recipient-checkbox" value="booking">
                    <span style="font-size: 13px;">üìã Booking Contact</span>
                  </label>
                </div>
              </div>
              
              <!-- Channel Options -->
              <div style="background: #fff; border-radius: 8px; padding: 15px;">
                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">üì± Send Via</label>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 15px; border-radius: 6px; background: #e8f5e9; border: 2px solid #4caf50;">
                    <input type="checkbox" id="channelEmail" class="channel-checkbox" value="email" checked>
                    <span style="font-size: 13px; font-weight: 600; color: #2e7d32;">üìß Email</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 15px; border-radius: 6px; background: #e3f2fd; border: 2px solid #1976d2;">
                    <input type="checkbox" id="channelSms" class="channel-checkbox" value="sms">
                    <span style="font-size: 13px; font-weight: 600; color: #1565c0;">üì± SMS/Text</span>
                  </label>
                </div>
              </div>
              
              <!-- Timing Options -->
              <div style="background: #fff; border-radius: 8px; padding: 15px;">
                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">‚è±Ô∏è Timing (for reminders)</label>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                  <select id="reminderTiming" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="immediate">Immediately</option>
                    <option value="1hour">1 hour before</option>
                    <option value="2hours">2 hours before</option>
                    <option value="1day" selected>1 day before</option>
                    <option value="2days">2 days before</option>
                    <option value="1week">1 week before</option>
                  </select>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ruleEnabled" checked>
                    <span style="font-size: 13px; font-weight: 600; color: #333;">‚úÖ Rule Enabled</span>
                  </label>
                </div>
              </div>
              
              <!-- Conditions -->
              <div style="background: #fff; border-radius: 8px; padding: 15px;">
                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">üéØ Conditions (optional)</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #fff3e0;">
                    <input type="checkbox" id="conditionIncludePrice" class="condition-checkbox" value="include_price">
                    <span style="font-size: 13px;">üí∞ Include Price (billing only)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #fce4ec;">
                    <input type="checkbox" id="conditionExcludePrice" class="condition-checkbox" value="exclude_price">
                    <span style="font-size: 13px;">üö´ Exclude Price (passengers)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; background: #e8eaf6;">
                    <input type="checkbox" id="conditionDifferentEmail" class="condition-checkbox" value="different_email">
                    <span style="font-size: 13px;">üì® Only if passenger email differs</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <!-- End Send Rules Section -->

          <div class="editor-toolbar">
            <div class="toolbar-left">
              <button data-cmd="bold" class="tool-btn">B</button>
              <button data-cmd="italic" class="tool-btn">I</button>
              <button data-cmd="underline" class="tool-btn">U</button>
              <button data-cmd="insertUnorderedList" class="tool-btn">‚Ä¢ List</button>
              <button data-cmd="insertOrderedList" class="tool-btn">1. List</button>
              <span style="width: 1px; height: 20px; background: #ddd; margin: 0 8px;"></span>
              <button type="button" id="insertImageBtn" class="tool-btn" title="Insert Image">üñºÔ∏è</button>
              <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
            </div>
            <div class="toolbar-right">
              <select id="tripTagSelect">
                <option value="">Insert Trip Tag‚Ä¶</option>
              </select>
              <select id="rateTagSelect">
                <option value="">Insert Rate Tag‚Ä¶</option>
              </select>
            </div>
          </div>
          
          <!-- Image Upload Modal -->
          <div id="imageUploadModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: #fff; border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1a237e; font-size: 18px;">üñºÔ∏è Insert Image</h3>
                <button type="button" id="closeImageModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
              </div>
              
              <!-- Tab Navigation -->
              <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button type="button" id="tabUpload" class="image-modal-tab active" style="padding: 12px 24px; background: #1a237e; color: white; border: none; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">üì§ Upload New</button>
                <button type="button" id="tabBrowse" class="image-modal-tab" style="padding: 12px 24px; background: #e0e0e0; color: #333; border: none; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">üìÅ Browse Bucket</button>
              </div>
              
              <!-- Upload Tab -->
              <div id="uploadTab" style="margin-bottom: 20px;">
                <div id="imageDropZone" style="border: 2px dashed #1a237e; border-radius: 8px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                  <p style="margin: 0 0 10px 0; color: #333; font-weight: 600;">Drop image here or click to upload</p>
                  <p style="margin: 0; color: #666; font-size: 13px;">PNG, JPG, GIF up to 5MB</p>
                </div>
                <div id="uploadProgress" style="display: none; margin-top: 15px;">
                  <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="uploadProgressBar" style="background: linear-gradient(90deg, #1a237e, #0d47a1); height: 100%; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <p id="uploadStatusText" style="margin: 10px 0 0 0; text-align: center; font-size: 13px; color: #666;">Uploading...</p>
                </div>
              </div>
              
              <!-- Browse Bucket Tab -->
              <div id="browseTab" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                  <button type="button" id="refreshBucketBtn" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    üîÑ Refresh
                  </button>
                  <span id="bucketImageCount" style="font-size: 13px; color: #666;"></span>
                </div>
                <div id="bucketImageGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; max-height: 350px; overflow-y: auto; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                  <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 36px; margin-bottom: 10px;">üìÅ</div>
                    <p style="margin: 0;">Click "Refresh" to load images from your bucket</p>
                  </div>
                </div>
              </div>
              
              <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 10px;">
                <p style="margin: 0 0 10px 0; font-size: 13px; color: #666;">Or enter image URL:</p>
                <div style="display: flex; gap: 10px;">
                  <input type="text" id="imageUrlInput" placeholder="https://example.com/image.png" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  <button type="button" id="insertUrlImageBtn" style="padding: 10px 20px; background: #1a237e; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Insert</button>
                </div>
              </div>
              
              <!-- Image Size Options -->
              <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #333; font-weight: 600;">Image Width:</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="radio" name="imageWidth" value="100" checked> 100px
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="radio" name="imageWidth" value="200"> 200px
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="radio" name="imageWidth" value="300"> 300px
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="radio" name="imageWidth" value="100%"> Full Width
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="radio" name="imageWidth" value="auto"> Auto
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div id="templateEditor" class="editor" contenteditable="true">
            <p>Hello #TRIP_PAX_NAME#,</p>
            <p>Your trip #TRIP_CONFNUM# on #TRIP_DATE# at #TRIP_TIME# is confirmed.</p>
            <p>Pickup: #TRIP_PICKUP#<br/>Dropoff: #TRIP_DROPOFF#</p>
            <p>Total: #TRIP_RATES_TOTAL#</p>
            <p>Thank you!</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Saved Templates (local)</h2>
        </div>
        <div class="card-body" id="templateList"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Tag Reference</h2>
        </div>
        <div class="card-body tag-reference">
          <div>
            <h3>Trip Tags</h3>
            <ul id="tripTagList"></ul>
          </div>
          <div>
            <h3>Rate Tags</h3>
            <ul id="rateTagList"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="email-settings.js"></script>
  <script src="SecureSettingsManager.js"></script>
  <script>
    // Toast notification helper
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Direct Email Settings Save/Test (secure API approach)
    const EmailSettingsDirect = {
      STORAGE_KEY: 'emailSettings',
      
      // Test email via API (secure - uses server env vars)
      async testEmailAPI() {
        const testEmail = document.getElementById('testEmailInput')?.value?.trim();
        if (!testEmail) {
          showToast('‚ùå Enter a test email address', 'error');
          return;
        }
        
        if (!testEmail.includes('@')) {
          showToast('‚ùå Enter a valid email address', 'error');
          return;
        }
        
        const testBtn = document.getElementById('testSendBtn');
        const originalText = testBtn.textContent;
        testBtn.disabled = true;
        testBtn.textContent = 'üîÑ Sending...';
        
        try {
          // Try same-origin first; if running the UI from a different port (e.g. 8000/file://),
          // fall back to common local backend ports.
          const candidateBases = [
            window.location.origin,
            'http://localhost:3001',
            'http://localhost:3002',
            'http://127.0.0.1:3001',
            'http://127.0.0.1:3002'
          ].filter((v, i, a) => a.indexOf(v) === i);

          let response = null;
          let lastErr = null;

          for (const base of candidateBases) {
            try {
              response = await fetch(base + '/api/email-send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: testEmail,
              subject: 'ReliaLimo Email Test',
              html: `
                <h2>Email Test Successful!</h2>
                <p>If you received this email, your ReliaLimo email configuration is working correctly.</p>
                <p><strong>Sent at:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>From:</strong> ReliaLimo Email System</p>
                <hr>
                <p style="font-size: 12px; color: #666;">This is an automated test email.</p>
              `,
              text: 'ReliaLimo Email Test - If you got this, email sending works! Sent at: ' + new Date().toLocaleString()
            })
          });
            break; // got a response
          } catch (e) {
            lastErr = e;
            response = null;
          }
        }

        if (!response) {
          throw lastErr || new Error('API endpoint not available');
        }

          
          // Check if response is HTML (404 page) instead of JSON
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('text/html')) {
            throw new Error('API endpoint not available - configure email backend server');
          }
          
          const data = await response.json();
          
          if (response.ok && (data.ok || data.success)) {
            showToast(`‚úÖ Test email sent to ${testEmail}!`, 'success');
            console.log('Email sent successfully:', data);
            // Hide any error displays on success
            const errorDisplays = document.querySelectorAll('.error-display, .test-error');
            errorDisplays.forEach(el => el.style.display = 'none');
          } else {
            console.error('Email API error:', data);
            showToast(`‚ùå Email failed: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          console.error('Email test error:', error);
          
          // Handle specific error types
          if (error.message.includes('JSON')) {
            showToast('‚ùå API endpoint returned HTML - configure backend server', 'error');
          } else if (error.message.includes('fetch')) {
            showToast('‚ùå Network error - check API endpoint configuration', 'error');
          } else if (error.message.includes('API endpoint not available')) {
            showToast('‚ùå Email API not configured - deploy backend or use SMTP directly', 'error');
          } else {
            showToast(`‚ùå Error: ${error.message}`, 'error');
          }
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = originalText;
        }
      },
      
      // Save settings securely (localStorage only - sensitive data via env vars)
      saveEmailSettings() {
        const $ = id => document.getElementById(id)?.value?.trim() || '';
        
        const settings = {
          fromName: $('fromNameInput'),
          fromEmail: $('fromEmailInput'),
          replyTo: $('replyToInput'),
          smtpHost: $('smtpHostInput'),
          smtpPort: parseInt($('smtpPortInput')) || 0,
          smtpUser: $('smtpUserInput'),
          smtpPass: $('smtpPassInput'), // Note: This should be managed via env vars in production
          tls: document.getElementById('tlsInput')?.checked ?? true
        };
        
        // Basic validation
        if (!settings.fromEmail || !settings.fromEmail.includes('@')) {
          showToast('‚ùå Valid From Email is required', 'error');
          return false;
        }
        
        if (!settings.smtpHost) {
          showToast('‚ùå SMTP Host is required', 'error');
          return false;
        }
        
        if (settings.smtpPort <= 0) {
          showToast('‚ùå Valid SMTP Port is required', 'error');
          return false;
        }
        
        // Save to localStorage
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
        
        // Also save in legacy format for compatibility
        localStorage.setItem('emailSettingsConfig', JSON.stringify(settings));
        
        console.log('[Email] Settings saved:', { ...settings, smtpPass: '***' });
        
        // Also sync to Supabase if available
        if (window.SystemSettingsSync) {
          window.SystemSettingsSync.saveEmailSettings(settings).then(() => {
            console.log('[Email] Settings synced to Supabase');
          }).catch(e => console.warn('[Email] Supabase sync failed:', e));
          window.SystemSettingsSync.saveEmailConfig(settings).catch(() => {});
        }
        
        // Trigger storage event
        window.dispatchEvent(new StorageEvent('storage', {
          key: this.STORAGE_KEY,
          newValue: JSON.stringify(settings)
        }));
        
        return true;
      },
      
      init() {
        console.log('[Email] Initializing EmailSettingsDirect...');
        
        // Wire up Test Email button
        const testBtn = document.getElementById('testSendBtn');
        if (testBtn) {
          testBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.testEmailAPI();
          });
        }
        
        // Wire up form Test Email button (duplicate functionality)
        const testFormBtn = document.getElementById('testEmailFormBtn');
        if (testFormBtn) {
          testFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.testEmailAPI();
          });
        }
        
        // Override the save settings button
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          // Remove existing event listeners by cloning the node
          const newSaveBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
          
          newSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.saveEmailSettings()) {
              showToast('‚úÖ Email settings saved!', 'success');
              // Re-check configuration status
              if (typeof EmailConfigChecker !== 'undefined') {
                EmailConfigChecker.checkConfiguration();
              }
            }
          });
        }
        
        // Wire up form Save Email Settings button (duplicate functionality)
        const saveFormBtn = document.getElementById('saveEmailFormBtn');
        if (saveFormBtn) {
          saveFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.saveEmailSettings()) {
              showToast('‚úÖ Email settings saved!', 'success');
              // Re-check configuration status
              if (typeof EmailConfigChecker !== 'undefined') {
                EmailConfigChecker.checkConfiguration();
              }
            }
          });
        }
        
        console.log('[Email] EmailSettingsDirect initialized');
      }
    };
    
    // Email Config Status Checker
    const EmailConfigChecker = {
      checkConfiguration() {
        const statusEl = document.getElementById('emailConfigStatus');
        if (!statusEl) return;
        
        const smtpHost = document.getElementById('smtpHostInput')?.value?.trim() || '';
        const smtpPort = document.getElementById('smtpPortInput')?.value?.trim() || '';
        const fromEmail = document.getElementById('fromEmailInput')?.value?.trim() || '';
        
        const checks = [
          { name: 'SMTP Host', valid: smtpHost.length > 3 },
          { name: 'SMTP Port', valid: parseInt(smtpPort) > 0 },
          { name: 'From Email', valid: fromEmail.includes('@') }
        ];
        
        const validCount = checks.filter(c => c.valid).length;
        const allValid = validCount === 3;
        const partialValid = validCount > 0 && validCount < 3;
        
        if (allValid) {
          statusEl.className = 'config-status configured';
          statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Email Configured</span>';
        } else if (partialValid) {
          statusEl.className = 'config-status partial';
          statusEl.innerHTML = `<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">Partial (${validCount}/3)</span>`;
        } else {
          statusEl.className = 'config-status not-configured';
          statusEl.innerHTML = '<span class="status-icon">‚ùå</span><span class="status-text">Not Configured</span>';
        }
      },
      
      init() {
        setTimeout(() => this.checkConfiguration(), 100);
        
        const inputs = ['smtpHostInput', 'smtpPortInput', 'fromEmailInput'];
        inputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', () => this.checkConfiguration());
            el.addEventListener('change', () => this.checkConfiguration());
          }
        });
        
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            setTimeout(() => this.checkConfiguration(), 200);
          });
        }
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      EmailSettingsDirect.init();
      EmailConfigChecker.init();
      
      // Quick Setup Both SMS + Email button
      const quickSetupBtn = document.getElementById('quickSetupBothBtn');
      if (quickSetupBtn) {
        quickSetupBtn.addEventListener('click', () => {
          QuickSetupManager.showModal();
        });
      }
      
      // Save Secure button
      const saveSecureBtn = document.getElementById('saveSecureBtn');
      if (saveSecureBtn) {
        saveSecureBtn.addEventListener('click', async () => {
          saveSecureBtn.disabled = true;
          saveSecureBtn.textContent = 'üîÑ Saving...';
          
          try {
            // First save locally
            if (!EmailSettingsDirect.saveEmailSettings()) {
              saveSecureBtn.disabled = false;
              saveSecureBtn.textContent = 'üîí Save Secure';
              return;
            }
            
            await new Promise(r => setTimeout(r, 100));
            
            if (window.SecureSettingsManager) {
              const result = await window.SecureSettingsManager.saveSecurely();
              
              if (result.saved) {
                if (result.supabase) {
                  showToast('‚úÖ Saved to Supabase + local backup', 'success');
                } else {
                  showToast('‚úÖ Saved to local backup', 'success');
                }
              } else {
                showToast('‚ö†Ô∏è ' + (result.reason || 'Check configuration'), 'warning');
              }
            } else {
              showToast('‚úÖ Settings saved locally', 'success');
            }
          } catch (e) {
            console.error('Save secure error:', e);
            showToast('‚ùå Error: ' + e.message, 'error');
          } finally {
            saveSecureBtn.disabled = false;
            saveSecureBtn.textContent = 'üîí Save Secure';
            if (typeof EmailConfigChecker !== 'undefined') {
              EmailConfigChecker.checkConfiguration();
            }
          }
        });
      }
      
      // Download .env button
      const downloadEnvBtn = document.getElementById('downloadEnvBtn');
      if (downloadEnvBtn) {
        downloadEnvBtn.addEventListener('click', () => {
          if (window.SecureSettingsManager) {
            const status = window.SecureSettingsManager.getStatus();
            
            if (!status.sms.configured && !status.email.configured) {
              if (!confirm('No settings are fully configured yet. Download anyway?')) {
                return;
              }
            }
            
            window.SecureSettingsManager.downloadEnvFile();
            showToast('üì• .env file downloaded', 'success');
          } else {
            showToast('‚ùå SecureSettingsManager not loaded', 'error');
          }
        });
      }
    });
    
    // ============================================
    // Quick Setup Manager - Configure Both SMS & Email
    // ============================================
    const QuickSetupManager = {
      showModal() {
        // Remove existing modal
        const existing = document.getElementById('quickSetupModal');
        if (existing) existing.remove();
        
        const modal = document.createElement('div');
        modal.id = 'quickSetupModal';
        modal.innerHTML = `
          <div class="quick-setup-overlay" onclick="QuickSetupManager.close()"></div>
          <div class="quick-setup-dialog">
            <h2 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 28px;">üîß</span> Quick Setup - SMS & Email
            </h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
              Configure both SMS (Twilio) and Email (SMTP) with your credentials. Leave fields blank to skip that service.
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- SMS Section -->
              <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; border: 2px solid #1976d2;">
                <h3 style="margin: 0 0 12px 0; color: #1565c0; font-size: 15px;">üì± SMS (Twilio)</h3>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  Account SID
                  <input id="qs_accountSid" type="text" placeholder="ACxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  Auth Token
                  <input id="qs_authToken" type="password" placeholder="Your auth token" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  From Number / Messaging Service SID
                  <input id="qs_fromNumber" type="text" placeholder="+15551234567 or MGxxxxxxxx" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
              </div>
              
              <!-- Email Section -->
              <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border: 2px solid #4caf50;">
                <h3 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 15px;">üìß Email (SMTP)</h3>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  SMTP Host
                  <input id="qs_smtpHost" type="text" placeholder="smtp.gmail.com or smtp.sendgrid.net" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  SMTP Port
                  <input id="qs_smtpPort" type="number" placeholder="587" value="587" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  From Email
                  <input id="qs_fromEmail" type="email" placeholder="noreply@yourdomain.com" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; margin-bottom: 10px; font-size: 13px;">
                  Username / API Key
                  <input id="qs_smtpUser" type="text" placeholder="apikey or your@email.com" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
                <label style="display: block; font-size: 13px;">
                  Password / Token
                  <input id="qs_smtpPass" type="password" placeholder="App password or API key" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;">
                </label>
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="QuickSetupManager.close()" style="padding: 10px 20px; background: #9e9e9e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
              <button onclick="QuickSetupManager.applySettings()" style="padding: 10px 24px; background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">‚úÖ Apply Both Settings</button>
            </div>
          </div>
        `;
        
        // Add styles
        const style = document.createElement('style');
        style.textContent = `
          .quick-setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
          }
          .quick-setup-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 9999;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
          }
        `;
        modal.appendChild(style);
        document.body.appendChild(modal);
        
        // Pre-fill from existing settings
        this.prefillFromExisting();
      },
      
      prefillFromExisting() {
        // SMS
        const smsRaw = localStorage.getItem('smsProviders');
        if (smsRaw) {
          try {
            const providers = JSON.parse(smsRaw);
            const sms = providers.find(p => p.isDefault) || providers[0];
            if (sms) {
              document.getElementById('qs_accountSid').value = sms.accountSid || '';
              document.getElementById('qs_authToken').value = sms.authToken || '';
              document.getElementById('qs_fromNumber').value = sms.messagingServiceSid || sms.fromNumber || '';
            }
          } catch (e) {}
        }
        
        // Email
        const emailRaw = localStorage.getItem('emailSettings');
        if (emailRaw) {
          try {
            const email = JSON.parse(emailRaw);
            document.getElementById('qs_smtpHost').value = email.smtpHost || '';
            document.getElementById('qs_smtpPort').value = email.smtpPort || 587;
            document.getElementById('qs_fromEmail').value = email.fromEmail || '';
            document.getElementById('qs_smtpUser').value = email.smtpUser || '';
            document.getElementById('qs_smtpPass').value = email.smtpPass || '';
          } catch (e) {}
        }
      },
      
      applySettings() {
        const $ = id => document.getElementById(id)?.value?.trim() || '';
        
        let smsConfigured = false;
        let emailConfigured = false;
        
        // Save SMS settings
        const accountSid = $('qs_accountSid');
        const authToken = $('qs_authToken');
        const fromNumber = $('qs_fromNumber');
        
        if (accountSid && authToken) {
          const smsProvider = {
            id: 'twilio',
            name: 'Twilio',
            type: 'twilio',
            accountSid: accountSid,
            authToken: authToken,
            apiKeySid: '',
            apiKeySecret: '',
            messagingServiceSid: fromNumber.startsWith('MG') ? fromNumber : '',
            fromNumber: fromNumber.startsWith('+') ? fromNumber : '',
            statusCallbackUrl: '',
            requestDeliveryReceipts: true,
            useApiKey: false,
            isDefault: true
          };
          localStorage.setItem('smsProviders', JSON.stringify([smsProvider]));
          smsConfigured = true;
          console.log('[QuickSetup] SMS settings saved');
          
          // Update form if on SMS page
          if (document.getElementById('twilioAccountSid')) {
            document.getElementById('twilioAccountSid').value = accountSid;
            document.getElementById('twilioAuthToken').value = authToken;
            if (fromNumber.startsWith('MG')) {
              document.getElementById('twilioMessagingServiceSid').value = fromNumber;
            } else {
              document.getElementById('twilioFromNumber').value = fromNumber;
            }
          }
        }
        
        // Save Email settings
        const smtpHost = $('qs_smtpHost');
        const smtpPort = parseInt($('qs_smtpPort')) || 587;
        const fromEmail = $('qs_fromEmail');
        const smtpUser = $('qs_smtpUser');
        const smtpPass = $('qs_smtpPass');
        
        if (smtpHost && fromEmail) {
          const emailSettings = {
            smtpHost: smtpHost,
            smtpPort: smtpPort,
            fromEmail: fromEmail,
            fromName: 'ReliaLimo',
            replyTo: fromEmail,
            smtpUser: smtpUser,
            smtpPass: smtpPass,
            tls: true
          };
          localStorage.setItem('emailSettings', JSON.stringify(emailSettings));
          localStorage.setItem('emailSettingsConfig', JSON.stringify(emailSettings));
          emailConfigured = true;
          console.log('[QuickSetup] Email settings saved');
          
          // Update form if on Email page
          if (document.getElementById('smtpHostInput')) {
            document.getElementById('smtpHostInput').value = smtpHost;
            document.getElementById('smtpPortInput').value = smtpPort;
            document.getElementById('fromEmailInput').value = fromEmail;
            document.getElementById('smtpUserInput').value = smtpUser;
            document.getElementById('smtpPassInput').value = smtpPass;
          }
        }
        
        // Close modal
        this.close();
        
        // Show result
        if (smsConfigured && emailConfigured) {
          showToast('‚úÖ Both SMS and Email configured!', 'success');
        } else if (smsConfigured) {
          showToast('‚úÖ SMS configured! (Email skipped)', 'success');
        } else if (emailConfigured) {
          showToast('‚úÖ Email configured! (SMS skipped)', 'success');
        } else {
          showToast('‚ö†Ô∏è No settings were saved - fill in required fields', 'warning');
        }
        
        // Refresh status indicators
        if (typeof SMSConfigChecker !== 'undefined') {
          setTimeout(() => SMSConfigChecker.checkConfiguration(), 100);
        }
        if (typeof EmailConfigChecker !== 'undefined') {
          setTimeout(() => EmailConfigChecker.checkConfiguration(), 100);
        }
        
        // Trigger storage event for other tabs
        window.dispatchEvent(new StorageEvent('storage', { key: 'smsProviders' }));
        window.dispatchEvent(new StorageEvent('storage', { key: 'emailSettings' }));
      },
      
      close() {
        const modal = document.getElementById('quickSetupModal');
        if (modal) modal.remove();
      }
    };
    
    // Make it globally accessible
    window.QuickSetupManager = QuickSetupManager;
    
    // ============================================
    // Load from ENV button handler
    // ============================================
    document.getElementById('loadFromEnvBtn')?.addEventListener('click', async function() {
      const btn = this;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Loading...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/get-env-settings');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to load settings');
        }
        
        if (!data.success) {
          throw new Error('Invalid response from server');
        }
        
        const email = data.email;
        
        // Check if any email settings are configured
        if (!email.resendApiKey && !email.smtpHost) {
          showToast('‚ö†Ô∏è No email settings found in environment variables', 'warning');
          return;
        }
        
        // Populate form fields
        if (email.fromEmail) {
          // Parse fromEmail if it contains name and email like "Name <email@example.com>"
          const match = email.fromEmail.match(/^(.+?)\s*<(.+)>$/);
          if (match) {
            document.getElementById('fromNameInput').value = match[1].trim();
            document.getElementById('fromEmailInput').value = match[2].trim();
          } else {
            document.getElementById('fromEmailInput').value = email.fromEmail;
          }
        }
        if (email.fromName && !document.getElementById('fromNameInput').value) {
          document.getElementById('fromNameInput').value = email.fromName;
        }
        if (email.replyTo) document.getElementById('replyToInput').value = email.replyTo;
        
        // If using Resend, set it as the SMTP provider
        if (email.resendApiKey) {
          document.getElementById('smtpHostInput').value = 'resend';
          document.getElementById('smtpPortInput').value = '443';
          document.getElementById('smtpUserInput').value = 'resend';
          document.getElementById('smtpPassInput').value = email.resendApiKey;
          document.getElementById('tlsInput').checked = true;
        } else if (email.smtpHost) {
          document.getElementById('smtpHostInput').value = email.smtpHost;
          document.getElementById('smtpPortInput').value = email.smtpPort || '587';
          document.getElementById('smtpUserInput').value = email.smtpUser || '';
          document.getElementById('smtpPassInput').value = email.smtpPass || '';
        }
        
        showToast('‚úÖ Loaded email settings from environment!', 'success');
        
        // Update config status
        if (typeof EmailConfigChecker !== 'undefined') {
          setTimeout(() => EmailConfigChecker.checkConfiguration(), 100);
        }
        
      } catch (err) {
        console.error('Load from ENV error:', err);
        showToast('‚ùå ' + (err.message || 'Failed to load from ENV'), 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
