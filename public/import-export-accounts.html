<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import/Export Accounts</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="./env.js"></script>
  <style>
    .frozen-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: linear-gradient(135deg, #8B0000 0%, #a01515 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .frozen-header .logo {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .frozen-header .logo img {
      height: 24px;
    }
    .frozen-header .back-btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .frozen-header .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 70px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .section {
      background: white;
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1976d2;
      margin-top: 0;
      border-bottom: 2px solid #1976d2;
      padding-bottom: 10px;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    .btn-primary:hover {
      background: #1565c0;
    }
    .btn-success {
      background: #2e7d32;
      color: white;
    }
    .btn-success:hover {
      background: #1b5e20;
    }
    .btn-warning {
      background: #f57c00;
      color: white;
    }
    .btn-warning:hover {
      background: #e65100;
    }
    .file-input-wrapper {
      margin: 20px 0;
    }
    .file-input-wrapper input[type="file"] {
      padding: 10px;
      border: 2px dashed #ccc;
      border-radius: 4px;
      width: 100%;
      max-width: 400px;
    }
    .status {
      padding: 12px 16px;
      border-radius: 4px;
      margin-top: 16px;
      display: none;
    }
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
      display: block;
    }
    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
      display: block;
    }
    .status.info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
      display: block;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 13px;
    }
    .preview-table th, .preview-table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    .preview-table th {
      background: #f5f5f5;
      font-weight: 600;
    }
    .preview-table tr:nth-child(even) {
      background: #fafafa;
    }
    .template-info {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .template-info h4 {
      margin: 0 0 10px 0;
      color: #e65100;
    }
    .template-info code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header class="frozen-header">
    <div class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="bull">LIMO‚Ñ¢</div>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back to App</button>
  </header>

  <h1>üìä Import/Export Accounts</h1>

  <!-- Export Section -->
  <div class="section">
    <h2>üì§ Export Accounts</h2>
    <p>Export all accounts from the system to an Excel (.xls) file.</p>
    <button class="btn btn-primary" id="exportBtn">Export Accounts to XLS</button>
    <div id="exportStatus" class="status"></div>
  </div>

  <!-- Template Section -->
  <div class="section">
    <h2>üìã Download Template</h2>
    <div class="template-info">
      <h4>Supported Import Formats:</h4>
      <p style="margin-bottom:12px;"><strong>‚úÖ Legacy Format (auto-mapped):</strong></p>
      <p style="line-height:1.8; font-size:12px;">
        <code>First_Name</code>, 
        <code>Last_Name</code>, 
        <code>Company</code>, 
        <code>Address</code>, 
        <code>AptSte</code>, 
        <code>City</code>, 
        <code>State</code>, 
        <code>Zip</code>, 
        <code>PhoneW</code>, 
        <code>PhoneFax</code>, 
        <code>PhoneOth</code>, 
        <code>Email</code>, 
        <code>NotifyEmail</code>, 
        <code>NotifySMS</code>, 
        <code>AltFName</code>, 
        <code>AltLName</code>, 
        <code>Notes</code>, 
        <code>Status</code>
      </p>
      <p style="margin-top:12px;"><strong>‚úÖ Standard Format:</strong></p>
      <p style="line-height:1.8; font-size:12px;">
        <code>first_name</code>, 
        <code>last_name</code>, 
        <code>company_name</code>, 
        <code>email</code>, 
        <code>cell_phone</code>, 
        <code>office_phone</code>, 
        <code>address_line1</code>, 
        <code>city</code>, 
        <code>state</code>, 
        <code>zip</code>, 
        <code>status</code>
      </p>
      <p style="margin-top:12px; color:#666;"><em>Both formats are automatically detected and mapped.</em></p>
    </div>
    <button class="btn btn-warning" id="templateBtn">Download Blank Template</button>
    <div id="templateStatus" class="status"></div>
  </div>

  <!-- Import Section -->
  <div class="section">
    <h2>üì• Import Accounts</h2>
    <p>Import accounts from an Excel (.xls/.xlsx) file. Make sure the file matches the template format.</p>
    <div class="file-input-wrapper">
      <input type="file" id="importFile" accept=".xls,.xlsx" />
    </div>
    <button class="btn btn-success" id="importBtn" disabled>Import Accounts</button>
    <div id="importStatus" class="status"></div>
    <div id="previewSection" style="display:none;">
      <h3>Preview (first 10 rows):</h3>
      <table class="preview-table" id="previewTable"></table>
    </div>
  </div>

  <!-- Current Accounts Section -->
  <div class="section">
    <h2>üìã Current Accounts in System</h2>
    <button class="btn btn-primary" id="refreshBtn">Refresh List</button>
    <div id="currentAccountsSection">
      <table class="preview-table" id="currentAccountsTable"></table>
    </div>
  </div>

<script type="module">
import { getSupabaseClient, setupAPI } from './api-service.js';

let importData = null;
let supabaseClient = null;

// Initialize
async function init() {
  await setupAPI();
  supabaseClient = getSupabaseClient();
  loadCurrentAccounts();
}

// Load current accounts from Supabase
async function loadCurrentAccounts() {
  const table = document.getElementById('currentAccountsTable');
  
  if (!supabaseClient) {
    table.innerHTML = '<tr><td>Supabase not initialized</td></tr>';
    return;
  }

  const { data, error } = await supabaseClient
    .from('accounts')
    .select('*')
    .order('id', { ascending: true });

  if (error) {
    table.innerHTML = `<tr><td>Error loading accounts: ${error.message}</td></tr>`;
    return;
  }

  if (!data || data.length === 0) {
    table.innerHTML = '<tr><td>No accounts found</td></tr>';
    return;
  }

  let html = `
    <tr>
      <th>ID</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Company Name</th>
      <th>Cell Phone</th>
      <th>Office Phone</th>
      <th>Email</th>
      <th>City</th>
      <th>State</th>
      <th>Status</th>
      <th>Created</th>
    </tr>
  `;
  
  data.forEach(acc => {
    html += `
      <tr>
        <td>${acc.id}</td>
        <td>${acc.first_name || ''}</td>
        <td>${acc.last_name || ''}</td>
        <td>${acc.company_name || ''}</td>
        <td>${acc.cell_phone || ''}</td>
        <td>${acc.office_phone || ''}</td>
        <td>${acc.email || ''}</td>
        <td>${acc.city || ''}</td>
        <td>${acc.state || ''}</td>
        <td>${acc.status || 'active'}</td>
        <td>${acc.created_at ? new Date(acc.created_at).toLocaleDateString() : ''}</td>
      </tr>
    `;
  });

  table.innerHTML = html;
}

// Export accounts to XLS
async function exportAccounts() {
  const statusEl = document.getElementById('exportStatus');
  
  try {
    statusEl.className = 'status info';
    statusEl.textContent = 'Loading accounts...';

    const { data, error } = await supabaseClient
      .from('accounts')
      .select('*')
      .order('id', { ascending: true });

    if (error) throw error;

    if (!data || data.length === 0) {
      statusEl.className = 'status error';
      statusEl.textContent = 'No accounts to export';
      return;
    }

    // Transform data for export - ALL columns
    const exportData = data.map(acc => ({
      id: acc.id,
      first_name: acc.first_name || '',
      last_name: acc.last_name || '',
      company_name: acc.company_name || '',
      email: acc.email || '',
      cell_phone: acc.cell_phone || '',
      office_phone: acc.office_phone || '',
      office_phone_ext: acc.office_phone_ext || '',
      home_phone: acc.home_phone || '',
      home_phone_ext: acc.home_phone_ext || '',
      cell_phone_2: acc.cell_phone_2 || '',
      cell_phone_3: acc.cell_phone_3 || '',
      fax_1: acc.fax_1 || '',
      fax_2: acc.fax_2 || '',
      fax_3: acc.fax_3 || '',
      department: acc.department || '',
      job_title: acc.job_title || '',
      address_line1: acc.address_line1 || '',
      address_line2: acc.address_line2 || '',
      city: acc.city || '',
      state: acc.state || '',
      zip: acc.zip || '',
      country: acc.country || '',
      internal_notes: acc.internal_notes || '',
      trip_notes: acc.trip_notes || '',
      notes_others: acc.notes_others || '',
      source: acc.source || '',
      rental_agreement: acc.rental_agreement || '',
      account_settings: acc.account_settings || '',
      status: acc.status || 'active',
      web_access: acc.web_access || '',
      is_billing_client: acc.is_billing_client || false,
      is_passenger: acc.is_passenger || false,
      is_booking_contact: acc.is_booking_contact || false,
      created_at: acc.created_at || ''
    }));

    // Create workbook
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Accounts');

    // Download
    const filename = `accounts_export_${new Date().toISOString().split('T')[0]}.xls`;
    XLSX.writeFile(wb, filename);

    statusEl.className = 'status success';
    statusEl.textContent = `‚úì Exported ${data.length} accounts to ${filename}`;
  } catch (err) {
    statusEl.className = 'status error';
    statusEl.textContent = `Error: ${err.message}`;
  }
}

// Download blank template
function downloadTemplate() {
  const templateData = [
    { 
      first_name: 'John', 
      last_name: 'Doe', 
      company_name: 'ACME Corp', 
      email: 'john.doe@example.com',
      cell_phone: '(555) 123-4567',
      office_phone: '',
      office_phone_ext: '',
      home_phone: '',
      home_phone_ext: '',
      cell_phone_2: '',
      cell_phone_3: '',
      fax_1: '',
      fax_2: '',
      fax_3: '',
      department: 'Sales',
      job_title: 'Manager',
      address_line1: '123 Main St',
      address_line2: 'Suite 100',
      city: 'Los Angeles',
      state: 'CA',
      zip: '90001',
      country: 'US',
      internal_notes: '',
      trip_notes: '',
      notes_others: '',
      source: '',
      rental_agreement: '',
      account_settings: 'normal',
      status: 'active',
      web_access: 'allow',
      is_billing_client: true,
      is_passenger: false,
      is_booking_contact: false
    },
    { 
      first_name: 'Jane', 
      last_name: 'Smith', 
      company_name: '', 
      email: 'jane.smith@example.com',
      cell_phone: '(555) 987-6543',
      office_phone: '',
      office_phone_ext: '',
      home_phone: '',
      home_phone_ext: '',
      cell_phone_2: '',
      cell_phone_3: '',
      fax_1: '',
      fax_2: '',
      fax_3: '',
      department: '',
      job_title: '',
      address_line1: '',
      address_line2: '',
      city: '',
      state: '',
      zip: '',
      country: 'US',
      internal_notes: '',
      trip_notes: '',
      notes_others: '',
      source: '',
      rental_agreement: '',
      account_settings: 'normal',
      status: 'active',
      web_access: 'allow',
      is_billing_client: false,
      is_passenger: true,
      is_booking_contact: false
    }
  ];

  const ws = XLSX.utils.json_to_sheet(templateData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Accounts');

  XLSX.writeFile(wb, 'accounts_template.xls');

  const statusEl = document.getElementById('templateStatus');
  statusEl.className = 'status success';
  statusEl.textContent = '‚úì Template downloaded: accounts_template.xls';
}

// Convert Excel serial date to ISO string
function excelDateToISO(excelDate) {
  if (!excelDate) return null;
  
  // If it's already a valid date string, return it
  if (typeof excelDate === 'string' && excelDate.includes('-')) {
    return excelDate;
  }
  
  // If it's a number (Excel serial date), convert it
  if (typeof excelDate === 'number' || !isNaN(parseFloat(excelDate))) {
    const serial = parseFloat(excelDate);
    // Excel dates start from Jan 1, 1900 (serial 1)
    const utcDays = Math.floor(serial - 25569); // 25569 = days from 1900-01-01 to 1970-01-01
    const utcValue = utcDays * 86400 * 1000; // Convert to milliseconds
    const fractionalDay = serial - Math.floor(serial);
    const millisecondsInDay = fractionalDay * 86400 * 1000;
    const date = new Date(utcValue + millisecondsInDay);
    
    if (isNaN(date.getTime())) {
      return null;
    }
    return date.toISOString();
  }
  
  // Try to parse as date string
  const parsed = new Date(excelDate);
  if (!isNaN(parsed.getTime())) {
    return parsed.toISOString();
  }
  
  return null;
}

// Header mapping: Source column names ‚Üí Database column names
// Supports multiple source formats (e.g., legacy exports, standard template)
const HEADER_MAP = {
  // Primary contact
  'First_Name': 'first_name',
  'Last_Name': 'last_name',
  'first_name': 'first_name',
  'last_name': 'last_name',
  
  // Company
  'Company': 'company_name',
  'company': 'company_name',
  'company_name': 'company_name',
  
  // Address fields
  'Address': 'address_line1',
  'address_line1': 'address_line1',
  'AptSte': 'address_line2',
  'address_line2': 'address_line2',
  'City': 'city',
  'city': 'city',
  'State': 'state',
  'state': 'state',
  'Zip': 'zip',
  'zip': 'zip',
  'Country': 'country',
  'country': 'country',
  
  // Phone fields
  'PhoneW': 'office_phone',
  'office_phone': 'office_phone',
  'PhoneFax': 'fax_1',
  'fax_1': 'fax_1',
  'PhoneOth': 'cell_phone',
  'cell_phone': 'cell_phone',
  'PhoneOthProvider': 'cell_provider',
  
  // Email
  'Email': 'email',
  'email': 'email',
  
  // Notification preferences
  'NotifyEmail': 'notify_email',
  'NotifySMS': 'notify_sms',
  'affNotifyFax': 'notify_fax',
  
  // Alternate contact
  'AltFName': 'alt_first_name',
  'AltLName': 'alt_last_name',
  'AltPhoneW': 'alt_office_phone',
  'AltPhoneFax': 'alt_fax',
  'AltPhoneOth': 'alt_cell_phone',
  'AltPhoneOthProvider': 'alt_cell_provider',
  'AltEmail': 'alt_email',
  'AltNotifyEmail': 'alt_notify_email',
  'AltNotifySMS': 'alt_notify_sms',
  'AltNotifyFax': 'alt_notify_fax',
  
  // Notes and Status
  'Notes': 'internal_notes',
  'internal_notes': 'internal_notes',
  'Status': 'status',
  'status': 'status',
  'Code': 'account_number',
  'account_number': 'account_number',
  'Date Created': 'created_at',
  'created_at': 'created_at',
  
  // Tax and network fields
  'EINNumber': 'tax_id',
  'NetworkCode': 'network_code',
  'LANetLogin': 'web_username',
  
  // Job info
  'department': 'department',
  'job_title': 'job_title',
  
  // Extra fields ‚Üí ignore
  'ExtraFldNV1': '_extra_nv1',
  'ExtraFldNV2': '_extra_nv2',
  'ExtraFldNV3': '_extra_nv3',
  'ExtraFldFL1': '_extra_fl1',
  'ExtraFldFL2': '_extra_fl2',
  'ExtraFldFL3': '_extra_fl3'
};

// Normalize a row using header mapping
function normalizeRow(row) {
  const normalized = {};
  for (const [sourceKey, value] of Object.entries(row)) {
    const targetKey = HEADER_MAP[sourceKey] || sourceKey.toLowerCase().replace(/\s+/g, '_');
    // Skip internal/extra fields that start with _
    if (!targetKey.startsWith('_')) {
      normalized[targetKey] = value;
    }
  }
  
  // Handle company-only contacts: if no first/last name but has company_name, fill in defaults
  if (!normalized.first_name && !normalized.last_name && normalized.company_name) {
    normalized.first_name = 'Company';
    normalized.last_name = normalized.company_name;
  }
  
  return normalized;
}

// Handle file selection
function handleFileSelect(e) {
  const file = e.target.files[0];
  const importBtn = document.getElementById('importBtn');
  const statusEl = document.getElementById('importStatus');
  const previewSection = document.getElementById('previewSection');
  const previewTable = document.getElementById('previewTable');

  if (!file) {
    importBtn.disabled = true;
    previewSection.style.display = 'none';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawData = XLSX.utils.sheet_to_json(firstSheet);

      if (rawData.length === 0) {
        statusEl.className = 'status error';
        statusEl.textContent = 'No data found in file';
        importBtn.disabled = true;
        return;
      }

      // Normalize all rows using header mapping
      importData = rawData.map(normalizeRow);
      
      // Check for valid data (first/last name or company_name)
      const validRows = importData.filter(row => 
        row.first_name || row.last_name || row.company_name
      );
      
      if (validRows.length === 0) {
        statusEl.className = 'status error';
        statusEl.textContent = 'No valid rows found. Need First_Name, Last_Name, or Company column.';
        importBtn.disabled = true;
        return;
      }

      // Show mapping info
      const sourceHeaders = Object.keys(rawData[0]);
      const mappedHeaders = sourceHeaders.map(h => HEADER_MAP[h] || h.toLowerCase());
      console.log('üìã Header mapping:', sourceHeaders.map((s, i) => `${s} ‚Üí ${mappedHeaders[i]}`));

      // Show preview with normalized data
      const displayHeaders = ['first_name', 'last_name', 'company_name', 'cell_phone', 'office_phone', 'email', 'city', 'state', 'status'];
      let html = '<tr>';
      displayHeaders.forEach(h => html += `<th>${h}</th>`);
      html += '</tr>';

      importData.slice(0, 10).forEach(row => {
        html += '<tr>';
        displayHeaders.forEach(h => html += `<td>${row[h] || ''}</td>`);
        html += '</tr>';
      });

      previewTable.innerHTML = html;
      previewSection.style.display = 'block';

      statusEl.className = 'status info';
      statusEl.textContent = `Found ${importData.length} accounts to import (${sourceHeaders.length} columns mapped)`;
      importBtn.disabled = false;

    } catch (err) {
      statusEl.className = 'status error';
      statusEl.textContent = `Error reading file: ${err.message}`;
      importBtn.disabled = true;
    }
  };

  reader.readAsArrayBuffer(file);
}

// Import accounts
async function importAccounts() {
  const statusEl = document.getElementById('importStatus');
  const importBtn = document.getElementById('importBtn');

  if (!importData || importData.length === 0) {
    statusEl.className = 'status error';
    statusEl.textContent = 'No data to import';
    return;
  }

  importBtn.disabled = true;
  statusEl.className = 'status info';
  statusEl.textContent = 'Importing accounts...';

  let successCount = 0;
  let errorCount = 0;
  const errors = [];

  for (const row of importData) {
    try {
      // Data is already normalized by normalizeRow() during file selection
      const accountData = {
        first_name: row.first_name || '',
        last_name: row.last_name || '',
        company_name: row.company_name || '',
        email: row.email || '',
        cell_phone: row.cell_phone || '',
        office_phone: row.office_phone || '',
        office_phone_ext: row.office_phone_ext || '',
        home_phone: row.home_phone || '',
        home_phone_ext: row.home_phone_ext || '',
        cell_phone_2: row.cell_phone_2 || '',
        cell_phone_3: row.cell_phone_3 || '',
        fax_1: row.fax_1 || '',
        fax_2: row.fax_2 || '',
        fax_3: row.fax_3 || '',
        department: row.department || '',
        job_title: row.job_title || '',
        address_line1: row.address_line1 || '',
        address_line2: row.address_line2 || '',
        city: row.city || '',
        state: row.state || '',
        zip: row.zip || '',
        country: row.country || 'US',
        internal_notes: row.internal_notes || '',
        trip_notes: row.trip_notes || '',
        notes_others: row.notes_others || '',
        source: row.source || 'import',
        rental_agreement: row.rental_agreement || '',
        account_settings: row.account_settings || 'normal',
        status: (row.status || 'active').toLowerCase(),
        web_access: row.web_access || 'allow',
        is_billing_client: row.is_billing_client === true || row.is_billing_client === 'true' || row.is_billing_client === 'Y' || row.is_billing_client === '1',
        is_passenger: row.is_passenger === true || row.is_passenger === 'true' || row.is_passenger === 'Y' || row.is_passenger === '1',
        is_booking_contact: row.is_booking_contact === true || row.is_booking_contact === 'true' || row.is_booking_contact === 'Y' || row.is_booking_contact === '1',
        created_at: excelDateToISO(row.created_at) || new Date().toISOString()
      };

      const { error } = await supabaseClient
        .from('accounts')
        .insert(accountData);

      if (error) {
        errorCount++;
        errors.push(`${row.first_name || ''} ${row.last_name || row.company_name || 'Unknown'}: ${error.message}`);
      } else {
        successCount++;
      }
    } catch (err) {
      errorCount++;
      errors.push(`${row.first_name || ''} ${row.last_name || row.company_name || 'Unknown'}: ${err.message}`);
    }
  }

  if (errorCount === 0) {
    statusEl.className = 'status success';
    statusEl.textContent = `‚úì Successfully imported ${successCount} accounts`;
  } else {
    statusEl.className = 'status error';
    statusEl.textContent = `Imported ${successCount} accounts, ${errorCount} errors: ${errors.slice(0, 3).join('; ')}`;
  }

  // Refresh the accounts list
  loadCurrentAccounts();
  importBtn.disabled = false;
}

// Event listeners
document.getElementById('exportBtn').addEventListener('click', exportAccounts);
document.getElementById('templateBtn').addEventListener('click', downloadTemplate);
document.getElementById('importFile').addEventListener('change', handleFileSelect);
document.getElementById('importBtn').addEventListener('click', importAccounts);
document.getElementById('refreshBtn').addEventListener('click', loadCurrentAccounts);

// Initialize on load
init();
</script>
</body>
</html>
