<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Farmout Notification System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            margin: 5px; 
            cursor: pointer; 
            font-size: 14px; 
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Farmout Notification System Test</h1>
        <p>Test the complete notification system with realistic farmout offer scenarios.</p>
        
        <div>
            <button onclick="testNewOffer()">üÜï Test New Offer Notification</button>
            <button onclick="testOfferAccepted()">‚úÖ Test Offer Accepted</button>
            <button onclick="testOfferDeclined()">‚ùå Test Offer Declined</button>
            <button onclick="testTripStart()">üöó Test Trip Started</button>
            <button onclick="testTripComplete()">üèÅ Test Trip Complete</button>
            <button onclick="testUrgentNotification()">üö® Test Urgent Alert</button>
        </div>
        
        <div>
            <button onclick="testSmsTemplates()">üì± Test SMS Templates</button>
            <button onclick="testCompleteFlow()">üîÑ Test Complete Flow</button>
            <button onclick="sendRealSms()" style="background: #28a745;">üì≤ SEND REAL SMS</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
        
        <div style="margin: 15px 0; padding: 15px; background: #e8f5e9; border-radius: 8px;">
            <label><strong>üì± Test Phone Number:</strong></label><br>
            <input type="tel" id="testPhone" placeholder="+1 555-123-4567" style="width: 200px; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
            <br><small style="color: #666;">Enter your phone number to receive a real test SMS</small>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        let logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Test farmout offer sent event
        function testNewOffer() {
            log('üÜï Triggering farmout offer sent event...', 'info');
            
            const mockOffer = {
                reservationId: 'TEST-' + Date.now(),
                driverId: '1fef5163-c078-4a9d-ad78-be7220b8e316', // Eric's actual driver ID
                driverName: 'Eric Brustad',
                offerDetails: {
                    pickupAddress: '2450 Louisiana Street, Houston, TX 77006',
                    dropoffAddress: '1400 McKinney Street, Houston, TX 77010',
                    pickupTime: '8:15 PM',
                    driverPay: 31.50,
                    grandTotal: 45.00,
                    duration: '15 mins',
                    distance: '3.2 miles',
                    passengerFirstName: 'Sarah',
                    paxCount: 2,
                    vehicleType: 'Sedan',
                    notes: 'Test farmout offer - call when arrived'
                }
            };
            
            window.dispatchEvent(new CustomEvent('farmoutOfferSent', {
                detail: mockOffer
            }));
            
            log(`Offer sent to ${mockOffer.driverName} - $${mockOffer.offerDetails.driverPay}`, 'success');
        }
        
        // Test offer acceptance
        function testOfferAccepted() {
            log('‚úÖ Testing offer accepted notification...', 'info');
            
            window.dispatchEvent(new CustomEvent('farmoutOfferAccepted', {
                detail: {
                    reservationId: 'TEST-' + Date.now(),
                    driverId: 'driver-' + Date.now(),
                    driverName: 'Eric Brustad',
                    pickupTime: '8:15 PM'
                }
            }));
            
            log('Offer accepted by Eric Brustad', 'success');
        }
        
        // Test offer declined
        function testOfferDeclined() {
            log('‚ùå Testing offer declined notification...', 'info');
            
            window.dispatchEvent(new CustomEvent('farmoutOfferDeclined', {
                detail: {
                    reservationId: 'TEST-' + Date.now(),
                    driverId: 'driver-' + Date.now(),
                    driverName: 'Eric Brustad',
                    reason: 'Driver unavailable'
                }
            }));
            
            log('Offer declined by Eric Brustad', 'warning');
        }
        
        // Test trip started
        function testTripStart() {
            log('üöó Testing trip started notification...', 'info');
            
            window.dispatchEvent(new CustomEvent('tripStarted', {
                detail: {
                    reservationId: 'TEST-' + Date.now(),
                    driverId: 'driver-' + Date.now(),
                    driverName: 'Eric Brustad',
                    passengerName: 'Sarah Johnson'
                }
            }));
            
            log('Trip started - Eric Brustad picking up Sarah Johnson', 'success');
        }
        
        // Test trip completed
        function testTripComplete() {
            log('üèÅ Testing trip completed notification...', 'info');
            
            window.dispatchEvent(new CustomEvent('tripCompleted', {
                detail: {
                    reservationId: 'TEST-' + Date.now(),
                    driverId: 'driver-' + Date.now(),
                    driverName: 'Eric Brustad',
                    passengerName: 'Sarah Johnson',
                    fare: 45.00
                }
            }));
            
            log('Trip completed - Eric Brustad / Sarah Johnson - $45.00', 'success');
        }
        
        // Test urgent notification
        function testUrgentNotification() {
            log('üö® Testing urgent notification...', 'info');
            
            window.dispatchEvent(new CustomEvent('urgentAlert', {
                detail: {
                    message: 'Driver needs assistance - GPS shows vehicle stopped',
                    reservationId: 'TEST-' + Date.now(),
                    priority: 'high'
                }
            }));
            
            log('Urgent alert dispatched', 'error');
        }
        
        // Test SMS templates (renders actual SMS template from farmout automation)
        function testSmsTemplates() {
            log('üì± Testing SMS template rendering...', 'info');
            
            const mockOffer = {
                pickupAddress: '2450 Louisiana Street, Houston, TX 77006',
                dropoffAddress: '1400 McKinney Street, Houston, TX 77010',
                pickupTime: '8:15 PM',
                driverPay: 31.50,
                passengerFirstName: 'Sarah'
            };
            
            const template = `üöó NEW TRIP OFFER! 
üìÖ Tonight at ${mockOffer.pickupTime}
üë§ ${mockOffer.passengerFirstName} 
üí∞ You earn: $${mockOffer.driverPay}
üìç From: ${mockOffer.pickupAddress}
üìç To: ${mockOffer.dropoffAddress}
‚úÖ Accept: ${window.location.origin}/driver-portal.html?offer=accept&id=TEST123
‚ùå Decline: ${window.location.origin}/driver-portal.html?offer=decline&id=TEST123`;
            
            log('SMS Template Output:', 'info');
            log(template.replace(/\n/g, '<br>'), 'success');
        }
        
        // Send real SMS via Twilio API
        async function sendRealSms() {
            const phone = document.getElementById('testPhone').value.trim();
            
            if (!phone) {
                log('‚ùå Please enter a phone number first!', 'error');
                return;
            }
            
            log(`üì≤ Sending REAL SMS to ${phone}...`, 'info');
            
            // Build the SMS message using the farmout template
            const tripRequestUrl = `${window.location.origin}/trip-request.html?id=TEST123&driver_id=test`;
            const message = `Hi Test Driver, new trip available! Minneapolis to St Paul on Jan 27 at 3:00 PM. Pay: $45.00. Reply Y to accept or N to decline. Details: ${tripRequestUrl} - Expires in 15 min.`;
            
            log('Message: ' + message, 'info');
            
            try {
                const response = await fetch('/api/sms-send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: phone,
                        body: message
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ SMS SENT SUCCESSFULLY! SID: ${result.sid || 'N/A'}`, 'success');
                    log(`To: ${result.to || phone}`, 'success');
                } else {
                    log(`‚ùå SMS FAILED: ${result.error || 'Unknown error'}`, 'error');
                    if (result.details) {
                        log(`Details: ${result.details}`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå SMS ERROR: ${error.message}`, 'error');
            }
        }
        
        // Test complete flow
        async function testCompleteFlow() {
            log('üîÑ Starting complete farmout flow test...', 'info');
            
            // 1. New offer
            await sleep(500);
            testNewOffer();
            
            // 2. Offer accepted after 3 seconds
            await sleep(3000);
            testOfferAccepted();
            
            // 3. Trip started after 2 seconds  
            await sleep(2000);
            testTripStart();
            
            // 4. Trip completed after 5 seconds
            await sleep(5000);
            testTripComplete();
            
            log('‚úÖ Complete flow test finished!', 'success');
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Initialize
        log('üîä Farmout notification test ready. Click buttons to test different scenarios.', 'info');
        log('Make sure to have the driver portal open in another tab to hear sounds!', 'warning');
    </script>
</body>
</html>