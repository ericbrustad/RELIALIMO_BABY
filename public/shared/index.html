<!DOCTYPE html>
<html lang="en" data-layout="vertical">
  <head>
    <!-- <script>
      // INSTANT startup page redirect - must be first script
      (function() {
        try {
          var s = localStorage.getItem('company_settings');
          if (s) {
            var p = JSON.parse(s).defaultStartPage;
            var r = {'new-reservation':'reservation-form.html','farmout-dashboard':'dashboard.html','office':'my-office.html','accounts':'accounts.html','calendar':'calendar.html','quotes':'quotes.html','dispatch':'dispatch-grid.html','network':'network.html','settle':'settle.html','receivables':'receivables.html','payables':'payables.html','memos':'memos.html','files':'files.html','tools':'tools.html','reports':'reports.html'};
            if (r[p] && window.location.pathname.indexOf(r[p]) === -1) {
              window.location.replace(r[p]);
              return;
            }
          }
        } catch(e) {
          console.error('Startup script failed:', e);
        }
        document.documentElement.style.visibility = 'visible';
      })();
    </script> -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RELIA LIMO‚Ñ¢</title>
    <link rel="icon" href="favicon.png" />
    <!-- Load Supabase SDK from unpkg CDN with ES module -->
    <!-- Supabase SDK is now loaded via ES Module import in config.js -->
    <!-- Load environment variables first -->
    <script src="env.js"></script>
    <script src="SystemSettingsSync.js"></script>
    <script>
      // Apply saved layout mode early to avoid flash
      (function() {
        const savedLayout = localStorage.getItem('headerLayout') || 'vertical';
        document.documentElement.setAttribute('data-layout', savedLayout);
      })();
    </script>
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
    <script type="module" src="CompanySettingsManager.js"></script>
    <script type="module" src="SettingsApplicationManager.js"></script>
    <link rel="stylesheet" href="my-office.css" />
    <link rel="stylesheet" href="accounts.css" />
    <link rel="stylesheet" href="quotes.css" />
    <link rel="stylesheet" href="calendar.css" />
    <link rel="stylesheet" href="user-menu.css" />
    <style>
      :root {
        --sidebar-width: 170px;
      }

      /* ========== SPLASH SCREEN ========== */
      #splashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.6s ease, visibility 0.6s ease;
      }
      #splashScreen.fade-out {
        opacity: 0;
        visibility: hidden;
      }
      .splash-logo-container {
        position: relative;
        width: 200px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .splash-logo {
        width: 160px;
        height: auto;
        position: relative;
        z-index: 2;
        animation: logoFloat 3s ease-in-out infinite;
        filter: drop-shadow(0 0 30px rgba(201, 162, 39, 0.5));
      }
      @keyframes logoFloat {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-10px) scale(1.02); }
      }
      .splash-ring {
        position: absolute;
        border-radius: 50%;
        border: 3px solid transparent;
        animation: ringPulse 2s ease-out infinite;
      }
      .splash-ring:nth-child(1) {
        width: 180px;
        height: 180px;
        border-image: linear-gradient(135deg, #c9a227, #d4af37, #f4d03f) 1;
        animation-delay: 0s;
      }
      .splash-ring:nth-child(2) {
        width: 220px;
        height: 220px;
        border-image: linear-gradient(135deg, #667eea, #764ba2) 1;
        animation-delay: 0.5s;
      }
      .splash-ring:nth-child(3) {
        width: 260px;
        height: 260px;
        border-image: linear-gradient(135deg, #c9a227, #667eea) 1;
        animation-delay: 1s;
      }
      @keyframes ringPulse {
        0% { transform: scale(0.8); opacity: 1; }
        100% { transform: scale(1.4); opacity: 0; }
      }
      .splash-gradient-orb {
        position: absolute;
        width: 300px;
        height: 300px;
        border-radius: 50%;
        background: conic-gradient(from 0deg, #c9a227, #d4af37, #667eea, #764ba2, #c9a227);
        filter: blur(60px);
        opacity: 0.4;
        animation: orbRotate 4s linear infinite;
      }
      @keyframes orbRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .splash-text {
        margin-top: 40px;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 4px;
        text-transform: uppercase;
        background: linear-gradient(90deg, #c9a227, #d4af37, #f4d03f, #d4af37, #c9a227);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: shimmer 2s linear infinite;
      }
      @keyframes shimmer {
        to { background-position: 200% center; }
      }
      .splash-dots {
        display: flex;
        gap: 8px;
        margin-top: 20px;
      }
      .splash-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #c9a227;
        animation: dotBounce 1.4s ease-in-out infinite;
      }
      .splash-dot:nth-child(1) { animation-delay: 0s; }
      .splash-dot:nth-child(2) { animation-delay: 0.2s; }
      .splash-dot:nth-child(3) { animation-delay: 0.4s; }
      @keyframes dotBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
      /* Hide main app until auth confirmed */
      #app {
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      #app.authenticated {
        opacity: 1;
      }

      /* System Status Indicators */
      .system-status-bar {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        flex-wrap: wrap;
      }
      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .status-indicator:hover {
        transform: scale(1.05);
      }
      .status-indicator.configured {
        background: rgba(46, 125, 50, 0.15);
        color: #2e7d32;
        border: 1px solid rgba(46, 125, 50, 0.3);
      }
      .status-indicator.not-configured {
        background: rgba(198, 40, 40, 0.15);
        color: #c62828;
        border: 1px solid rgba(198, 40, 40, 0.3);
      }
      .status-indicator.partial {
        background: rgba(230, 81, 0, 0.15);
        color: #e65100;
        border: 1px solid rgba(230, 81, 0, 0.3);
      }
      .status-indicator .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .status-indicator.configured .status-dot { background: #2e7d32; }
      .status-indicator.not-configured .status-dot { background: #c62828; }
      .status-indicator.partial .status-dot { background: #e65100; }
      
      /* Global Search Bar */
      .global-search-container {
        position: relative;
        display: flex;
        align-items: center;
      }
      .global-search-toggle {
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .global-search-toggle:hover {
        background: rgba(255,255,255,0.25);
      }
      .global-search-toggle.active {
        background: white;
        color: #667eea;
      }
      .global-search-box {
        position: absolute;
        top: 100%;
        right: 0;
        width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        display: none;
        z-index: 9999;
        margin-top: 8px;
      }
      .global-search-box.active {
        display: block;
      }
      .global-search-input {
        width: 100%;
        padding: 12px 16px;
        border: none;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        outline: none;
        border-radius: 8px 8px 0 0;
      }
      .global-search-results {
        max-height: 400px;
        overflow-y: auto;
      }
      .search-result-item {
        padding: 10px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid #f0f0f0;
      }
      .search-result-item:hover {
        background: #f5f5f5;
      }
      .search-result-item .result-icon {
        font-size: 16px;
        width: 24px;
        text-align: center;
      }
      .search-result-item .result-text {
        flex: 1;
      }
      .search-result-item .result-title {
        font-weight: 600;
        color: #333;
      }
      .search-result-item .result-section {
        font-size: 11px;
        color: #888;
      }
      .search-no-results {
        padding: 20px;
        text-align: center;
        color: #888;
      }
      html[data-layout="vertical"] .global-search-container {
        margin-top: 10px;
      }
      html[data-layout="vertical"] .global-search-box {
        left: 100%;
        right: auto;
        top: 0;
        margin-left: 8px;
        margin-top: 0;
      }
      
      html[data-layout="vertical"] .system-status-bar {
        flex-direction: column;
        border-top: 1px solid rgba(255,255,255,0.1);
        margin-top: 10px;
      }
      html[data-layout="horizontal"] .system-status-bar {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
      }

      /* Main section visibility control */
      .app-main-section {
        display: none !important;
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }
      .app-main-section.active {
        display: block !important;
        opacity: 1;
      }
      
      /* Smooth iframe transitions */
      .app-main-section iframe {
        transition: opacity 0.15s ease-in-out;
        width: 100% !important;
        height: calc(100vh - 24px) !important;
        border: none;
      }

      /* Base reset */
      body {
        margin: 0;
        padding: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Vertical layout */
      html[data-layout="vertical"] body {
        padding-left: var(--sidebar-width) !important;
      }

      html[data-layout="vertical"] #app > header.header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        bottom: 0 !important;
        width: var(--sidebar-width) !important;
        max-width: var(--sidebar-width) !important;
        min-width: var(--sidebar-width) !important;
        display: flex;
        flex-direction: column;
        background: #1f2a44;
        color: white;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        z-index: 1000;
      }

      html[data-layout="vertical"] #app > header.header .header-content {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
        height: 100%;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Logo + Controls container */
      html[data-layout="vertical"] #app > header.header .header-left {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 8px;
      }

      html[data-layout="vertical"] #app > header.header .main-nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-height: 0;
        overflow-y: scroll;
        overflow-x: hidden;
        padding-right: 6px;
        padding-bottom: 20px;
        /* Firefox scrollbar */
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.5) rgba(255,255,255,0.15);
      }

      /* Scrollbar styling for vertical nav */
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar {
        width: 10px;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.15);
        border-radius: 5px;
        margin: 4px 0;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.45);
        border-radius: 5px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.65);
      }

      html[data-layout="vertical"] #app > header.header .nav-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
        color: white;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        border-radius: 6px;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      html[data-layout="vertical"] #app > header.header .nav-btn:hover {
        background: rgba(255,255,255,0.12);
        transform: translateX(2px);
      }

      html[data-layout="vertical"] #app > header.header .nav-btn.active {
        background: #e74c3c;
        border-color: #e74c3c;
      }

      html[data-layout="vertical"] #app > header.header .logo {
        font-size: 16px;
        font-weight: 800;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 0;
      }

      html[data-layout="vertical"] .app-main-section {
        padding: 12px;
        width: calc(100% - var(--sidebar-width)) !important;
        box-sizing: border-box;
      }

      /* Guard against global .header styles from iframes/other pages */
      #app > header.header {
        box-sizing: border-box;
      }

      /* Horizontal layout (original) */
      html[data-layout="horizontal"] body {
        padding: 0;
      }

      html[data-layout="horizontal"] #app > header.header {
        position: relative;
        width: 100%;
        display: block;
        background: #1f2a44;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      html[data-layout="horizontal"] #app > header.header .header-content {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 16px;
      }

      html[data-layout="horizontal"] #app > header.header .main-nav {
        display: flex;
        flex-direction: row;
        gap: 6px;
        flex: 1;
        flex-wrap: wrap;
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn {
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
        color: white;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        border-radius: 6px;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn:hover {
        background: rgba(255,255,255,0.12);
        transform: translateY(-1px);
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn.active {
        background: #e74c3c;
        border-color: #e74c3c;
      }

      html[data-layout="horizontal"] .app-main-section {
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }

      html[data-layout="horizontal"] .app-main-section iframe {
        height: calc(100vh - 120px) !important;
      }

      /* Header Controls Inline (next to logo) */
      .header-controls-inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Layout switcher */
      .layout-toggle {
        position: fixed;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        width: 160px;
        z-index: 2001;
      }

      .layout-toggle button {
        padding: 6px 8px;
        font-size: 12px;
        font-weight: 700;
        border-radius: 6px;
        border: 1px solid #ccc;
        cursor: pointer;
        min-width: 0;
        width: calc(50% - 3px);
      }

      .layout-toggle button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
    </style>
    <script>
      function setLayout(mode) {
        const normalized = mode === 'horizontal' ? 'horizontal' : 'vertical';
        localStorage.setItem('headerLayout', normalized);
        document.documentElement.setAttribute('data-layout', normalized);
        document.querySelectorAll('.layout-toggle button').forEach(btn => {
          const isVerticalButton = btn.id === 'layoutVertical';
          const isActive = isVerticalButton ? normalized === 'vertical' : normalized === 'horizontal';
          btn.classList.toggle('active', isActive);
        });
      }

      function initLayoutToggle() {
        const savedLayout = localStorage.getItem('headerLayout') || 'vertical';
        setLayout(savedLayout);
        const verticalBtn = document.getElementById('layoutVertical');
        const horizontalBtn = document.getElementById('layoutHorizontal');
        if (verticalBtn && horizontalBtn) {
          verticalBtn.addEventListener('click', () => setLayout('vertical'));
          horizontalBtn.addEventListener('click', () => setLayout('horizontal'));
        }
      }

      document.addEventListener('DOMContentLoaded', initLayoutToggle);
      
      // ========== SPLASH SCREEN CONTROL ==========
      // Listen for auth-ready event from auth-guard.js to hide splash and show app
      window.addEventListener('auth-ready', function(e) {
        console.log('[Splash] Auth confirmed, hiding splash screen');
        const splash = document.getElementById('splashScreen');
        const app = document.getElementById('app');
        if (splash) {
          splash.classList.add('fade-out');
          // Remove from DOM after transition
          setTimeout(() => splash.remove(), 600);
        }
        if (app) {
          app.classList.add('authenticated');
        }
      });
      
      // Fallback: If no auth event after 5 seconds, hide splash anyway
      // This handles cases where auth-guard might not be loaded
      setTimeout(function() {
        const splash = document.getElementById('splashScreen');
        if (splash && !splash.classList.contains('fade-out')) {
          console.log('[Splash] Timeout fallback, hiding splash');
          splash.classList.add('fade-out');
          setTimeout(() => splash.remove(), 600);
          const app = document.getElementById('app');
          if (app) app.classList.add('authenticated');
        }
      }, 5000);
    </script>
  </head>
  <body>
    <!-- Splash Screen - Shows during auth check -->
    <div id="splashScreen">
      <div class="splash-gradient-orb"></div>
      <div class="splash-logo-container">
        <div class="splash-ring"></div>
        <div class="splash-ring"></div>
        <div class="splash-ring"></div>
        <img src="https://siumiadylwcrkaqsfwkj.supabase.co/storage/v1/object/public/images/reliabull_Trans.png" alt="ReliaLimo" class="splash-logo">
      </div>
      <div class="splash-text">Admin Portal</div>
      <div class="splash-dots">
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
      </div>
    </div>

    <!-- Legacy layout toggle hidden - now in user menu pill -->
    <div class="layout-toggle" aria-label="Header layout selector" style="display:none;">
      <button id="layoutVertical">Vertical</button>
      <button id="layoutHorizontal">Horizontal</button>
    </div>
    <div id="app">
      <!-- UNIFIED HEADER -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" class="logo-bull">LIMO‚Ñ¢</h1>
            <!-- Global Search -->
            <div class="global-search-container">
              <button class="global-search-toggle" id="globalSearchToggle" title="Search (Ctrl+K)">üîç</button>
              <div class="global-search-box" id="globalSearchBox">
                <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Search sections, settings, data..." autocomplete="off">
                <div class="global-search-results" id="globalSearchResults"></div>
              </div>
            </div>
            <!-- System Status Indicators -->
            <div class="system-status-bar">
              <div id="smsStatusIndicator" class="status-indicator not-configured" title="Click to configure SMS" onclick="navigateToSmsSettings()">
                <span class="status-dot"></span>
                <span>SMS: Checking...</span>
              </div>
              <div id="emailStatusIndicator" class="status-indicator not-configured" title="Click to configure Email" onclick="navigateToEmailSettings()">
                <span class="status-dot"></span>
                <span>Email: Checking...</span>
              </div>
            </div>
          </div>
          <div class="main-nav">
            <button class="nav-btn" data-section="new-reservation"><span>New Reservation</span><span style="font-size: 24px;">‚ûï</span></button>
            <button class="nav-btn" data-section="reservations"><span>Reservations</span><span style="font-size: 24px;">üìã</span></button>
            <button class="nav-btn" data-section="dashboard"><span>Farmout Dashboard</span><span style="font-size: 24px;">üè†</span></button>
            <button class="nav-btn active" data-section="office"><span>Office</span><span style="font-size: 24px;">üè¢</span></button>
            <button class="nav-btn" data-section="accounts"><span>Accounts</span><span style="font-size: 24px;">üë§</span></button>
            <button class="nav-btn" data-section="passengers"><span>Passengers</span><span style="font-size: 24px;">üß≥</span></button>
            <button class="nav-btn" data-section="drivers"><span>Drivers</span><span style="font-size: 24px;">üöó</span></button>
            <button class="nav-btn" data-section="calendar"><span>Calendar</span><span style="font-size: 24px;">üìÖ</span></button>
            <button class="nav-btn" data-section="quotes"><span>Quotes</span><span style="font-size: 24px;">üí¨</span></button>
            <button class="nav-btn" data-section="dispatch"><span>Dispatch</span><span style="font-size: 24px;">üöô</span></button>
            <button class="nav-btn" data-section="network"><span>Network</span><span style="font-size: 24px;">üåê</span></button>
            <button class="nav-btn" data-section="settle"><span>Settle</span><span style="font-size: 24px;">üí∞</span></button>
            <button class="nav-btn" data-section="receivables"><span>Receivables</span><span style="font-size: 24px;">üìä</span></button>
            <button class="nav-btn" data-section="payables"><span>Payables</span><span style="font-size: 24px;">üí≥</span></button>
            <button class="nav-btn" data-section="memos"><span>Memos</span><span style="font-size: 24px;">üìù</span></button>
            <button class="nav-btn" data-section="files"><span>Files</span><span style="font-size: 24px;">üìÅ</span></button>
            <button class="nav-btn" data-section="tools"><span>Tools</span><span style="font-size: 24px;">üîß</span></button>
            <button class="nav-btn" data-section="reports"><span>Reports</span><span style="font-size: 24px;">üìà</span></button>
          </div>
        </div>
      </header>

      <!-- FARMOUT DASHBOARD SECTION (User View, Driver View, Farm-out) -->
      <div id="dashboardSection" class="app-main-section">
        <iframe src="index-reservations.html?view=reservations" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- OFFICE SECTION -->
      <div id="officeSection" class="app-main-section active">
        <iframe src="my-office.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- ACCOUNTS SECTION -->
      <div id="accountsSection" class="app-main-section">
        <iframe src="accounts.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- PASSENGERS SECTION -->
      <div id="passengersSection" class="app-main-section">
        <iframe src="passengers.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- DRIVERS SECTION -->
      <div id="driversSection" class="app-main-section">
        <iframe src="drivers.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CALENDAR SECTION -->
      <div id="calendarSection" class="app-main-section">
        <iframe src="calendar.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- QUOTES SECTION -->
      <div id="quotesSection" class="app-main-section">
        <iframe src="quotes.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RESERVATIONS SECTION -->
      <div id="reservationsSection" class="app-main-section">
        <iframe src="reservations-list.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- DISPATCH SECTION -->
      <div id="dispatchSection" class="app-main-section">
        <iframe src="dispatch-grid.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NETWORK SECTION -->
      <div id="networkSection" class="app-main-section">
        <iframe src="network.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- SETTLE SECTION -->
      <div id="settleSection" class="app-main-section">
        <iframe src="settle.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RECEIVABLES SECTION -->
      <div id="receivablesSection" class="app-main-section">
        <iframe src="receivables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- PAYABLES SECTION -->
      <div id="payablesSection" class="app-main-section">
        <iframe src="payables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- MEMOS SECTION -->
      <div id="memosSection" class="app-main-section">
        <iframe src="memos.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- FILES SECTION -->
      <div id="filesSection" class="app-main-section">
        <iframe src="files.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- TOOLS SECTION -->
      <div id="toolsSection" class="app-main-section">
        <iframe src="tools.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- REPORTS SECTION -->
      <div id="reportsSection" class="app-main-section">
        <iframe src="reports.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NEW RESERVATION SECTION -->
      <div id="new-reservationSection" class="app-main-section">
        <iframe src="reservation-form.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CONFIRMED RESERVATION SECTION (VIEW MODE) -->
      <div id="confirmedReservationSection" class="app-main-section">
        <iframe src="confirmed-reservation.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>
    </div>

    <script>
      // Track which section is currently active to prevent redundant switches
      let currentActiveSection = 'office';
      const iframeCache = new Map();

      // Wire all navigation buttons with event delegation
      document.addEventListener('DOMContentLoaded', () => {
        // Check if user has a startup page preference and navigate there
        checkStartupPagePreference();
        
        // Initialize Auto Farmout Mode badge on Reservations button
        initAutoFarmoutBadge();
        
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.addEventListener('click', (e) => {
            const target = e.target;
            const btn = target instanceof Element ? target.closest('.nav-btn') : null;
            if (btn && btn.dataset.section) {
              switchMainSection(btn.dataset.section);
            }
          });
        }
      });
      
      /**
       * Initialize Auto Farmout Mode badge on Reservations button if enabled
       * Also shows indicators for default driver and default vehicle
       */
      function initAutoFarmoutBadge() {
        const isEnabled = localStorage.getItem('autoFarmoutMode') === 'true';
        const reservationsBtn = document.querySelector('[data-section="reservations"]');
        if (!reservationsBtn) return;
        
        reservationsBtn.style.position = 'relative';
        
        // Create or get badge container
        let badgeContainer = reservationsBtn.querySelector('.badge-container');
        if (!badgeContainer) {
          badgeContainer = document.createElement('div');
          badgeContainer.className = 'badge-container';
          reservationsBtn.appendChild(badgeContainer);
        }
        
        // Clear existing badges
        badgeContainer.innerHTML = '';
        
        // Auto Farmout badge
        if (isEnabled) {
          const farmBadge = document.createElement('span');
          farmBadge.className = 'auto-farmout-badge';
          farmBadge.textContent = 'üè†';
          farmBadge.title = 'Auto Farmout Mode Active';
          badgeContainer.appendChild(farmBadge);
        }
        
        // Check for default driver and vehicle from database
        checkDefaultsAndShowBadges(badgeContainer);
        
        // Listen for changes from user menu
        window.addEventListener('message', (event) => {
          if (event.data?.type === 'autoFarmoutModeChanged') {
            initAutoFarmoutBadge(); // Reinitialize all badges
          }
          if (event.data?.type === 'defaultDriverChanged' || event.data?.type === 'defaultVehicleChanged') {
            initAutoFarmoutBadge(); // Reinitialize all badges
          }
        });
      }
      
      /**
       * Check for default drivers and vehicles and show badges
       */
      async function checkDefaultsAndShowBadges(container) {
        try {
          // Get Supabase credentials
          const supabaseUrl = localStorage.getItem('relia_supabase_url') || 
            document.querySelector('meta[name="supabase-url"]')?.content;
          const supabaseKey = localStorage.getItem('relia_supabase_key') || 
            document.querySelector('meta[name="supabase-anon-key"]')?.content;
          
          if (!supabaseUrl || !supabaseKey) return;
          
          // Check for default driver
          const driverResp = await fetch(
            `${supabaseUrl}/rest/v1/drivers?is_default_driver=eq.true&is_active=eq.true&select=id,first_name,last_name&limit=5`,
            { headers: { 'apikey': supabaseKey } }
          );
          
          if (driverResp.ok) {
            const defaultDrivers = await driverResp.json();
            if (defaultDrivers.length > 0) {
              const driverBadge = document.createElement('span');
              driverBadge.className = 'default-driver-badge';
              driverBadge.textContent = 'üë§';
              const driverNames = defaultDrivers.map(d => `${d.first_name || ''} ${d.last_name || ''}`.trim()).join(', ');
              driverBadge.title = `Default Driver${defaultDrivers.length > 1 ? 's' : ''}: ${driverNames}`;
              container.appendChild(driverBadge);
            }
          }
          
          // Check for default vehicle
          const vehicleResp = await fetch(
            `${supabaseUrl}/rest/v1/vehicle_types?is_app_default=eq.true&select=id,name&limit=1`,
            { headers: { 'apikey': supabaseKey } }
          );
          
          if (vehicleResp.ok) {
            const defaultVehicles = await vehicleResp.json();
            if (defaultVehicles.length > 0) {
              const vehicleBadge = document.createElement('span');
              vehicleBadge.className = 'default-vehicle-badge';
              vehicleBadge.textContent = 'üöó';
              vehicleBadge.title = `Default Vehicle: ${defaultVehicles[0].name}`;
              container.appendChild(vehicleBadge);
            }
          }
        } catch (err) {
          console.warn('[Badges] Could not check defaults:', err.message);
        }
      }

      /**
       * Check for startup page preference and navigate if applicable
       */
      function checkStartupPagePreference() {
        try {
          // Only navigate from index.html, index-reservations.html, or root path
          const currentPath = (window.location.pathname || '').toLowerCase();
          let currentFile = currentPath.split('/').pop() || '';
          
          // Remove .html extension for comparison
          if (currentFile.endsWith('.html')) {
            currentFile = currentFile.replace('.html', '');
          }
          
          console.log('[StartupPage] ========== CHECKING STARTUP PAGE NAVIGATION ==========');
          console.log('[StartupPage] Current file (normalized):', currentFile);
          
          // Valid entry points for startup page navigation (normalized without .html)
          const validEntryPoints = ['index', 'index-reservations', ''];
          const isValidEntry = validEntryPoints.includes(currentFile) || !currentFile;
          console.log('[StartupPage] Is valid entry point?', isValidEntry);
          
          if (!isValidEntry) {
            console.log('[StartupPage] Not on a valid entry point, skipping navigation');
            return;
          }

          // Check if CompanySettingsManager is available
          if (!window.CompanySettingsManager) {
            console.log('[StartupPage] CompanySettingsManager not available yet');
            return;
          }

          console.log('[StartupPage] ===== LOADING SETTINGS =====');
          const settingsManager = new window.CompanySettingsManager();
          const startPage = settingsManager.getSetting('defaultStartPage');
          console.log('[StartupPage] Raw getSetting("defaultStartPage"):', startPage);
          const finalPage = startPage || 'reservations';
          console.log('[StartupPage] After fallback:', finalPage);

          // Map setting values to section names
          const STARTUP_SECTIONS = {
            'new-reservation': 'new-reservation',
            'farmout-dashboard': 'dashboard',
            'office': 'office',
            'accounts': 'accounts',
            'calendar': 'calendar',
            'quotes': 'quotes',
            'reservations': 'reservations',
            'dispatch': 'dispatch',
            'network': 'network',
            'settle': 'settle',
            'receivables': 'receivables',
            'payables': 'payables',
            'memos': 'memos',
            'files': 'files',
            'tools': 'tools',
            'reports': 'reports'
          };

          const section = STARTUP_SECTIONS[finalPage];
          console.log('[StartupPage] ===== SECTION LOOKUP =====');
          console.log('[StartupPage] Looking up section for:', finalPage);
          console.log('[StartupPage] Available sections:', Object.keys(STARTUP_SECTIONS));
          console.log('[StartupPage] Section lookup result:', section);
          
          // If we found a valid section and it's not the default, navigate to it
          if (section && section !== 'office') { // 'office' is the default
            console.log('[StartupPage] ‚úÖ Navigating to startup section:', section);
            switchMainSection(section);
            return;
          }
          
          console.log('[StartupPage] Using default section (office)');
        } catch (error) {
          console.error('[StartupPage] Error checking startup page:', error);
        }
      }

      function switchMainSection(section) {
        const isNewReservationRequest = section === 'new-reservation';

        // Skip if already on this section unless forcing a fresh new reservation load
        if (currentActiveSection === section && !isNewReservationRequest) {
          console.log('‚ÑπÔ∏è Already on section:', section);
          return;
        }

        console.log('Switching to section:', section);
        currentActiveSection = section;
        
        // Update nav button active state
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.section === section) {
            btn.classList.add('active');
          }
        });

        // Hide all sections
        document.querySelectorAll('.app-main-section').forEach(sec => {
          sec.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(section + 'Section');
        if (sectionElement) {
          sectionElement.classList.add('active');
          console.log('‚úì Activated section:', section);
          
          // For reservations, ensure we're on the list view but don't reload if already there
          if (section === 'reservations') {
            const reservationsIframe = sectionElement.querySelector('iframe');
            if (reservationsIframe) {
              const currentSrc = (reservationsIframe.src || '').toLowerCase();
              if (!currentSrc.includes('reservations-list.html')) {
                console.log('üîÑ Loading reservations-list.html');
                reservationsIframe.src = 'reservations-list.html';
              } else {
                console.log('‚úì Reservations iframe already on list view, no reload');
              }
            }
          } else if (section === 'new-reservation') {
            const reservationIframe = sectionElement.querySelector('iframe');
            if (reservationIframe) {
              console.log('üîÑ Preparing fresh reservation form');
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              const timestamp = Date.now();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }
        } else {
          console.error('Section not found:', section + 'Section');
        }
      }

      // Listen for messages from iframes
      window.addEventListener('message', function(event) {
        // Handle reservation form signals
        if (event.data.action === 'reservationFormScriptLoaded') {
          console.log('üì® [iframe‚Üíparent] Reservation form script loaded, readyState:', event.data.readyState);
        } else if (event.data.action === 'reservationFormInitialized') {
          console.log('üì® [iframe‚Üíparent] Reservation form initialized, editMode:', event.data.editMode);
        }
        if (event.data.action === 'switchSection') {
          switchMainSection(event.data.section);
            if (event.data.section === 'reservations' && event.data.openConf) {
              // Give iframe time to load/become active before sending message
              setTimeout(() => {
                const reservationsIframe = document.querySelector('#reservationsSection iframe');
                if (reservationsIframe && reservationsIframe.contentWindow) {
                  console.log('üì§ Sending openReservation message to reservations list:', event.data.openConf);
                  reservationsIframe.contentWindow.postMessage({
                    action: 'openReservation',
                    conf: event.data.openConf
                  }, '*');
                }
              }, 300);
            }
        } else if (event.data.action === 'openReservation') {
          // Handle opening a saved reservation from reservations-list iframe
          const confNumber = event.data.openConf || event.data.conf;
          // Switch to confirmed-reservation section (view mode) - NOT new-reservation
          switchMainSection('confirmedReservation');
          
          // Small delay to ensure section is visible
          setTimeout(() => {
            const reservationIframe = document.querySelector('#confirmedReservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              reservationIframe.dataset.viewMode = 'true';
              // Load confirmed-reservation.html (view mode) instead of the edit form
              const timestamp = new Date().getTime();
              const encodedConf = encodeURIComponent(confNumber);
              reservationIframe.src = `confirmed-reservation.html?conf=${encodedConf}&_reload=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'newReservation') {
          // Handle new reservation request from reservation form
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Clear any stored conf number
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              // Force reload to get a fresh blank form
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'editReservation') {
          // Handle edit mode request from confirmed-reservation iframe
          const confNumber = event.data.conf;
          // Switch to new-reservation section for editing
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              delete reservationIframe.dataset.viewMode;
              // Load reservation-form.html in edit mode
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_edit=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'switchToReservations') {
          // Switch back to reservations list
          switchMainSection('reservations');
        } else if (event.data.action === 'navigate') {
        } else if (event.data.action === 'reservationSaved') {
          // Reservation was saved - refresh the reservations list
          console.log('üì• Received reservationSaved message, refreshing list...');
          const reservationsIframe = document.querySelector('#reservationsSection iframe');
          if (reservationsIframe && reservationsIframe.contentWindow) {
            reservationsIframe.contentWindow.postMessage({
              action: 'refreshReservations'
            }, '*');
          }
          
          // Also refresh farmout table in case farmout status changed
          if (typeof window.uiManager !== 'undefined' && window.uiManager) {
            window.uiManager.updateFarmoutTable();
          }
        } else if (event.data.action === 'farmoutCleared') {
          // Farmout fields were cleared - refresh the farmout table
          console.log('üì• Received farmoutCleared message, refreshing farmout table...');
          if (typeof window.uiManager !== 'undefined' && window.uiManager) {
            window.uiManager.updateFarmoutTable();
          }
        } else if (event.data.action === 'relia:accountSaved' || event.data.action === 'accountSaved') {
          // Account was saved - refresh the reservations list to show updated account data
          console.log('üì• Received accountSaved message:', event.data);
          const reservationsIframe = document.querySelector('#reservationsSection iframe');
          if (reservationsIframe && reservationsIframe.contentWindow) {
            reservationsIframe.contentWindow.postMessage({
              action: 'refreshReservations'
            }, '*');
          }
          
          // Also forward to reservation form iframe so it can update billing account
          const reservationIframe = document.querySelector('#newReservationSection iframe');
          if (reservationIframe && reservationIframe.contentWindow) {
            console.log('üì§ Forwarding accountSaved to reservation form iframe');
            reservationIframe.contentWindow.postMessage(event.data, '*');
          }
        } else if (event.data.action === 'switchToDashboard') {
          // Switch to dashboard first
          switchMainSection('dashboard');
          // Then send message to dashboard iframe to switch view
          setTimeout(() => {
            const dashboardIframe = document.querySelector('#dashboardSection iframe');
            if (dashboardIframe && dashboardIframe.contentWindow) {
              dashboardIframe.contentWindow.postMessage({
                action: 'switchView',
                view: event.data.view
              }, '*');
            }
          }, 100);
        } else if (event.data.action === 'navigateToSystemMapping') {
          // Switch to Office section
          switchMainSection('office');
          // Then send message to office iframe to navigate to System Settings > System Mapping
          setTimeout(() => {
            const officeIframe = document.querySelector('#officeSection iframe');
            if (officeIframe && officeIframe.contentWindow) {
              officeIframe.contentWindow.postMessage({
                action: 'navigateToSystemSettings',
                page: 'system-mapping'
              }, '*');
            }
          }, 100);
        }
      });
      
      // Utility to purge ghost reservations from localStorage
      window.purgeAllGhostReservations = function() {
        localStorage.removeItem('relia_reservations');
        sessionStorage.removeItem('relia_ghost_purge_v1');
        console.log('[ManualPurge] Cleared all cached reservations. Reloading...');
        location.reload();
      };
      
      // Load environment settings from API and sync to localStorage
      async function loadEnvSettingsToLocalStorage() {
        try {
          const response = await fetch('/api/get-env-settings');
          if (!response.ok) {
            console.warn('[EnvSettings] API not available');
            return false;
          }
          const data = await response.json();
          if (!data.success) return false;
          
          // Sync SMS/Twilio settings to localStorage
          if (data.twilio?.isConfigured) {
            const providers = JSON.parse(localStorage.getItem('smsProviders') || '[]');
            const existingIdx = providers.findIndex(p => p.name === 'Twilio' || p.provider === 'twilio');
            const twilioProvider = {
              name: 'Twilio',
              provider: 'twilio',
              accountSid: data.twilio.accountSid,
              authToken: data.twilio.authToken,
              apiKeySid: data.twilio.apiKeySid || '',
              apiKeySecret: data.twilio.apiKeySecret || '',
              messagingServiceSid: data.twilio.messagingServiceSid,
              fromNumber: data.twilio.fromNumber,
              isDefault: true
            };
            if (existingIdx >= 0) {
              providers[existingIdx] = { ...providers[existingIdx], ...twilioProvider };
            } else {
              providers.unshift(twilioProvider);
            }
            localStorage.setItem('smsProviders', JSON.stringify(providers));
            console.log('[EnvSettings] SMS/Twilio synced to localStorage');
          }
          
          // Sync Email settings to localStorage
          if (data.email?.isConfigured) {
            const emailSettings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
            emailSettings.smtpHost = data.email.smtpHost || emailSettings.smtpHost || '';
            emailSettings.smtpPort = parseInt(data.email.smtpPort) || emailSettings.smtpPort || 465;
            emailSettings.smtpUser = data.email.smtpUser || emailSettings.smtpUser || '';
            emailSettings.smtpPass = data.email.smtpPass || emailSettings.smtpPass || '';
            emailSettings.fromEmail = data.email.fromEmail || emailSettings.fromEmail || '';
            emailSettings.fromName = data.email.fromName || emailSettings.fromName || 'RELIALIMO';
            emailSettings.resendApiKey = data.email.resendApiKey || emailSettings.resendApiKey || '';
            emailSettings.provider = data.email.provider || 'resend';
            localStorage.setItem('emailSettings', JSON.stringify(emailSettings));
            localStorage.setItem('emailSettingsConfig', JSON.stringify(emailSettings));
            console.log('[EnvSettings] Email synced to localStorage');
          }
          
          return true;
        } catch (e) {
          console.warn('[EnvSettings] Failed to load:', e);
          return false;
        }
      }
      
      // System Status Checker - SMS & Email Configuration
      const SystemStatusChecker = {
        checkSMSConfig() {
          const indicator = document.getElementById('smsStatusIndicator');
          if (!indicator) return;
          
          let providers = [];
          try {
            const raw = localStorage.getItem('smsProviders');
            if (raw) providers = JSON.parse(raw);
          } catch (e) {}
          
          const defaultProvider = providers.find(p => p.isDefault) || providers[0];
          
          if (!defaultProvider) {
            indicator.className = 'status-indicator not-configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>SMS: Not Set</span>';
            indicator.title = 'Click to configure SMS settings';
            return;
          }
          
          const hasAccountSid = defaultProvider.accountSid?.startsWith('AC') && defaultProvider.accountSid.length > 10;
          const hasAuth = defaultProvider.authToken?.length > 10 || (defaultProvider.apiKeySid?.length > 5 && defaultProvider.apiKeySecret?.length > 10);
          const hasSender = defaultProvider.fromNumber?.length >= 10 || defaultProvider.messagingServiceSid?.startsWith('MG');
          
          const checks = [hasAccountSid, hasAuth, hasSender];
          const validCount = checks.filter(Boolean).length;
          
          if (validCount === 3) {
            indicator.className = 'status-indicator configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>SMS: ‚úì</span>';
            indicator.title = 'SMS is configured correctly';
          } else if (validCount > 0) {
            indicator.className = 'status-indicator partial';
            indicator.innerHTML = `<span class="status-dot"></span><span>SMS: ${validCount}/3</span>`;
            indicator.title = 'SMS partially configured - click to complete';
          } else {
            indicator.className = 'status-indicator not-configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>SMS: Not Set</span>';
            indicator.title = 'Click to configure SMS settings';
          }
        },
        
        checkEmailConfig() {
          const indicator = document.getElementById('emailStatusIndicator');
          if (!indicator) return;
          
          let settings = null;
          try {
            const raw = localStorage.getItem('emailSettings');
            if (raw) settings = JSON.parse(raw);
          } catch (e) {}
          
          if (!settings) {
            indicator.className = 'status-indicator not-configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>Email: Not Set</span>';
            indicator.title = 'Click to configure Email settings';
            return;
          }
          
          const hasSmtp = settings.smtpHost?.length > 3;
          const hasPort = settings.smtpPort > 0;
          const hasFrom = settings.fromEmail?.includes('@');
          
          const checks = [hasSmtp, hasPort, hasFrom];
          const validCount = checks.filter(Boolean).length;
          
          if (validCount === 3) {
            indicator.className = 'status-indicator configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>Email: ‚úì</span>';
            indicator.title = 'Email is configured correctly';
          } else if (validCount > 0) {
            indicator.className = 'status-indicator partial';
            indicator.innerHTML = `<span class="status-dot"></span><span>Email: ${validCount}/3</span>`;
            indicator.title = 'Email partially configured - click to complete';
          } else {
            indicator.className = 'status-indicator not-configured';
            indicator.innerHTML = '<span class="status-dot"></span><span>Email: Not Set</span>';
            indicator.title = 'Click to configure Email settings';
          }
        },
        
        init() {
          // First load env settings from API, then check config
          loadEnvSettingsToLocalStorage().then(() => {
            this.checkSMSConfig();
            this.checkEmailConfig();
          });
          
          // Re-check periodically (every 30 seconds)
          setInterval(() => {
            this.checkSMSConfig();
            this.checkEmailConfig();
          }, 30000);
          
          // Re-check on storage changes
          window.addEventListener('storage', (e) => {
            if (e.key === 'smsProviders') this.checkSMSConfig();
            if (e.key === 'emailSettings') this.checkEmailConfig();
          });
        }
      };
      
      // Navigate to SMS settings
      function navigateToSmsSettings() {
        switchMainSection('office');
        setTimeout(() => {
          const officeIframe = document.querySelector('#officeSection iframe');
          if (officeIframe && officeIframe.contentWindow) {
            officeIframe.contentWindow.postMessage({
              action: 'navigateToSystemSettings',
              page: 'sms-provider'
            }, '*');
          }
        }, 100);
      }
      
      // Navigate to Email settings
      function navigateToEmailSettings() {
        switchMainSection('office');
        setTimeout(() => {
          const officeIframe = document.querySelector('#officeSection iframe');
          if (officeIframe && officeIframe.contentWindow) {
            officeIframe.contentWindow.postMessage({
              action: 'navigateToSystemSettings',
              page: 'email-settings'
            }, '*');
          }
        }, 100);
      }
      
      // Initialize status checker on DOM ready
      document.addEventListener('DOMContentLoaded', () => SystemStatusChecker.init());
      
      // Global Search Functionality
      const GlobalSearch = {
        searchableItems: [
          // Main Navigation Sections
          { title: 'New Reservation', section: 'Navigation', icon: '‚ûï', action: () => switchMainSection('new-reservation') },
          { title: 'Farmout Dashboard', section: 'Navigation', icon: 'üè†', action: () => switchMainSection('dashboard') },
          { title: 'Office / My Office', section: 'Navigation', icon: 'üè¢', action: () => switchMainSection('office') },
          { title: 'Accounts', section: 'Navigation', icon: 'üë§', action: () => switchMainSection('accounts') },
          { title: 'Calendar', section: 'Navigation', icon: 'üìÖ', action: () => switchMainSection('calendar') },
          { title: 'Quotes', section: 'Navigation', icon: 'üìã', action: () => switchMainSection('quotes') },
          { title: 'Reservations List', section: 'Navigation', icon: 'üöó', action: () => switchMainSection('reservations') },
          { title: 'Dispatch', section: 'Navigation', icon: 'üöô', action: () => switchMainSection('dispatch') },
          { title: 'Network', section: 'Navigation', icon: 'üåê', action: () => switchMainSection('network') },
          { title: 'Settle', section: 'Navigation', icon: 'üí∞', action: () => switchMainSection('settle') },
          { title: 'Receivables', section: 'Navigation', icon: 'üìä', action: () => switchMainSection('receivables') },
          { title: 'Payables', section: 'Navigation', icon: 'üí≥', action: () => switchMainSection('payables') },
          { title: 'Memos', section: 'Navigation', icon: 'üìù', action: () => switchMainSection('memos') },
          { title: 'Files', section: 'Navigation', icon: 'üìÅ', action: () => switchMainSection('files') },
          { title: 'Tools', section: 'Navigation', icon: 'üîß', action: () => switchMainSection('tools') },
          { title: 'Reports', section: 'Navigation', icon: 'üìà', action: () => switchMainSection('reports') },
          
          // Office Sub-sections
          { title: 'Vehicle Types', section: 'Office Settings', icon: 'üöó', keywords: 'car suv sedan limo bus', action: () => this.navigateToOffice('vehicle-types') },
          { title: 'Service Types', section: 'Office Settings', icon: 'üõéÔ∏è', keywords: 'airport hourly point transfer', action: () => this.navigateToOffice('service-types') },
          { title: 'Rate Management', section: 'Office Settings', icon: 'üíµ', keywords: 'pricing fees gratuity charges', action: () => this.navigateToOffice('rate-management') },
          { title: 'Driver Management', section: 'Office Settings', icon: 'üë®‚Äç‚úàÔ∏è', keywords: 'employee driver chauffeur', action: () => this.navigateToOffice('drivers') },
          { title: 'Company Settings', section: 'Office Settings', icon: '‚öôÔ∏è', keywords: 'configuration business', action: () => this.navigateToOffice('company-settings') },
          { title: 'SMS Settings', section: 'Office Settings', icon: 'üì±', keywords: 'text message twilio', action: () => navigateToSmsSettings() },
          { title: 'Email Settings', section: 'Office Settings', icon: '‚úâÔ∏è', keywords: 'smtp mail notification', action: () => navigateToEmailSettings() },
          { title: 'Widget Settings', section: 'Office Settings', icon: 'üéõÔ∏è', keywords: 'clock timer monitor display widgets', action: () => window.location.href = 'widget-settings.html' },
          { title: 'System Mapping', section: 'Office Settings', icon: 'üó∫Ô∏è', keywords: 'google mapbox api', action: () => this.navigateToOffice('system-mapping') },
          { title: 'Affiliates', section: 'Office Settings', icon: 'ü§ù', keywords: 'partner vendor farm', action: () => this.navigateToOffice('affiliates') },
          
          // Common Actions
          { title: 'Create Account', section: 'Actions', icon: '‚ûï', keywords: 'new customer client', action: () => { switchMainSection('accounts'); } },
          { title: 'View Calendar', section: 'Actions', icon: 'üìÖ', keywords: 'schedule booking', action: () => switchMainSection('calendar') },
          { title: 'Dispatch Board', section: 'Actions', icon: 'üöô', keywords: 'assign driver trip', action: () => switchMainSection('dispatch') },
        ],
        
        navigateToOffice(page) {
          switchMainSection('office');
          setTimeout(() => {
            const officeIframe = document.querySelector('#officeSection iframe');
            if (officeIframe && officeIframe.contentWindow) {
              officeIframe.contentWindow.postMessage({ action: 'navigateToTab', tab: page }, '*');
            }
          }, 150);
        },
        
        search(query) {
          if (!query || query.length < 2) return [];
          const q = query.toLowerCase();
          return this.searchableItems.filter(item => {
            const searchText = `${item.title} ${item.section} ${item.keywords || ''}`.toLowerCase();
            return searchText.includes(q);
          }).slice(0, 10);
        },
        
        renderResults(results) {
          const container = document.getElementById('globalSearchResults');
          if (!container) return;
          
          if (results.length === 0) {
            container.innerHTML = '<div class="search-no-results">No results found</div>';
            return;
          }
          
          container.innerHTML = results.map((item, idx) => `
            <div class="search-result-item" data-index="${idx}">
              <span class="result-icon">${item.icon}</span>
              <div class="result-text">
                <div class="result-title">${item.title}</div>
                <div class="result-section">${item.section}</div>
              </div>
            </div>
          `).join('');
          
          // Bind click events
          container.querySelectorAll('.search-result-item').forEach((el, idx) => {
            el.addEventListener('click', () => {
              const item = results[idx];
              if (item.action) item.action();
              this.close();
            });
          });
        },
        
        open() {
          const toggle = document.getElementById('globalSearchToggle');
          const box = document.getElementById('globalSearchBox');
          const input = document.getElementById('globalSearchInput');
          if (toggle) toggle.classList.add('active');
          if (box) box.classList.add('active');
          if (input) { input.value = ''; input.focus(); }
          document.getElementById('globalSearchResults').innerHTML = '';
        },
        
        close() {
          const toggle = document.getElementById('globalSearchToggle');
          const box = document.getElementById('globalSearchBox');
          if (toggle) toggle.classList.remove('active');
          if (box) box.classList.remove('active');
        },
        
        toggle() {
          const box = document.getElementById('globalSearchBox');
          if (box?.classList.contains('active')) {
            this.close();
          } else {
            this.open();
          }
        },
        
        init() {
          const toggle = document.getElementById('globalSearchToggle');
          const input = document.getElementById('globalSearchInput');
          
          if (toggle) {
            toggle.addEventListener('click', (e) => {
              e.stopPropagation();
              this.toggle();
            });
          }
          
          if (input) {
            input.addEventListener('input', (e) => {
              const results = this.search(e.target.value);
              this.renderResults(results);
            });
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Escape') this.close();
            });
          }
          
          // Close on click outside
          document.addEventListener('click', (e) => {
            const container = document.querySelector('.global-search-container');
            if (container && !container.contains(e.target)) {
              this.close();
            }
          });
          
          // Keyboard shortcut: Ctrl+K
          document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
              e.preventDefault();
              this.toggle();
            }
          });
        }
      };
      
      document.addEventListener('DOMContentLoaded', () => GlobalSearch.init());
    </script>

    <!-- Authentication Protection & User Menu -->
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
    <!-- Company Settings & Application -->
    <script src="CompanySettingsManager.js"></script>
    <script src="SettingsApplicationManager.js"></script>
    <!-- SMS Service -->
    <script src="sms-service.js"></script>
  </body>
</html>
