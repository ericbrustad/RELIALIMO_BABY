<!DOCTYPE html>
<html lang="en" style="visibility:hidden" data-keep-header="true">
  <head>
    <script>
      // INSTANT startup page redirect - must be first script
      (function() {
        if (window.self !== window.top) { document.documentElement.style.visibility='visible'; return; }
        try {
          var s = localStorage.getItem('company_settings');
          if (s) {
            var p = JSON.parse(s).defaultStartPage;
            var r = {'new-reservation':'reservation-form.html','farmout-dashboard':'dashboard.html','office':'my-office.html','accounts':'accounts.html','calendar':'calendar.html','quotes':'quotes.html','dispatch':'dispatch-grid.html','network':'network.html','settle':'settle.html','receivables':'receivables.html','payables':'payables.html','memos':'memos.html','files':'files.html','tools':'tools.html','reports':'reports.html'};
            if (r[p]) { window.location.replace(r[p]); return; }
          }
        } catch(e) {}
        document.documentElement.style.visibility = 'visible';
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RELIAüêÇLIMO‚Ñ¢ - Reservation System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <!-- Environment config for Supabase/Maps keys -->
    <script src="env.js"></script>
    <!-- SMS Service for Twilio integration -->
    <script src="sms-service.js"></script>
    <script>
      // Derive company location from saved Office > Company Info (localStorage)
      (function syncCompanyLocationFromSettings() {
        let city = '';
        let state = '';
        let postal = '';
        let latitude = null;
        let longitude = null;

        try {
          const cached = localStorage.getItem('companyInfo');
          if (cached) {
            const info = JSON.parse(cached);
            city = info?.city?.trim() || '';
            state = info?.state?.trim() || '';
            postal = info?.postal_code?.trim() || '';
            latitude = info?.latitude ? parseFloat(info.latitude) : null;
            longitude = info?.longitude ? parseFloat(info.longitude) : null;
          }
        } catch (e) {
          console.warn('Unable to read companyInfo from storage:', e.message);
        }

        // Fallback to relia_company_settings if present
        if (!city && !state && !postal) {
          try {
            const settingsRaw = localStorage.getItem('relia_company_settings');
            if (settingsRaw) {
              const settings = JSON.parse(settingsRaw);
              city = settings?.companyCity?.trim() || '';
              state = settings?.companyState?.trim() || '';
              postal = settings?.companyZip?.trim() || settings?.companyZipCode?.trim() || '';
            }
          } catch (e) {
            console.warn('Unable to read relia_company_settings from storage:', e.message);
          }
        }

        const cityState = city && state ? `${city}, ${state}` : (city || state || '');

        if (cityState) {
          window.COMPANY_LOCATION_QUERY = cityState;
        }
        window.COMPANY_ZIP_CODE = postal || '';
        
        // Set company center from lat/lng if available
        if (latitude && longitude && !isNaN(latitude) && !isNaN(longitude)) {
          window.COMPANY_CENTER = [latitude, longitude];
          console.log('Company center set from settings:', window.COMPANY_CENTER);
        }
      })();

      const activateFarmOutTab = () => {
        document.getElementById('farmOutBtn')?.click();
      };

      if (window.self !== window.top) {
        document.addEventListener('DOMContentLoaded', () => {
          const logo = document.querySelector('.header-content .logo');
          if (logo) {
            logo.style.display = 'none';
          }
          activateFarmOutTab();
        });
        
        // Listen for view switch messages from parent
        window.addEventListener('message', (event) => {
          if (event.data.action === 'switchView') {
            // Trigger the appropriate button click
            if (event.data.view === 'userView') {
              document.getElementById('userViewBtn')?.click();
            } else if (event.data.view === 'driverView') {
              document.getElementById('driverViewBtn')?.click();
            } else if (event.data.view === 'farm-out_reservations_View') {
              activateFarmOutTab();
            }
          } else if (event.data.action === 'openReservation') {
            // Handle opening a specific reservation
            const confNumber = event.data.conf;
            console.log('üì• Received openReservation message for conf:', confNumber);
            
            // Switch to User View first
            const userViewBtn = document.getElementById('userViewBtn');
            if (userViewBtn) {
              userViewBtn.click();
              console.log('‚úÖ Switched to User View');
            }
            
            // Give the form time to load, then trigger the reservation loading
            setTimeout(() => {
              if (window.reservationFormInstance?.loadExistingReservation) {
                window.reservationFormInstance.loadExistingReservation(confNumber);
                console.log('‚úÖ Loaded reservation:', confNumber);
              } else {
                console.warn('‚ö†Ô∏è ReservationForm instance not available yet');
              }
            }, 300);
          }
        });
      } else {
        document.addEventListener('DOMContentLoaded', activateFarmOutTab);
      }
    </script>
  </head>
  <body>
    <div id="app">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <h1 class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" class="logo-bull">LIMO‚Ñ¢</h1>
          <div class="header-controls">
            <button id="userViewBtn" class="tab-btn active">User View</button>
            <button id="driverViewBtn" class="tab-btn">Driver View</button>
            <button id="farmOutBtn" class="tab-btn">Farm-out Reservations</button>
            <button id="availabilityBtn" class="tab-btn">Availability Console</button>
            <button id="activeDriversBtn" class="tab-btn">Active Drivers</button>
            <button id="tripMonitorBtn" class="tab-btn">Trip Monitor</button>
            <button id="reservationsIframeBtn" class="tab-btn">Reservations</button>
          </div>
        </div>
      </header>

      <!-- Full-page Farm-out Tool Frame -->
      <section id="farmoutToolShell" class="farmout-tool-shell" style="display: none;">
        <div class="farmout-tool-bar">
          <div class="farmout-tool-title">
            <span class="farmout-tool-label" id="farmoutToolLabel">Farm-out Tool</span>
          </div>
          <div class="farmout-tool-actions">
            <button id="farmoutToolBack" class="btn btn-secondary">Back to Farm-out Reservations</button>
          </div>
        </div>
        <iframe id="farmoutToolFrame" title="Farm-out tool" src="" loading="lazy" referrerpolicy="no-referrer" allow="fullscreen"></iframe>
      </section>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <!-- User View -->
        <section id="userView" class="view active">
          <div class="split-layout">
            <div class="form-panel">
              <h2 class="panel-title">Dashboard</h2>
              <form id="reservationForm" class="reservation-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Passenger / First Name</label>
                    <input type="text" id="passengerFirstName" required placeholder="First name" />
                  </div>
                  <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="passengerLastName" required placeholder="Last name" />
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Cell</label>
                  <input type="tel" id="phone" required placeholder="(555) 555-5555" />
                </div>

                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="email" required placeholder="email@example.com" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Pickup Date</label>
                    <input type="date" id="pickupDate" required />
                  </div>
                  <div class="form-group">
                    <label>Pickup Time</label>
                    <input type="time" id="pickupTime" required />
                  </div>
                </div>

                <div class="form-group">
                  <label>Pickup Location</label>
                  <input type="text" id="pickupLocation" class="address-autocomplete" required placeholder="Enter pickup address" autocomplete="off" />
                  <div id="pickupSuggestions" class="address-suggestions-dropdown"></div>
                </div>

                <div class="address-details">
                  <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="pickupAddress" placeholder="Address" readonly />
                  </div>
                  <div class="form-row-3">
                    <div class="form-group">
                      <label>City</label>
                      <input type="text" id="pickupCity" placeholder="City" readonly />
                    </div>
                    <div class="form-group">
                      <label>State</label>
                      <input type="text" id="pickupState" placeholder="State" readonly />
                    </div>
                    <div class="form-group">
                      <label>Zip</label>
                      <input type="text" id="pickupZip" placeholder="Zip" readonly />
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label>Dropoff Location</label>
                  <input type="text" id="dropoffLocation" class="address-autocomplete" required placeholder="Enter dropoff address" autocomplete="off" />
                  <div id="dropoffSuggestions" class="address-suggestions-dropdown"></div>
                </div>

                <div class="address-details">
                  <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="dropoffAddress" placeholder="Address" readonly />
                  </div>
                  <div class="form-row-3">
                    <div class="form-group">
                      <label>City</label>
                      <input type="text" id="dropoffCity" placeholder="City" readonly />
                    </div>
                    <div class="form-group">
                      <label>State</label>
                      <input type="text" id="dropoffState" placeholder="State" readonly />
                    </div>
                    <div class="form-group">
                      <label>Zip</label>
                      <input type="text" id="dropoffZip" placeholder="Zip" readonly />
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label>Number of Passengers</label>
                  <input type="number" id="passengers" min="1" max="20" value="1" required />
                </div>

                <div class="form-group">
                  <label>Vehicle Type</label>
                  <select id="vehicleType" required>
                    <option value="">Select vehicle</option>
                    <option value="sedan">Sedan</option>
                    <option value="suv">SUV Limousine</option>
                    <option value="stretch">Stretch Limousine</option>
                    <option value="luxury">Luxury Sedan</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Special Instructions</label>
                  <textarea id="specialInstructions" rows="3" placeholder="Any special requirements..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Create Reservation</button>
              </form>
            </div>
            <div class="map-panel">
              <div class="map-controls">
                <label for="userMapView">Map View:</label>
                <select id="userMapView" class="map-view-selector">
                  <option value="OpenStreetMap">OpenStreetMap</option>
                  <option value="OpenStreetMap Dark">OpenStreetMap Dark</option>
                  <option value="Satellite">Satellite</option>
                  <option value="Street (Carto Light)">Street (Carto Light)</option>
                  <option value="Street (Carto Dark)">Street (Carto Dark)</option>
                  <option value="Topographic">Topographic</option>
                  <option value="Transport">Transport</option>
                </select>
              </div>
              <div class="driver-status-panel">
                <div class="driver-status-header">
                  <span class="status-title">üöó Live Drivers</span>
                  <span class="status-count" id="driverCount">0</span>
                  <button id="refreshDriversBtn" class="refresh-drivers-btn" title="Refresh drivers from database">‚ü≥</button>
                </div>
                <div id="driverStatusList" class="driver-status-list"></div>
              </div>
              <div id="userMap" class="map"></div>
            </div>
          </div>
        </section>

        <!-- Driver View -->
        <section id="driverView" class="view">
          <div class="split-layout">
            <div class="form-panel">
              <h2 class="panel-title">Available Reservations</h2>
              <div id="availableReservations" class="reservations-list"></div>
            </div>
            <div class="map-panel">
              <div class="map-controls">
                <label for="driverMapView">Map View:</label>
                <select id="driverMapView" class="map-view-selector">
                  <option value="OpenStreetMap">OpenStreetMap</option>
                  <option value="OpenStreetMap Dark">OpenStreetMap Dark</option>
                  <option value="Satellite">Satellite</option>
                  <option value="Street (Carto Light)">Street (Carto Light)</option>
                  <option value="Street (Carto Dark)">Street (Carto Dark)</option>
                  <option value="Topographic">Topographic</option>
                  <option value="Transport">Transport</option>
                </select>
              </div>
              <div id="driverMap" class="map"></div>
            </div>
          </div>
        </section>

        <!-- All Reservations List View -->
        <section id="reservationsView" class="view">
          <div class="reservations-panel">
            <h2 class="panel-title">All Reservations</h2>
            <div class="filter-bar" data-context="reservations">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="pending">Pending</button>
              <button class="filter-btn" data-filter="accepted">Accepted</button>
              <button class="filter-btn" data-filter="completed">Completed</button>
            </div>
            <div id="allReservationsList" class="reservations-table"></div>
          </div>
        </section>

        <!-- Farm-out Reservations List View -->
        <section id="farm-out_reservations_View" class="view">
          <div class="reservations-panel farmout">
            <div class="panel-header">
              <h2 class="panel-title">Farm-out Reservations</h2>
              
              <!-- Search Controls for Farmout Reservations -->
              <div class="search-section farmout-search">
                <h3 class="search-title">Search Reservations</h3>
                <div class="search-controls">
                  <div class="search-group">
                    <label for="farmoutSearchFor">Search For</label>
                    <input type="text" id="farmoutSearchFor" placeholder="Enter search term..." class="search-input">
                  </div>
                  <div class="search-group">
                    <label for="farmoutSearchIn">Search In</label>
                    <select id="farmoutSearchIn" class="search-select">
                      <option value="all">All Fields</option>
                      <option value="confirmation">Confirmation #</option>
                      <option value="passenger">Passenger Name</option>
                      <option value="company">Company</option>
                      <option value="driver">Driver Name</option>
                      <option value="pickup">Pickup Location</option>
                      <option value="dropoff">Dropoff Location</option>
                    </select>
                  </div>
                  <div class="search-group">
                    <label for="farmoutDateFrom">Date From</label>
                    <input type="date" id="farmoutDateFrom" class="search-input">
                  </div>
                  <div class="search-group">
                    <label for="farmoutDateTo">Date To</label>
                    <input type="date" id="farmoutDateTo" class="search-input">
                  </div>
                  <div class="search-group">
                    <label for="farmoutSortBy">Sort By</label>
                    <select id="farmoutSortBy" class="search-select">
                      <option value="pickup_datetime">PU Date</option>
                      <option value="confirmation_number">Confirmation #</option>
                      <option value="passenger_name">Passenger Name</option>
                      <option value="company_name">Company</option>
                      <option value="grand_total">Amount</option>
                      <option value="status">Status</option>
                    </select>
                  </div>
                  <div class="search-group">
                    <label for="farmoutOrderBy">Order By</label>
                    <select id="farmoutOrderBy" class="search-select">
                      <option value="asc">Ascending</option>
                      <option value="desc">Descending</option>
                    </select>
                  </div>
                  <div class="search-group">
                    <label for="farmoutPageSize">Page Size</label>
                    <select id="farmoutPageSize" class="search-select">
                      <option value="25">25</option>
                      <option value="50">50</option>
                      <option value="75" selected>75</option>
                      <option value="100">100</option>
                      <option value="150">150</option>
                      <option value="200">200</option>
                    </select>
                  </div>
                  <div class="search-group search-buttons">
                    <button id="farmoutSearchBtn" class="btn btn-primary">SEARCH</button>
                    <button id="farmoutClearSearchBtn" class="btn btn-secondary">CLEAR</button>
                  </div>
                </div>
                <div class="search-results-info">
                  <span id="farmoutResultCount">Showing all reservations</span>
                </div>
              </div>
              
              <div class="farmout-toolbar">
                <div class="toolbar-group">
                  <label for="farmoutStatusFilter">Status</label>
                  <select id="farmoutStatusFilter">
                    <option value="all">All</option>
                    <option value="unassigned">Unassigned</option>
                    <option value="offered">Offered</option>
                    <option value="offered_to_affiliate">Offered to Affiliate</option>
                    <option value="assigned">Assigned</option>
                    <option value="affiliate_assigned">Affiliate Assigned</option>
                    <option value="affiliate_driver_assigned">Affiliate Driver Assigned</option>
                    <option value="declined">Declined</option>
                    <option value="enroute">En Route</option>
                    <option value="driver_en_route">Driver En Route</option>
                    <option value="on_the_way">Driver On The Way</option>
                    <option value="arrived">Arrived</option>
                    <option value="driver_waiting_at_pickup">Driver Waiting at Pickup</option>
                    <option value="waiting_at_pickup">Waiting at Pickup</option>
                    <option value="passenger_onboard">Passenger Onboard</option>
                    <option value="driver_circling">Driver Circling</option>
                    <option value="customer_in_car">Customer In Car</option>
                    <option value="driving_passenger">Driving Passenger</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="cancelled_by_affiliate">Cancelled by Affiliate</option>
                    <option value="late_cancel">Late Cancel</option>
                    <option value="late_cancelled">Late Cancelled</option>
                    <option value="no_show">No Show</option>
                    <option value="covid19_cancellation">COVID-19 Cancellation</option>
                    <option value="in_house">In House</option>
                  </select>
                </div>
                <div class="toolbar-group">
                  <label for="farmoutModeFilter">Mode</label>
                  <select id="farmoutModeFilter">
                    <option value="all">All</option>
                    <option value="manual">Manual</option>
                    <option value="automatic">Automatic</option>
                  </select>
                </div>
                <div class="toolbar-actions">
                  <button id="farmoutRefreshMap" class="btn btn-secondary">Refresh Map</button>
                  <button id="farmoutAvailabilityBtn" class="btn btn-secondary">Driver Availability</button>
                  <button id="farmoutTripStatusBtn" class="btn btn-secondary">Driver Trip Status</button>
                </div>
              </div>
            </div>
            <div class="farmout-layout">
              <div class="farmout-table-wrapper">
                <div class="filter-bar" data-context="farmout">
                  <button class="filter-btn active" data-filter="all">All</button>
                  <button class="filter-btn" data-filter="pending">Pending</button>
                  <button class="filter-btn" data-filter="accepted">Accepted</button>
                  <button class="filter-btn" data-filter="completed">Completed</button>
                </div>
                <div id="allReservations" class="reservations-table selectable"></div>
              </div>
              <aside id="farmoutDetailPanel" class="farmout-detail hidden">
                <div class="farmout-detail-header">
                  <div class="detail-title" id="farmoutDetailTitle">Select a reservation to manage farm-out workflow</div>
                  <span id="farmoutDetailStatus" class="status-badge pending">Pending</span>
                </div>
                <!-- Offer Status Indicator -->
                <div id="farmoutOfferStatus" class="offer-status-indicator hidden">
                  <div class="offer-status-header">
                    <span class="offer-status-icon">üì§</span>
                    <span class="offer-status-label">Offer Sent</span>
                  </div>
                  <div class="offer-status-details">
                    <div class="offer-driver-name" id="offerDriverName">Loading...</div>
                    <div class="offer-countdown-wrapper">
                      <div class="countdown-bar" id="offerCountdownBar"></div>
                      <span class="countdown-text" id="offerCountdownText">--:--</span>
                    </div>
                  </div>
                  <div class="offer-status-actions">
                    <button id="cancelOfferBtn" class="btn btn-sm btn-secondary">Cancel Offer</button>
                    <button id="resendOfferBtn" class="btn btn-sm btn-secondary">Resend</button>
                  </div>
                </div>
                <div class="farmout-detail-body">
                  <div class="detail-row">
                    <label>Farm-out Mode</label>
                    <div class="mode-toggle" id="farmoutModeToggle">
                      <button data-mode="manual" class="btn btn-secondary active">Manual</button>
                      <button data-mode="automatic" class="btn btn-secondary">Automatic</button>
                    </div>
                  </div>
                  <div class="detail-row">
                    <label for="farmoutDriverSelect">Driver Assignment</label>
                    <div class="driver-assignment">
                      <select id="farmoutDriverSelect">
                        <option value="">Select available driver</option>
                      </select>
                      <div class="assignment-actions">
                        <button id="farmoutAssignBtn" class="btn btn-success">Assign Driver</button>
                        <button id="farmoutClearBtn" class="btn btn-secondary">Clear</button>
                      </div>
                    </div>
                  </div>
                  <div class="detail-row">
                    <label>Driver Snapshot</label>
                    <div id="farmoutDriverSnapshot" class="snapshot-card empty">
                      <p>No driver assigned.</p>
                    </div>
                  </div>
                  <div class="detail-row">
                    <label>Quick Actions</label>
                    <div class="farmout-actions">
                      <button id="farmoutSendOffer" class="btn btn-secondary">Send SMS Offer</button>
                      <button id="farmoutCopyLink" class="btn btn-secondary">Copy Trip Link</button>
                    </div>
                  </div>
                  <div class="detail-row">
                    <label>Automation Status</label>
                    <div id="farmoutAutomationStatus" class="automation-status">Auto-dispatch inactive for this trip</div>
                  </div>
                  <div class="detail-row automation-controls">
                    <label>Auto-dispatch Settings</label>
                    <div class="automation-settings">
                      <div class="automation-field">
                        <span class="field-label">Driver retry cadence (minutes)</span>
                        <input id="farmoutAutoInterval" type="number" min="1" max="60" step="1" value="5" />
                      </div>
                      <div class="automation-field">
                        <span class="field-label">Admin/Dispatch escalation recipients</span>
                        <textarea id="farmoutAdminRecipients" rows="4" placeholder="admin@example.com | +15551234567"></textarea>
                        <p class="field-hint">Enter one per line. Use a pipe `|` to add a phone number. Known directory IDs or emails auto-resolve.</p>
                      </div>
                    </div>
                  </div>
                  <div class="detail-row">
                    <label>Farm-out Activity</label>
                    <div id="farmoutActivityLog" class="activity-log"></div>
                  </div>
                </div>
              </aside>
            </div>
          </div>
        </section>

        <!-- Availability Console View -->
        <section id="availabilityView" class="view" style="height:calc(100vh - 100px);">
          <iframe src="driver-availability.html" style="width:100%;height:100%;border:none;" title="Availability Console"></iframe>
        </section>

        <!-- Active Drivers View -->
        <section id="activeDriversView" class="view" style="height:calc(100vh - 100px);">
          <iframe src="driver-active-list.html" style="width:100%;height:100%;border:none;" title="Active Drivers"></iframe>
        </section>

        <!-- Trip Monitor View -->
        <section id="tripMonitorView" class="view" style="height:calc(100vh - 100px);">
          <iframe src="driver-trip-monitor.html" style="width:100%;height:100%;border:none;" title="Trip Monitor"></iframe>
        </section>

        <!-- Reservations Iframe View -->
        <section id="reservationsIframeView" class="view" style="height:calc(100vh - 100px);">
          <iframe src="reservations-list.html" style="width:100%;height:100%;border:none;" title="Reservations"></iframe>
        </section>
      </main>
    </div>

    <!-- Reservation Popup Modal for Double-Click -->
    <div id="reservationPopupModal" class="reservation-popup-overlay" style="display: none;" onclick="window.closeReservationPopup && window.closeReservationPopup()">
      <div class="reservation-popup-container" onclick="event.stopPropagation()">
        <div class="reservation-popup-header">
          <span id="reservationPopupTitle" class="reservation-popup-title">Reservation</span>
          <button type="button" id="reservationPopupClose" class="reservation-popup-close" title="Close" onclick="window.closeReservationPopup && window.closeReservationPopup()">√ó</button>
        </div>
        <iframe id="reservationPopupFrame" class="reservation-popup-frame" src="" title="Reservation Form"></iframe>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Driver Email Queue Service for assignment notifications -->
    <script src="DriverEmailQueueService.js"></script>
    <script type="module" src="main.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ChatManager.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ImageGenerator.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ProgressLogger.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/OGP.js"></script>
  </body>
</html>