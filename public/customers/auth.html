<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>Customer Login | RELIALIMO</title>
  <link rel="icon" href="favicon.ico">
  <link rel="manifest" href="customer-portal-manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="customer-portal.css">
  <!-- Load env.js synchronously before any modules -->
  <script src="/shared/env.js"></script>
</head>
<body>
  <div id="app">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active" style="background: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.3) 0%, rgba(26, 26, 46, 0.9) 50%, #1a1a2e 100%);">
      <div class="loading-content">
        <div class="logo-pulse" style="filter: drop-shadow(0 0 40px rgba(99, 102, 241, 0.6));"><img src="https://siumiadylwcrkaqsfwkj.supabase.co/storage/v1/object/public/images/reliabull%20limo%20logowhitecropped.png" alt="RELIALIMO" class="auth-logo" style="max-height: 70px; width: auto;"></div>
        <p style="font-size: 1.2rem; margin-top: 0.75rem; text-shadow: 0 0 15px rgba(99, 102, 241, 0.6); color: white;">Customer Portal</p>
        <div class="loading-spinner"></div>
      </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="screen">
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header" style="filter: drop-shadow(0 0 25px rgba(99, 102, 241, 0.4)); margin-bottom: 16px;">
            <img src="https://siumiadylwcrkaqsfwkj.supabase.co/storage/v1/object/public/images/reliabull%20limo%20logowhitecropped.png" 
                 alt="RELIALIMO" 
                 class="auth-logo"
                 style="max-height: 55px; width: auto;">
            <p class="auth-subtitle" style="font-size: 1rem; margin-top: 0.5rem; color: rgba(255,255,255,0.7);">Customer Portal</p>
          </div>

          <!-- Login Form -->
          <div id="loginForm" class="auth-form active">
            <h2 class="auth-title">Welcome Back</h2>
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <div class="password-input-wrapper">
                <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                <button type="button" class="password-toggle" data-target="loginPassword" aria-label="Show password">
                  <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
              <div class="form-options">
                <label class="remember-me-label">
                  <input type="checkbox" id="rememberMe" checked>
                  <span>Remember me for 30 days</span>
                </label>
                <a href="#" id="forgotPasswordLink" class="forgot-password-link">Forgot Password?</a>
              </div>
            </div>
            <button type="button" id="loginBtn" class="auth-btn auth-btn-primary">
              Sign In
            </button>
            <div class="auth-switch">
              <span>New customer?</span>
              <button type="button" id="showRegisterBtn" class="btn-link">Create Account</button>
            </div>
          </div>

          <!-- Registration Form -->
          <div id="registerForm" class="auth-form">
            <h2 class="auth-title">Create Account</h2>
            <div class="form-row" style="display: flex; gap: 12px;">
              <div class="form-group" style="flex: 1;">
                <label for="regFirstName">First Name*</label>
                <input type="text" id="regFirstName" placeholder="John" autocomplete="given-name">
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="regLastName">Last Name*</label>
                <input type="text" id="regLastName" placeholder="Smith" autocomplete="family-name">
              </div>
            </div>
            <div class="form-group">
              <label for="regEmail">Email Address*</label>
              <input type="email" id="regEmail" placeholder="your@email.com" autocomplete="email">
              <span id="emailError" class="field-error" style="color: #ef4444; font-size: 12px; display: none;"></span>
              <span id="emailValid" class="field-valid" style="color: #22c55e; font-size: 12px; display: none;">‚úì Valid email format</span>
            </div>
            <div class="form-group">
              <label for="regPhone">Phone Number*</label>
              <input type="tel" id="regPhone" placeholder="(555) 123-4567" autocomplete="tel">
              <span id="phoneError" class="field-error" style="color: #ef4444; font-size: 12px; display: none;"></span>
              <span id="phoneValid" class="field-valid" style="color: #22c55e; font-size: 12px; display: none;">‚úì Valid phone number</span>
            </div>
            <div class="form-group">
              <label for="regPassword">Password*</label>
              <div class="password-input-wrapper">
                <input type="password" id="regPassword" placeholder="Min. 8 characters" autocomplete="new-password">
                <button type="button" class="password-toggle" data-target="regPassword" aria-label="Show password">
                  <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label for="regPasswordConfirm">Confirm Password*</label>
              <div class="password-input-wrapper">
                <input type="password" id="regPasswordConfirm" placeholder="Confirm password" autocomplete="new-password">
                <button type="button" class="password-toggle" data-target="regPasswordConfirm" aria-label="Show password">
                  <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
            </div>
            <button type="button" id="registerBtn" class="auth-btn auth-btn-primary">
              Create Account
            </button>
            <div class="auth-switch">
              <span>Already have an account?</span>
              <button type="button" id="showLoginBtn" class="btn-link">Sign In</button>
            </div>
          </div>

          <!-- Phone OTP Verification Form -->
          <div id="phoneVerifyForm" class="auth-form">
            <h2 class="auth-title">Verify Your Phone</h2>
            <p class="form-description" style="color: #a0aec0; margin-bottom: 20px;">
              We've sent a 6-digit code to <strong id="otpPhoneDisplay" style="color: #fff;"></strong>
            </p>
            <div class="form-group">
              <label for="otpCode">Enter Verification Code</label>
              <div class="otp-input-container" style="display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: nowrap;">
                <input type="text" id="otp1" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
                <input type="text" id="otp2" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
                <input type="text" id="otp3" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
                <input type="text" id="otp4" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
                <input type="text" id="otp5" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
                <input type="text" id="otp6" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" style="width: 48px; height: 56px; text-align: center; font-size: 28px; font-weight: 700; line-height: 56px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; padding: 0; box-sizing: border-box;">
              </div>
              <span id="otpError" class="field-error" style="color: #ef4444; font-size: 14px; display: none; text-align: center;"></span>
            </div>
            <button type="button" id="verifyOtpBtn" class="auth-btn auth-btn-primary">
              Verify Phone
            </button>
            <div class="otp-actions" style="text-align: center; margin-top: 20px;">
              <p id="otpTimer" style="color: #718096; font-size: 14px;">Resend code in <span id="otpCountdown">60</span>s</p>
              <button type="button" id="resendOtpBtn" class="btn-link" style="color: #6366f1; display: none;">
                Didn't receive code? Resend
              </button>
            </div>
            <div class="auth-switch" style="margin-top: 20px;">
              <button type="button" id="changePhoneBtn" class="btn-link" style="color: #a0aec0;">
                ‚Üê Change phone number
              </button>
            </div>
          </div>

          <!-- Forgot Password Form -->
          <div id="forgotPasswordForm" class="auth-form">
            <h2 class="auth-title">Reset Password</h2>
            <p class="form-description">Enter your email and we'll send you a password reset link.</p>
            <div class="form-group">
              <label for="resetEmail">Email Address</label>
              <input type="email" id="resetEmail" placeholder="your@email.com" autocomplete="email">
            </div>
            <button type="button" id="resetPasswordBtn" class="auth-btn auth-btn-primary">
              Send Reset Link
            </button>
            <div class="auth-switch">
              <button type="button" id="backToLoginBtn" class="btn-link">‚Üê Back to Sign In</button>
            </div>
          </div>
          
          <div class="auth-footer">
            <a href="https://relialimo.com">relialimo.com</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>
  </div>

  <script type="module">
    import { getSupabaseCredentials } from '/shared/supabase-config.js';
    import CustomerAuth from './customer-auth-service.js';
    
    // ========== VALIDATION FUNCTIONS ==========
    
    // RFC 5322 compliant email validation
    function isValidEmail(email) {
      const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
      if (!email || email.length > 254) return false;
      if (!emailRegex.test(email)) return false;
      // Check for valid TLD (at least 2 chars)
      const parts = email.split('@');
      if (parts.length !== 2) return false;
      const domain = parts[1];
      const domainParts = domain.split('.');
      if (domainParts.length < 2) return false;
      const tld = domainParts[domainParts.length - 1];
      if (tld.length < 2) return false;
      return true;
    }
    
    // Phone number validation (US format + international)
    function isValidPhone(phone) {
      if (!phone) return false;
      // Remove all non-digit characters
      const digits = phone.replace(/\D/g, '');
      // US numbers: 10 digits, or 11 with leading 1
      if (digits.length === 10) return true;
      if (digits.length === 11 && digits.startsWith('1')) return true;
      // International: 11-15 digits
      if (digits.length >= 11 && digits.length <= 15) return true;
      return false;
    }
    
    // Format phone for display
    function formatPhoneDisplay(phone) {
      const digits = phone.replace(/\D/g, '');
      if (digits.length === 10) {
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
      if (digits.length === 11 && digits.startsWith('1')) {
        return `+1 (${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
      }
      return phone;
    }
    
    // Format phone for E.164 (API calls)
    function formatPhoneE164(phone) {
      const digits = phone.replace(/\D/g, '');
      if (digits.length === 10) return `+1${digits}`;
      if (digits.length === 11 && digits.startsWith('1')) return `+${digits}`;
      if (!phone.startsWith('+')) return `+${digits}`;
      return phone;
    }
    
    // ========== OTP MANAGEMENT ==========
    
    let pendingRegistration = null;
    let otpCode = null;
    let otpExpiry = null;
    let otpCountdownInterval = null;
    
    // Generate 6-digit OTP
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    // Send OTP via SMS
    async function sendOTP(phone) {
      otpCode = generateOTP();
      otpExpiry = Date.now() + 10 * 60 * 1000; // 10 minutes
      
      const formattedPhone = formatPhoneE164(phone);
      const message = `Your RELIALIMO verification code is: ${otpCode}. This code expires in 10 minutes. Do not share this code.`;
      
      try {
        // Use the SMS service endpoint
        const response = await fetch('/api/sms-send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: formattedPhone, body: message })
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Failed to send SMS');
        }
        
        console.log('‚úÖ OTP sent to', formattedPhone);
        return true;
      } catch (error) {
        console.error('Failed to send OTP:', error);
        // For development: log the code
        console.log('üì± OTP Code (for testing):', otpCode);
        return true; // Continue anyway for dev
      }
    }
    
    // Verify OTP
    function verifyOTP(enteredCode) {
      if (!otpCode || !otpExpiry) return { valid: false, error: 'No OTP found. Please request a new code.' };
      if (Date.now() > otpExpiry) return { valid: false, error: 'Code expired. Please request a new code.' };
      if (enteredCode !== otpCode) return { valid: false, error: 'Invalid code. Please try again.' };
      return { valid: true };
    }
    
    // Start countdown timer
    function startOTPCountdown(seconds = 60) {
      let remaining = seconds;
      const timerEl = document.getElementById('otpTimer');
      const countdownEl = document.getElementById('otpCountdown');
      const resendBtn = document.getElementById('resendOtpBtn');
      
      if (timerEl) timerEl.style.display = 'block';
      if (resendBtn) resendBtn.style.display = 'none';
      
      if (otpCountdownInterval) clearInterval(otpCountdownInterval);
      
      otpCountdownInterval = setInterval(() => {
        remaining--;
        if (countdownEl) countdownEl.textContent = remaining;
        
        if (remaining <= 0) {
          clearInterval(otpCountdownInterval);
          if (timerEl) timerEl.style.display = 'none';
          if (resendBtn) resendBtn.style.display = 'inline-block';
        }
      }, 1000);
    }
    
    // Setup OTP input auto-focus
    function setupOTPInputs() {
      const inputs = document.querySelectorAll('.otp-digit');
      inputs.forEach((input, index) => {
        input.value = '';
        
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value.slice(0, 1);
          
          if (value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
          
          // Auto-verify when all digits entered
          if (index === inputs.length - 1 && value) {
            const fullCode = Array.from(inputs).map(i => i.value).join('');
            if (fullCode.length === 6) {
              document.getElementById('verifyOtpBtn')?.click();
            }
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
        
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 6);
          digits.split('').forEach((digit, i) => {
            if (inputs[i]) inputs[i].value = digit;
          });
          if (digits.length === 6) {
            document.getElementById('verifyOtpBtn')?.click();
          }
        });
      });
    }
    
    // Get full OTP from inputs
    function getOTPFromInputs() {
      const inputs = document.querySelectorAll('.otp-digit');
      return Array.from(inputs).map(i => i.value).join('');
    }
    
    // ========== REAL-TIME VALIDATION ==========
    
    document.getElementById('regEmail')?.addEventListener('blur', function() {
      const email = this.value.trim();
      const errorEl = document.getElementById('emailError');
      const validEl = document.getElementById('emailValid');
      
      if (!email) {
        errorEl.style.display = 'none';
        validEl.style.display = 'none';
        return;
      }
      
      if (isValidEmail(email)) {
        errorEl.style.display = 'none';
        validEl.style.display = 'block';
        this.style.borderColor = '#22c55e';
      } else {
        validEl.style.display = 'none';
        errorEl.textContent = 'Please enter a valid email address';
        errorEl.style.display = 'block';
        this.style.borderColor = '#ef4444';
      }
    });
    
    document.getElementById('regEmail')?.addEventListener('input', function() {
      this.style.borderColor = '';
      document.getElementById('emailError').style.display = 'none';
      document.getElementById('emailValid').style.display = 'none';
    });
    
    document.getElementById('regPhone')?.addEventListener('blur', function() {
      const phone = this.value.trim();
      const errorEl = document.getElementById('phoneError');
      const validEl = document.getElementById('phoneValid');
      
      if (!phone) {
        errorEl.style.display = 'none';
        validEl.style.display = 'none';
        return;
      }
      
      if (isValidPhone(phone)) {
        errorEl.style.display = 'none';
        validEl.style.display = 'block';
        this.style.borderColor = '#22c55e';
        // Format the phone number
        this.value = formatPhoneDisplay(phone);
      } else {
        validEl.style.display = 'none';
        errorEl.textContent = 'Please enter a valid phone number (10+ digits)';
        errorEl.style.display = 'block';
        this.style.borderColor = '#ef4444';
      }
    });
    
    document.getElementById('regPhone')?.addEventListener('input', function() {
      this.style.borderColor = '';
      document.getElementById('phoneError').style.display = 'none';
      document.getElementById('phoneValid').style.display = 'none';
    });
    
    // Check if already authenticated and redirect
    async function checkAuth() {
      // Check for logout parameter - force logout if present
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('logout') === 'true') {
        // Force clear all customer auth data from localStorage
        const keysToRemove = [
          'customer_session', 
          'current_customer', 
          'customer_remember_me',
          'customer_refresh_token',
          'customer_last_activity',
          'pending_verifications'
        ];
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Also try using auth service if available
        try { await CustomerAuth.logout(false); } catch(e) {}
        
        // Clear the logout parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        console.log('‚úÖ Logged out and cleared session');
        return false;
      }
      
      const isAuth = await CustomerAuth.initAuth();
      if (isAuth) {
        const slug = CustomerAuth.getPortalSlug();
        window.location.href = slug ? `/${slug}` : '/';
        return true;
      }
      return false;
    }

    async function init() {
      const isAuth = await checkAuth();
      if (!isAuth) {
        document.getElementById('loadingScreen').classList.remove('active');
        document.getElementById('authScreen').classList.add('active');
      }
    }

    // Toggle forms
    document.getElementById('showRegisterBtn')?.addEventListener('click', () => {
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('registerForm').classList.add('active');
    });

    document.getElementById('showLoginBtn')?.addEventListener('click', () => {
      document.getElementById('registerForm').classList.remove('active');
      document.getElementById('forgotPasswordForm').classList.remove('active');
      document.getElementById('loginForm').classList.add('active');
    });

    document.getElementById('forgotPasswordLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('forgotPasswordForm').classList.add('active');
    });

    document.getElementById('backToLoginBtn')?.addEventListener('click', () => {
      document.getElementById('forgotPasswordForm').classList.remove('active');
      document.getElementById('loginForm').classList.add('active');
    });

    // Password toggle
    document.querySelectorAll('.password-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const input = document.getElementById(targetId);
        const eyeOpen = btn.querySelector('.eye-open');
        const eyeClosed = btn.querySelector('.eye-closed');
        if (input.type === 'password') {
          input.type = 'text';
          if (eyeOpen) eyeOpen.style.display = 'none';
          if (eyeClosed) eyeClosed.style.display = 'block';
        } else {
          input.type = 'password';
          if (eyeOpen) eyeOpen.style.display = 'block';
          if (eyeClosed) eyeClosed.style.display = 'none';
        }
      });
    });

    // Login handler - using the centralized auth service
    document.getElementById('loginBtn')?.addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe')?.checked || false;

      if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
      }

      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Signing In...';

      try {
        const { session, customer } = await CustomerAuth.login(email, password, rememberMe);
        
        showToast('Welcome back!', 'success');
        
        // Get the portal slug directly from the customer object returned by login
        const slug = customer?.portal_slug || 
          `${(customer?.first_name || '').toLowerCase()}_${(customer?.last_name || '').toLowerCase()}`.replace(/[^a-z0-9_]/g, '') ||
          CustomerAuth.getPortalSlug();
        
        setTimeout(() => {
          window.location.href = slug ? `/${slug}` : '/';
        }, 500);

      } catch (err) {
        console.error('Login error:', err);
        showToast(err.message || 'Login failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });

    // Registration handler - Step 1: Validate and send OTP
    document.getElementById('registerBtn')?.addEventListener('click', async () => {
      const firstName = document.getElementById('regFirstName').value.trim();
      const lastName = document.getElementById('regLastName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;

      if (!firstName || !lastName || !email || !phone || !password) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      // Validate email format
      if (!isValidEmail(email)) {
        showToast('Please enter a valid email address', 'error');
        document.getElementById('regEmail').focus();
        return;
      }

      // Validate phone format
      if (!isValidPhone(phone)) {
        showToast('Please enter a valid phone number', 'error');
        document.getElementById('regPhone').focus();
        return;
      }

      if (password !== passwordConfirm) {
        showToast('Passwords do not match', 'error');
        return;
      }

      if (password.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
      }

      const btn = document.getElementById('registerBtn');
      btn.disabled = true;
      btn.textContent = 'Sending verification code...';

      try {
        // Store pending registration data
        pendingRegistration = { firstName, lastName, email, phone, password };
        
        // Send OTP to phone
        await sendOTP(phone);
        
        // Show phone verification form
        document.getElementById('registerForm').classList.remove('active');
        document.getElementById('phoneVerifyForm').classList.add('active');
        document.getElementById('otpPhoneDisplay').textContent = formatPhoneDisplay(phone);
        
        // Setup OTP inputs and start countdown
        setupOTPInputs();
        startOTPCountdown(60);
        document.getElementById('otp1').focus();
        
        showToast('Verification code sent!', 'success');
        
      } catch (err) {
        console.error('Failed to send OTP:', err);
        showToast('Failed to send verification code. Please try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });
    
    // OTP Verification handler - Step 2: Verify and complete registration
    document.getElementById('verifyOtpBtn')?.addEventListener('click', async () => {
      const enteredCode = getOTPFromInputs();
      const errorEl = document.getElementById('otpError');
      
      if (enteredCode.length !== 6) {
        errorEl.textContent = 'Please enter all 6 digits';
        errorEl.style.display = 'block';
        return;
      }
      
      const verification = verifyOTP(enteredCode);
      if (!verification.valid) {
        errorEl.textContent = verification.error;
        errorEl.style.display = 'block';
        // Clear inputs on error
        document.querySelectorAll('.otp-digit').forEach(i => i.value = '');
        document.getElementById('otp1').focus();
        return;
      }
      
      errorEl.style.display = 'none';
      
      const btn = document.getElementById('verifyOtpBtn');
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      
      try {
        // Phone verified! Now complete registration
        const { firstName, lastName, email, phone, password } = pendingRegistration;
        const creds = getSupabaseCredentials();
        
        // Create auth user
        const authResponse = await fetch(`${creds.url}/auth/v1/signup`, {
          method: 'POST',
          headers: {
            'apikey': creds.anonKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            email, 
            password,
            data: { first_name: firstName, last_name: lastName }
          })
        });

        const authData = await authResponse.json();

        if (!authResponse.ok) {
          throw new Error(authData.error_description || authData.msg || 'Registration failed');
        }

        // Create customer record in accounts table
        const uniqueId = crypto.randomUUID().split('-')[0];
        const portalSlug = `${firstName}_${lastName}_${uniqueId}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');
        const customerData = {
          first_name: firstName,
          last_name: lastName,
          email: email.toLowerCase(),
          phone: formatPhoneE164(phone),
          portal_slug: portalSlug,
          customer_type: 'individual',
          is_active: true,
          email_verified: false,
          phone_verified: true, // Phone is now verified!
          onboarding_complete: false,
          created_at: new Date().toISOString()
        };

        const token = authData.access_token || creds.anonKey;
        const createResp = await fetch(`${creds.url}/rest/v1/accounts`, {
          method: 'POST',
          headers: {
            'apikey': creds.anonKey,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(customerData)
        });

        if (createResp.ok) {
          const newCustomers = await createResp.json();
          if (newCustomers && newCustomers.length > 0) {
            localStorage.setItem('current_customer', JSON.stringify(newCustomers[0]));
          }
        }

        // Send verification email
        btn.textContent = 'Sending verification email...';
        await sendVerificationEmail(email, firstName, lastName, phone, portalSlug, creds);

        // Store session if available
        if (authData.access_token) {
          localStorage.setItem('customer_session', JSON.stringify(authData));
        }
        
        // Clear pending registration
        pendingRegistration = null;
        otpCode = null;
        
        // Show success message
        showToast('Account created! Please verify your email.', 'success');
        
        // Show verification pending UI
        document.getElementById('phoneVerifyForm').classList.remove('active');
        document.getElementById('registerForm').classList.add('active');
        showVerificationPendingUI(email, firstName);

      } catch (err) {
        console.error('Registration error:', err);
        showToast(err.message || 'Registration failed', 'error');
        btn.disabled = false;
        btn.textContent = 'Verify Phone';
      }
    });
    
    // Resend OTP handler
    document.getElementById('resendOtpBtn')?.addEventListener('click', async () => {
      if (!pendingRegistration) return;
      
      const btn = document.getElementById('resendOtpBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';
      
      try {
        await sendOTP(pendingRegistration.phone);
        setupOTPInputs();
        startOTPCountdown(60);
        document.getElementById('otp1').focus();
        showToast('New code sent!', 'success');
      } catch (err) {
        showToast('Failed to resend code', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = "Didn't receive code? Resend";
      }
    });
    
    // Change phone number handler
    document.getElementById('changePhoneBtn')?.addEventListener('click', () => {
      // Go back to registration form
      document.getElementById('phoneVerifyForm').classList.remove('active');
      document.getElementById('registerForm').classList.add('active');
      document.getElementById('registerBtn').disabled = false;
      document.getElementById('registerBtn').textContent = 'Create Account';
      
      // Clear OTP state
      if (otpCountdownInterval) clearInterval(otpCountdownInterval);
      otpCode = null;
      otpExpiry = null;
    });
    
    // Send verification email function
    async function sendVerificationEmail(email, firstName, lastName, phone, portalSlug, creds) {
      // Generate verification token
      const token = generateToken();
      const verificationUrl = `https://account.relialimo.com/verify?token=${token}&email=${encodeURIComponent(email)}&redirect=${encodeURIComponent(portalSlug)}`;
      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
      
      // Store verification token in Supabase
      try {
        await fetch(`${creds.url}/rest/v1/customer_email_verifications`, {
          method: 'POST',
          headers: {
            'apikey': creds.anonKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email.toLowerCase(),
            token,
            expires_at: expiresAt,
            user_data: { firstName, lastName, portalSlug, phone },
            verified: false,
            created_at: new Date().toISOString()
          })
        });
      } catch (e) {
        console.warn('Failed to store verification token:', e);
      }
      
      // Send verification email via API
      const subject = 'Welcome to RELIALIMO - Verify Your Email';
      const html = `
        <!DOCTYPE html>
        <html>
        <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
        <body style="margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; background: #1a1a2e;">
          <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
            <tr>
              <td align="center" style="padding: 40px 20px;">
                <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="background: linear-gradient(135deg, #1e1e3f 0%, #252549 100%); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                  <tr>
                    <td align="center" style="padding: 40px 40px 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);">
                      <img src="https://siumiadylwcrkaqsfwkj.supabase.co/storage/v1/object/public/images/reliabull%20limo%20logowhitecropped.png" alt="RELIALIMO" style="max-width: 200px; height: auto;">
                    </td>
                  </tr>
                  <tr>
                    <td style="padding: 30px 40px;">
                      <h1 style="color: #fff; font-size: 28px; margin: 0 0 10px; text-align: center;">Welcome, ${firstName}! üéâ</h1>
                      <p style="color: #a0aec0; font-size: 16px; line-height: 1.6; margin: 0 0 30px; text-align: center;">Thank you for creating your RELIALIMO account. Please verify your email address to complete your account setup.</p>
                      <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
                        <tr>
                          <td align="center">
                            <a href="${verificationUrl}" style="display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; text-decoration: none; padding: 16px 40px; border-radius: 12px; font-size: 18px; font-weight: 600; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);">‚úÖ Verify My Email</a>
                          </td>
                        </tr>
                      </table>
                      <p style="color: #718096; font-size: 14px; line-height: 1.6; margin: 30px 0 0; text-align: center;">This link will expire in 24 hours. If you didn't create this account, you can safely ignore this email.</p>
                      <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <p style="color: #a0aec0; font-size: 12px; margin: 0 0 10px;">Having trouble with the button? Copy and paste this link:</p>
                        <p style="color: #6366f1; font-size: 12px; word-break: break-all; margin: 0;">${verificationUrl}</p>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td style="padding: 20px 40px 30px; border-top: 1px solid rgba(255,255,255,0.1);">
                      <p style="color: #718096; font-size: 12px; margin: 0; text-align: center;">Your portal URL after verification:<br><strong style="color: #a0aec0;">https://account.relialimo.com/${portalSlug}</strong></p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
        </html>
      `;
      
      try {
        await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: email, subject, html })
        });
        console.log('‚úÖ Verification email sent');
      } catch (e) {
        console.error('Failed to send verification email:', e);
        // Show the verification URL in console for development
        console.log('üìß Verification URL (for testing):', verificationUrl);
      }
    }
    
    // Generate secure token
    function generateToken() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }
    
    // Show verification pending UI
    function showVerificationPendingUI(email, firstName) {
      const registerForm = document.getElementById('registerForm');
      registerForm.innerHTML = `
        <div class="verification-pending" style="text-align: center; padding: 20px;">
          <div style="font-size: 64px; margin-bottom: 20px;">üìß</div>
          <h2 class="auth-title" style="color: #22c55e;">Check Your Email!</h2>
          <p style="color: #a0aec0; margin-bottom: 20px;">
            We've sent a verification link to:<br>
            <strong style="color: #fff;">${email}</strong>
          </p>
          <p style="color: #718096; font-size: 14px; margin-bottom: 30px;">
            Click the link in the email to verify your account and complete your setup with:
          </p>
          <div style="background: rgba(99, 102, 241, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #e2e8f0;">
              <span>üè†</span> <span>Home address setup</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #e2e8f0;">
              <span>‚úàÔ∏è</span> <span>Nearby airport selection</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #e2e8f0;">
              <span>üì±</span> <span>Phone number verification</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; color: #e2e8f0;">
              <span>üí≥</span> <span>Payment method (optional)</span>
            </div>
          </div>
          <button type="button" class="btn-link" onclick="resendVerificationEmail('${email}', '${firstName}')" style="color: #6366f1; text-decoration: underline;">
            Didn't receive the email? Resend
          </button>
          <br><br>
          <button type="button" class="btn-link" id="backToLoginFromVerify" style="color: #a0aec0;">
            Already verified? Sign in
          </button>
        </div>
      `;
      
      document.getElementById('backToLoginFromVerify')?.addEventListener('click', () => {
        window.location.reload();
      });
    }
    
    // Resend verification email
    window.resendVerificationEmail = async function(email, firstName) {
      const creds = getSupabaseCredentials();
      showToast('Resending verification email...', 'info');
      
      try {
        // Get existing user data from stored verification
        const resp = await fetch(
          `${creds.url}/rest/v1/customer_email_verifications?email=eq.${encodeURIComponent(email.toLowerCase())}&order=created_at.desc&limit=1`,
          { headers: { 'apikey': creds.anonKey } }
        );
        
        let lastName = '';
        let phone = '';
        
        if (resp.ok) {
          const records = await resp.json();
          if (records.length > 0 && records[0].user_data) {
            lastName = records[0].user_data.lastName || '';
            phone = records[0].user_data.phone || '';
          }
        }
        
        await sendVerificationEmail(email, firstName, lastName, phone, creds);
        showToast('Verification email sent!', 'success');
      } catch (e) {
        showToast('Failed to resend. Please try again.', 'error');
      }
    };

    // Password reset handler - using auth service
    document.getElementById('resetPasswordBtn')?.addEventListener('click', async () => {
      const email = document.getElementById('resetEmail').value.trim();
      
      if (!email) {
        showToast('Please enter your email', 'error');
        return;
      }

      const btn = document.getElementById('resetPasswordBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        await CustomerAuth.sendPasswordReset(email);

        showToast('Reset link sent! Check your email.', 'success');
        setTimeout(() => {
          document.getElementById('forgotPasswordForm').classList.remove('active');
          document.getElementById('loginForm').classList.add('active');
        }, 2000);

      } catch (err) {
        console.error('Reset error:', err);
        showToast(err.message || 'Failed to send reset link', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Reset Link';
      }
    });

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    // Enter key handlers
    document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });
    document.getElementById('regPasswordConfirm')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('registerBtn').click();
    });
    document.getElementById('resetEmail')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('resetPasswordBtn').click();
    });

    // Initialize
    init();
  </script>
</body>
</html>
