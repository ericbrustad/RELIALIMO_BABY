<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Reset password</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="../auth.css" />
    <script src="../env.js"></script>
  </head>
  <body>
    <main class="auth-shell">
      <header>
        <h1>Reset password</h1>
        <p class="auth-lede">Choose a new password to finish recovering your account.</p>
      </header>

      <form id="reset-form" class="auth-form">
        <label class="auth-label" for="new-password">New password</label>
        <input id="new-password" name="password" type="password" placeholder="New password" minlength="8" required />

        <label class="auth-label" for="confirm-password">Confirm new password</label>
        <input id="confirm-password" name="confirm" type="password" placeholder="Confirm new password" minlength="8" required />

        <button type="submit">Update password</button>
      </form>

      <p id="msg" role="status" aria-live="polite" class="auth-message"></p>
    </main>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
      import { getSupabaseCredentials } from '../supabase-config.js';

      const msg = document.getElementById('msg');

      function setMessage(text, variant = '') {
        msg.textContent = text;
        msg.classList.toggle('error', variant === 'error');
        msg.classList.toggle('success', variant === 'success');
      }

      let supabase;

      try {
        const { url: SUPABASE_URL, anonKey: SUPABASE_ANON_KEY } = getSupabaseCredentials();
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (error) {
        console.error('Supabase configuration error', error);
        setMessage('Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.', 'error');
        throw error;
      }

      async function ensureSessionFromHash() {
        const hash = window.location.hash?.startsWith('#') ? window.location.hash.slice(1) : '';
        if (!hash) return;

        const params = new URLSearchParams(hash);
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');

        if (!access_token || !refresh_token) return;

        try {
          await supabase.auth.setSession({ access_token, refresh_token });
        } catch (error) {
          console.warn('Failed to set session from hash', error);
        }
      }

      await ensureSessionFromHash();

      const resetForm = document.getElementById('reset-form');
      resetForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const password = document.getElementById('new-password').value;
        const confirm = document.getElementById('confirm-password').value;

        if (password !== confirm) {
          setMessage('Passwords do not match.', 'error');
          return;
        }

        setMessage('Updating password…');

        const { data: sessionData } = await supabase.auth.getSession();
        if (!sessionData?.session) {
          setMessage('Reset link is missing or expired. Please request a new reset email.', 'error');
          return;
        }

        const { error } = await supabase.auth.updateUser({ password });

        if (error) {
          setMessage(error.message, 'error');
          return;
        }

        setMessage('Password updated. Redirecting to sign in…', 'success');
        setTimeout(async () => {
          try {
            await supabase.auth.signOut();
          } catch {
            // ignore
          }
          window.location.replace('/auth.html');
        }, 800);
      });
    </script>
  </body>
</html>
