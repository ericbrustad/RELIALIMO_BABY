<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync Fleet Vehicles to Supabase</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    h1 { color: #333; }
    .section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 8px; }
    .status { padding: 10px; border-radius: 4px; margin: 5px 0; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    pre { background: #333; color: #0f0; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 16px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #log { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>üöó Sync Fleet Vehicles to Supabase</h1>
  <p>This tool syncs your existing localStorage fleet vehicles to the Supabase <code>fleet_vehicles</code> table.</p>
  
  <div class="section">
    <h3>Step 1: Check Local Fleet Vehicles</h3>
    <button onclick="checkLocal()">Check localStorage</button>
    <div id="localStatus"></div>
  </div>
  
  <div class="section">
    <h3>Step 2: Sync to Supabase</h3>
    <button id="syncBtn" onclick="syncAll()">Sync All to Supabase</button>
    <div id="syncStatus"></div>
  </div>
  
  <div class="section">
    <h3>Log</h3>
    <div id="log"></div>
  </div>

  <script type="module">
    import './env.js';
    
    const SUPABASE_URL = window.ENV?.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY;
    
    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      logEl.innerHTML += `<div class="status ${type}">${new Date().toLocaleTimeString()} - ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    window.checkLocal = function() {
      const fleetItems = JSON.parse(localStorage.getItem('cr_fleet') || '[]');
      const localStatus = document.getElementById('localStatus');
      
      if (!fleetItems.length) {
        localStatus.innerHTML = '<div class="status info">No fleet vehicles in localStorage</div>';
        return;
      }
      
      let html = `<div class="status success">Found ${fleetItems.length} fleet vehicles in localStorage:</div>`;
      html += '<pre>' + JSON.stringify(fleetItems, null, 2) + '</pre>';
      localStatus.innerHTML = html;
      log(`Found ${fleetItems.length} fleet vehicles in localStorage`, 'success');
    };
    
    async function getOrganizationId() {
      let orgId = window.ENV?.ORGANIZATION_ID || localStorage.getItem('relia_organization_id');
      if (!orgId) {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/vehicle_types?select=organization_id&limit=1`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
        });
        const data = await resp.json();
        if (data?.[0]?.organization_id) {
          orgId = data[0].organization_id;
          localStorage.setItem('relia_organization_id', orgId);
        }
      }
      return orgId;
    }
    
    async function syncVehicle(item, orgId) {
      const validStatuses = ['AVAILABLE', 'IN_USE', 'MAINTENANCE', 'RETIRED', 'OUT_OF_SERVICE'];
      const status = validStatuses.includes(item.status) ? item.status : 'AVAILABLE';
      const isValidUUID = (val) => val && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(val);
      
      // Ensure ID is a valid UUID - generate one if not
      let itemId = item.id;
      if (!isValidUUID(itemId)) {
        itemId = crypto.randomUUID();
        log(`‚ö†Ô∏è Item had invalid ID "${item.id}", generated new UUID: ${itemId}`, 'info');
      }
      
      const payload = {
        id: itemId,
        organization_id: orgId,
        license_plate: item.plate || null,
        vin: item.vin || null,
        year: item.year ? parseInt(item.year, 10) : null,
        make: item.make || null,
        model: item.model || null,
        vehicle_type_id: isValidUUID(item.type) ? item.type : null,
        assigned_driver_id: isValidUUID(item.driver) ? item.driver : null,
        affiliate_id: isValidUUID(item.affiliate) ? item.affiliate : null,
        status: status,
        updated_at: new Date().toISOString()
      };
      
      log(`üì§ Sending payload: ${JSON.stringify(payload)}`, 'info');
      
      const response = await fetch(`${SUPABASE_URL}/rest/v1/fleet_vehicles`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errText = await response.text();
        log(`‚ùå Error response: ${errText}`, 'error');
        throw new Error(`${response.status}: ${errText}`);
      }
      
      return await response.json();
    }
    
    window.syncAll = async function() {
      const syncBtn = document.getElementById('syncBtn');
      const syncStatus = document.getElementById('syncStatus');
      
      syncBtn.disabled = true;
      syncBtn.textContent = 'Syncing...';
      
      const fleetItems = JSON.parse(localStorage.getItem('cr_fleet') || '[]');
      
      if (!fleetItems.length) {
        syncStatus.innerHTML = '<div class="status info">No fleet vehicles to sync</div>';
        syncBtn.disabled = false;
        syncBtn.textContent = 'Sync All to Supabase';
        return;
      }
      
      log(`Starting sync of ${fleetItems.length} fleet vehicles...`);
      
      try {
        const orgId = await getOrganizationId();
        if (!orgId) {
          throw new Error('Could not determine organization_id');
        }
        log(`Using organization_id: ${orgId}`, 'info');
        
        let synced = 0;
        let failed = 0;
        
        for (const item of fleetItems) {
          try {
            await syncVehicle(item, orgId);
            synced++;
            log(`‚úÖ Synced: ${item.plate || item.make + ' ' + item.model || item.id}`, 'success');
          } catch (err) {
            failed++;
            log(`‚ùå Failed: ${item.plate || item.id} - ${err.message}`, 'error');
          }
        }
        
        syncStatus.innerHTML = `<div class="status ${failed === 0 ? 'success' : 'error'}">Sync complete: ${synced} synced, ${failed} failed</div>`;
        log(`Sync complete: ${synced} synced, ${failed} failed`, failed === 0 ? 'success' : 'error');
        
      } catch (err) {
        syncStatus.innerHTML = `<div class="status error">Sync failed: ${err.message}</div>`;
        log(`Sync error: ${err.message}`, 'error');
      }
      
      syncBtn.disabled = false;
      syncBtn.textContent = 'Sync All to Supabase';
    };
    
    // Auto-check on load
    window.checkLocal();
  </script>
</body>
</html>
