<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Reservation - RELIAüêÇLIMO‚Ñ¢</title>
    <link rel="icon" href="https://github.com/user-attachments/assets/d7d111cc-186d-4a88-bac3-7b39c313b25c" />
    <link rel="stylesheet" href="reservation-form.css" />
    <style>
      /* Prevent header flash when embedded; activated once html.embedded is set */
      html.embedded body { padding-top: 0 !important; }
      html.embedded .header, html.embedded header { display: none !important; }
    </style>
    <script>
      // Hide the page header entirely when embedded (index.html already provides its own header)
      if (window.self !== window.top) {
        document.documentElement.classList.add('embedded');
        document.documentElement.classList.add('embedded');
        document.addEventListener('DOMContentLoaded', function() {
          const header = document.querySelector('.header');
          if (header) header.style.display = 'none';
        });
      }
    </script>
  </head>
  <body>
    <div id="app">
      <!-- Navigation Header -->
      <header class="header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
          <div class="header-left">
            <h1 class="logo" style="margin: 0; color: white; font-size: 24px; display: flex; align-items: center; gap: 5px;">
              RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" style="width: 30px; height: 30px;">LIMO‚Ñ¢
            </h1>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="createNewReservation()" style="padding: 8px 16px; background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">‚ûï New Reservation</button>
            <button onclick="goBackToReservations()" id="closeFormBtn" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 14px; display: none;">‚ùå Close</button>
            <button onclick="window.location.href='reservations-list.html'" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 14px;">üìã Reservations</button>
            <button onclick="window.location.href='index.html'" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 14px;">üè† Home</button>
            <button onclick="window.location.href='accounts.html'" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 14px;">üë§ Accounts</button>

            <!-- Supabase connection status badge (admin-only) -->
            <span id="supabaseStatusBadge" class="supabase-status-badge admin-only" title="Supabase connection status">Checking Supabase‚Ä¶</span>
          </div>
        </div>
      </header>

      <!-- Attention Warning -->
      <div class="attention-warning">
        <strong>ATTENTION:</strong> This reservation was created but has not been saved. Be sure to save it before leaving this screen.
      </div>

      <!-- Main Content with side actions -->
      <div class="content-with-actions">
        <main class="main-content">
        <div class="reservation-grid">
          <!-- Left Column: Billing Accounts & Passenger & Booking Agent -->
          <div class="left-column">
            <!-- Billing Accounts Section -->
            <section class="panel">
              <div class="billing-tabs">
                <button class="billing-tab active" data-billing-tab="account">Bill To & Pax</button>
                <button class="billing-tab" data-billing-tab="payment">Payment Info</button>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                    <input type="checkbox" id="copyPassengerInfoCheckbox" style="cursor: pointer;" />
                    <span>Copy Passenger Info</span>
                  </label>
                  <button type="button" id="createAccountBtn" class="btn-icon" title="Create new account from billing info" style="padding: 6px 12px;">üìã Create Account</button>
                </div>
              </div>
              
              <div class="billing-tab-content active" id="accountTab">
              <div class="form-section">
                <div style="display: flex; gap: 5px; align-items: flex-start; margin-bottom: 15px;">
                  <div class="form-group" style="position: relative; flex: 1; margin-bottom: 0;">
                    <label>Account</label>
                    <input type="text" id="billingAccountSearch" class="form-control" placeholder="Search or enter account" autocomplete="off" />
                    <div style="margin-top: 6px; font-size: 12px; color: #666;">
                      Account #:
                      <span id="billingAccountNumberDisplay" style="font-weight: 600; color: #333;"></span>
                    </div>
                    <div id="accountSuggestions" class="suggestions-dropdown"></div>
                  </div>
                  <button type="button" id="viewAccountBtn" class="btn-icon" title="Open account details" style="padding: 8px 10px; font-size: 16px; margin-top: 24px;">üë§</button>
                  <button type="button" id="addAccountBtn" class="btn-icon" title="Add New Account" style="padding: 8px 10px; font-size: 16px; margin-top: 24px;">+</button>
                  <button type="button" id="clearBillingAccountBtn" class="btn-icon" title="Clear billing account" style="padding: 8px 10px; font-size: 16px; margin-top: 24px;">√ó</button>
                </div>

                <div class="form-group">
                  <label>Company</label>
                  <input type="text" id="billingCompany" class="form-control" />
                </div>

                <div class="form-row-2">
                  <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="billingFirstName" class="form-control" />
                  </div>

                  <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="billingLastName" class="form-control" />
                  </div>
                </div>

                <div class="form-group">
                  <label>Cell Phone</label>
                  <input type="tel" id="billingPhone" class="form-control" placeholder="Enter number" inputmode="tel" pattern="\+?1?\d{10}" title="Enter a valid US phone number" required />
                </div>

                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="billingEmail" class="form-control" required />
                </div>
              </div>
              </div>

              <!-- Payment Info Tab Content -->
              <div class="billing-tab-content" id="paymentTab">
                <div class="form-section">
                  <div class="payment-form-row-2">
                    <div class="payment-form-group">
                      <label class="payment-label">Payment Method</label>
                      <select class="payment-control">
                        <option>---</option>
                        <option>Cash</option>
                        <option>Credit Card</option>
                        <option>Check</option>
                        <option>Account</option>
                        <option>Voucher</option>
                      </select>
                    </div>

                    <div class="payment-form-group">
                      <label class="payment-label">Payment Status</label>
                      <select class="payment-control">
                        <option selected>UNPAID</option>
                        <option>PAID</option>
                        <option>PARTIALLY PAID</option>
                        <option>REFUNDED</option>
                      </select>
                    </div>
                  </div>

                  <div class="payment-form-group">
                    <label class="payment-label">Payment Terms:</label>
                    <input type="text" class="payment-control" placeholder="" />
                  </div>

                  <div class="payment-form-group">
                    <label class="payment-label">Payment Gateways:</label>
                    <select class="payment-control">
                      <option selected>Square</option>
                      <option>Stripe</option>
                      <option>PayPal</option>
                      <option>Authorize.net</option>
                    </select>
                  </div>

                  <div class="payment-card-options">
                    <label class="payment-radio-option">
                      <input type="radio" name="cardOption" value="new" checked />
                      <span>Pay with new card</span>
                    </label>
                    <label class="payment-radio-option">
                      <input type="radio" name="cardOption" value="existing" />
                      <span>Use existing card</span>
                    </label>
                  </div>

                  <div class="payment-card-input-group">
                    <button type="button" class="payment-card-icon-btn">üí≥</button>
                    <input type="text" class="payment-control-inline" placeholder="Card number" />
                  </div>

                  <div class="payment-form-row-2">
                    <div class="payment-form-group-inline">
                      <input type="text" class="payment-control" placeholder="MM/YY" />
                    </div>

                    <div class="payment-form-group-inline">
                      <input type="text" class="payment-control" placeholder="CVV" />
                    </div>
                  </div>

                  <div class="payment-form-group">
                    <input type="text" class="payment-control" placeholder="Name on Card" />
                  </div>

                  <div class="payment-section-title">Billing Information (optional)</div>

                  <div class="payment-form-row-2">
                    <div class="payment-form-group-inline">
                      <input type="text" class="payment-control" placeholder="Address Line 1" />
                    </div>

                    <div class="payment-form-group-inline">
                      <input type="text" class="payment-control" placeholder="Address Line 2" />
                    </div>
                  </div>

                  <div class="payment-form-group">
                    <input type="text" class="payment-control" placeholder="City" />
                  </div>

                  <div class="payment-form-row-2">
                    <div class="payment-form-group-inline">
                      <select class="payment-control">
                        <option>Select country ‚ñº</option>
                        <option>United States</option>
                        <option>Canada</option>
                        <option>Mexico</option>
                      </select>
                    </div>

                    <div class="payment-form-group-inline">
                      <select class="payment-control">
                        <option>Select state ‚ñº</option>
                        <option>Alabama</option>
                        <option>Alaska</option>
                        <option>Arizona</option>
                        <option>California</option>
                        <option>Florida</option>
                        <option>New York</option>
                        <option>Texas</option>
                      </select>
                    </div>
                  </div>

                  <div class="payment-form-row-2">
                    <div class="payment-form-group-inline">
                      <input type="email" class="payment-control" placeholder="Cardholder Email" />
                    </div>

                    <div class="payment-form-group-inline">
                      <input type="tel" class="payment-control" placeholder="Cardholder Phone" />
                    </div>
                  </div>

                  <button type="button" class="payment-btn-add-card">Add Card</button>

                  <div class="payment-notes-section">
                    <label class="payment-notes-label">Credit Card Notes</label>
                    <textarea class="payment-notes-textarea" rows="3"></textarea>
                  </div>
                </div>
              </div>
            </section>

            <!-- Passenger Section -->
            <section class="panel">
              <div class="panel-header">
                <h2 class="panel-title">Passenger</h2>
                <button type="button" id="copyBillingToPassengerBtn" class="btn-icon" title="Copy from Billing" style="margin-left: auto; padding: 6px 12px; background: #17a2b8; color: white;">üìã Copy from Billing</button>
                <button type="button" id="clearPassengerBtn" class="btn-icon" title="Clear passenger" style="padding: 6px 12px;">Clear</button>
              </div>
              
              <div class="form-section">
                <div class="form-row-2">
                    <div class="form-group" style="position: relative;">
                    <label>First Name</label>
                    <input type="text" id="passengerFirstName" class="form-control" />
                    <div id="passengerSuggestions" class="suggestions-dropdown"></div>
                  </div>

                    <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="passengerLastName" class="form-control" />
                  </div>
                </div>

                  <div class="form-group">
                  <label>Passenger Phone</label>
                  <input type="tel" id="passengerPhone" class="form-control" placeholder="Enter number" inputmode="tel" pattern="\+?1?\d{10}" title="Enter a valid US phone number" />
                </div>

                  <div class="form-group">
                  <label>Passenger Email</label>
                  <input type="email" id="passengerEmail" class="form-control" />
                </div>

                <div class="subsection-title">Alternate Contact</div>

                <div class="form-group">
                  <label>Alt. Contact Name</label>
                  <input type="text" id="altContactName" class="form-control" />
                </div>

                <div class="form-group">
                  <label>Alt. Contact Phone</label>
                  <input type="tel" id="altContactPhone" class="form-control" placeholder="Enter number" inputmode="tel" pattern="\+?1?\d{10}" title="Enter a valid US phone number" />
                </div>
              </div>
            </section>

            <!-- Booking Agent Section (hidden by default, shown when agent present or account requires it) -->
            <section class="panel" id="bookingAgentSection" style="display: none;">
              <div class="panel-header">
                <h2 class="panel-title">Booking Agent</h2>
                <button type="button" id="copyBillingToBookingBtn" class="btn-icon" title="Copy from Billing" style="margin-left: auto; padding: 6px 12px; background: #17a2b8; color: white;">üìã Copy from Billing</button>
                <button type="button" id="clearBookingAgentBtn" class="btn-icon" title="Clear booking agent" style="padding: 6px 12px;">Clear</button>
              </div>
              
              <div class="form-section">
                <div class="form-row-2">
                    <div class="form-group" style="position: relative;">
                    <label>First Name</label>
                    <input type="text" id="bookedByFirstName" class="form-control" />
                    <div id="bookingAgentSuggestions" class="suggestions-dropdown"></div>
                  </div>

                    <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="bookedByLastName" class="form-control" />
                  </div>
                </div>

                  <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" id="bookedByPhone" class="form-control" placeholder="Enter number" inputmode="tel" pattern="\+?1?\d{10}" title="Enter a valid US phone number" />
                </div>

                  <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="bookedByEmail" class="form-control" />
                </div>
              </div>
            </section>

            <!-- Add Booking Agent Link (shown when section is hidden) -->
            <div id="addBookingAgentLink" class="add-section-link">
              <button type="button" id="showBookingAgentBtn" class="btn-link-add">
                ‚ûï Add Booking Agent
              </button>
            </div>
          </div>

          <!-- Middle Column: Trip Details -->
          <div class="middle-column">
            <!-- Trip Details Section -->
            <section class="panel">
              <div class="panel-header trip-details-header">
                <h2 class="panel-title">Trip Details</h2>
                <div class="conf-number-section">
                  <label for="confNumber" class="conf-label">Conf#</label>
                  <input type="text" id="confNumber" class="conf-input" value="" readonly />
                </div>
              </div>

              <div class="form-section">
                <!-- Date and Time Fields -->
                <div class="time-grid">
                  <div class="form-group">
                    <label>PU Date</label>
                    <input type="date" id="puDate" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label>PU Time</label>
                    <input type="time" id="puTime" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label>DO Time</label>
                    <input type="time" id="doTime" class="form-control" />
                  </div>
                </div>

                <div class="time-grid">
                  <div class="form-group">
                    <label>Spot Time</label>
                    <input type="time" id="spotTime" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label>Gar-Out Time</label>
                    <input type="time" id="garOutTime" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label>Gar-In Time</label>
                    <input type="time" id="garInTime" class="form-control" />
                  </div>
                </div>

                <div class="time-metrics" style="display:flex; gap:16px; margin-top:6px; font-size:13px; color:#37474f;">
                  <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:600;">By Car Distance</span>
                    <span id="routeDistanceInline">-</span>
                  </div>
                  <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:600;">Duration</span>
                    <span id="routeDurationInline">-</span>
                  </div>
                </div>

                <div class="subsection-title" style="margin-top: 20px;">Trip Routing</div>

                <!-- Consolidated Routing Panel -->
                <div class="routing-panel">
                  <!-- Routing Table (always visible) -->
                  <div class="stored-routing">
                    <div class="routing-info-box" id="routingInfoBox">
                      <table class="address-table" style="width: 100%;">
                        <thead>
                          <tr>
                            <th>Type</th>
                            <th>Location Name</th>
                            <th>Address</th>
                            <th>Time In</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="addressTableBody">
                          <tr class="empty-row">
                            <td colspan="5" class="empty-message">No stops added. Click a button below to add pick-up, drop-off, or stops.</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Quick Add Buttons -->
                  <div class="routing-quick-actions">
                    <button type="button" class="routing-action-btn pickup-btn" id="addPickupBtn" title="Add Pick-up">
                      <span class="action-icon">üìç</span> Pick-up
                    </button>
                    <button type="button" class="routing-action-btn dropoff-btn" id="addDropoffBtn" title="Add Drop-off">
                      <span class="action-icon">üéØ</span> Drop-off
                    </button>
                    <button type="button" class="routing-action-btn stop-btn" id="addStopBtn" title="Add Stop">
                      <span class="action-icon">‚è∏Ô∏è</span> Stop
                    </button>
                    <button type="button" class="routing-action-btn wait-btn" id="addWaitBtn" title="Add Wait">
                      <span class="action-icon">‚è±Ô∏è</span> Wait
                    </button>
                  </div>

                  <!-- Expandable Address Entry Form -->
                  <div class="address-entry-card" id="addressEntryCard" style="display: none;">
                    <div class="entry-card-header">
                      <span class="entry-type-label" id="entryTypeLabel">Adding: Pick-up</span>
                      <button type="button" class="close-entry-btn" id="closeEntryBtn" title="Close">‚úï</button>
                    </div>

                    <!-- Location Type Tabs -->
                    <div class="location-type-tabs">
                      <button type="button" class="location-tab active" data-type="search" id="tabSearch">
                        üîç Search
                      </button>
                      <button type="button" class="location-tab" data-type="stored" id="tabStored">
                        üè† Stored
                      </button>
                      <button type="button" class="location-tab" data-type="airport" id="tabAirport">
                        ‚úàÔ∏è Airport
                      </button>
                      <button type="button" class="location-tab" data-type="fbo" id="tabFBO">
                        üõ©Ô∏è FBO
                      </button>
                    </div>

                    <!-- Search/Manual Entry Panel -->
                    <div class="location-panel" id="panelSearch">
                      <div class="form-group location-name-group" style="position: relative;">
                        <label>Location Description / Name</label>
                        <input type="text" id="locationName" class="form-control location-name" placeholder="Search addresses, businesses, landmarks..." autocomplete="off" />
                        <div id="locationNameSuggestions" class="location-suggestions"></div>
                      </div>

                      <div class="form-group" style="position: relative; z-index: 100;">
                        <label>Address 1</label>
                        <input type="text" id="address1" name="address-line1" autocomplete="street-address" class="form-control address-input" placeholder="Street address..." />
                        <div id="addressSuggestions" class="address-suggestions"></div>
                      </div>

                      <div class="form-group">
                        <label>Address 2</label>
                        <input type="text" id="address2" name="address-line2" autocomplete="address-line2" class="form-control" />
                      </div>

                      <div class="address-grid">
                        <div class="form-group">
                          <label>City</label>
                          <input type="text" id="city" name="address-level2" autocomplete="address-level2" class="form-control" />
                        </div>
                        <div class="form-group">
                          <label>State</label>
                          <select id="state" name="address-level1" autocomplete="address-level1" class="form-control">
                            <option value="">--</option>
                            <option value="AL">AL</option>
                            <option value="AK">AK</option>
                            <option value="AZ">AZ</option>
                            <option value="AR">AR</option>
                            <option value="CA">CA</option>
                            <option value="CO">CO</option>
                            <option value="CT">CT</option>
                            <option value="DE">DE</option>
                            <option value="DC">DC</option>
                            <option value="FL">FL</option>
                            <option value="GA">GA</option>
                            <option value="HI">HI</option>
                            <option value="ID">ID</option>
                            <option value="IL">IL</option>
                            <option value="IN">IN</option>
                            <option value="IA">IA</option>
                            <option value="KS">KS</option>
                            <option value="KY">KY</option>
                            <option value="LA">LA</option>
                            <option value="ME">ME</option>
                            <option value="MD">MD</option>
                            <option value="MA">MA</option>
                            <option value="MI">MI</option>
                            <option value="MN">MN</option>
                            <option value="MS">MS</option>
                            <option value="MO">MO</option>
                            <option value="MT">MT</option>
                            <option value="NE">NE</option>
                            <option value="NV">NV</option>
                            <option value="NH">NH</option>
                            <option value="NJ">NJ</option>
                            <option value="NM">NM</option>
                            <option value="NY">NY</option>
                            <option value="NC">NC</option>
                            <option value="ND">ND</option>
                            <option value="OH">OH</option>
                            <option value="OK">OK</option>
                            <option value="OR">OR</option>
                            <option value="PA">PA</option>
                            <option value="RI">RI</option>
                            <option value="SC">SC</option>
                            <option value="SD">SD</option>
                            <option value="TN">TN</option>
                            <option value="TX">TX</option>
                            <option value="UT">UT</option>
                            <option value="VT">VT</option>
                            <option value="VA">VA</option>
                            <option value="WA">WA</option>
                            <option value="WV">WV</option>
                            <option value="WI">WI</option>
                            <option value="WY">WY</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Zip</label>
                          <input type="text" id="zipCode" name="postal-code" autocomplete="postal-code" class="form-control" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Country</label>
                          <select id="country" class="form-control">
                            <option value="US">US</option>
                            <option value="CA">CA</option>
                            <option value="MX">MX</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Time In</label>
                          <input type="time" id="timeIn" class="form-control" />
                        </div>
                      </div>

                      <div class="form-group">
                        <label>Notes</label>
                        <textarea id="locationNotes" class="form-control" rows="2" placeholder="Location-specific notes..."></textarea>
                      </div>
                    </div>

                    <!-- Stored Address Panel -->
                    <div class="location-panel" id="panelStored" style="display: none;">
                      <div class="form-group">
                        <label>Select Stored Address</label>
                        <select id="storedAddressSelect" class="form-control">
                          <option value="">Choose a saved address...</option>
                        </select>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Time In</label>
                          <input type="time" id="storedTimeIn" class="form-control" />
                        </div>
                      </div>
                    </div>

                    <!-- Airport Panel -->
                    <div class="location-panel" id="panelAirport" style="display: none;">
                      <div class="form-group" style="position: relative;">
                        <label>Airport</label>
                        <input type="text" id="airportSearch" class="form-control" placeholder="Search airport code or city (e.g., LAX, Los Angeles)..." autocomplete="off" />
                        <div id="airportSuggestions" class="airport-suggestions"></div>
                        <input type="hidden" id="airportSelect" />
                      </div>

                      <div id="airlineSection" style="display: none;">
                        <div class="form-row">
                          <div class="form-group" style="position: relative; flex: 2;">
                            <label>Airline</label>
                            <input type="text" id="airlineSearch" class="form-control" placeholder="Search airline..." autocomplete="off" />
                            <div id="airlineSuggestions" class="airline-suggestions"></div>
                          </div>
                          <div class="form-group" style="flex: 1;">
                            <label>Code</label>
                            <input type="text" id="airlineCode" class="form-control" readonly />
                          </div>
                        </div>

                        <div class="form-row">
                          <div class="form-group" style="position: relative;">
                            <label>Flight #</label>
                            <input type="text" id="flightNumber" class="form-control" placeholder="Flight number..." autocomplete="off" />
                            <div id="flightSuggestions" class="flight-suggestions"></div>
                          </div>
                          <div class="form-group">
                            <label>Terminal/Gate</label>
                            <input type="text" id="terminalGate" class="form-control" readonly />
                          </div>
                        </div>

                        <div class="form-row">
                          <div class="form-group">
                            <label>Sched. Arrival</label>
                            <input type="text" id="scheduledArrival" class="form-control" readonly />
                          </div>
                          <div class="form-group">
                            <label>Est. Arrival</label>
                            <input type="text" id="estimatedArrival" class="form-control" readonly />
                          </div>
                          <div class="form-group">
                            <label>Status</label>
                            <input type="text" id="flightStatus" class="form-control" readonly />
                          </div>
                        </div>

                        <div class="form-row">
                          <div class="form-group">
                            <label>Origin</label>
                            <input type="text" id="originAirport" class="form-control" readonly />
                          </div>
                          <div class="form-group">
                            <label>Meet Option</label>
                            <select id="meetOption" class="form-control">
                              <option value="curbside">Curbside</option>
                              <option value="baggage">Baggage Claim</option>
                              <option value="arrivals">Arrivals Hall</option>
                              <option value="cell-lot">Cell Phone Lot</option>
                            </select>
                          </div>
                        </div>

                        <input type="hidden" id="airlineName" />
                      </div>
                    </div>

                    <!-- FBO Panel -->
                    <div class="location-panel" id="panelFBO" style="display: none;">
                      <div class="form-group">
                        <label>Select FBO</label>
                        <select id="fboSelect" class="form-control">
                          <option value="">Choose an FBO...</option>
                          <option value="signature-msp">Signature Flight Support - MSP</option>
                          <option value="mercury-air-center">Mercury Air Center - MSP</option>
                          <option value="north-star">North Star Aviation - MSP</option>
                          <option value="jetlink-aviation">JetLink Aviation - MSP</option>
                          <option value="premier-aviation">Premier Aviation Services - MSP</option>
                        </select>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Time In</label>
                          <input type="time" id="fboTimeIn" class="form-control" />
                        </div>
                      </div>
                    </div>

                    <!-- Create Button -->
                    <div class="entry-card-actions">
                      <button type="button" class="btn btn-secondary" id="cancelEntryBtn">Cancel</button>
                      <button type="button" class="btn btn-create" id="createStopBtn" onclick="console.log('CREATE CLICKED'); if(typeof handleCreateStop==='function'){console.log('Calling local handleCreateStop'); handleCreateStop();}else if(typeof window.handleCreateStop==='function'){console.log('Calling window.handleCreateStop'); window.handleCreateStop();}else{alert('handleCreateStop not found! Check console.'); console.error('handleCreateStop not defined');}">CREATE</button>
                    </div>
                  </div>

                  <!-- Route Metrics (show after 2+ stops) -->
                  <div id="routeInfo" class="route-info" style="display: none;">
                    <div class="route-details-inline">
                      <div class="route-metric">
                        <span class="route-label">Distance:</span>
                        <span class="route-value" id="routeDistance">-</span>
                      </div>
                      <div class="route-metric">
                        <span class="route-label">Duration:</span>
                        <span class="route-value" id="routeDuration">-</span>
                      </div>
                    </div>
                    <div id="routeDirections" class="route-directions" style="display: none;"></div>
                  </div>
                </div>

                <!-- Notes Tabs -->
                <div class="notes-tabs-container">
                  <div class="notes-tabs">
                    <button class="notes-tab active" data-tab="trip">Trip Notes</button>
                    <button class="notes-tab" data-tab="billpax">Bill To & Pax Notes</button>
                  </div>
                  <div class="notes-content">
                    <div class="notes-panel active" id="tripNotesPanel">
                      <textarea id="tripNotes" class="form-control notes-textarea" rows="5" placeholder="Enter trip notes..."></textarea>
                      <div class="notes-options">
                        <label>
                          <input type="checkbox" id="addToTrip" />
                          <span>Add to T/S</span>
                        </label>
                        <label>
                          <input type="checkbox" id="hideFromCustomer" />
                          <span>Hide From Customer</span>
                        </label>
                        <button class="btn btn-secondary btn-small">SAVE NOTES</button>
                      </div>
                    </div>
                    <div class="notes-panel" id="billPaxNotesPanel">
                      <textarea id="billPaxNotes" class="form-control notes-textarea" rows="5" placeholder="Enter bill to & pax notes..."></textarea>
                      <button class="btn btn-secondary btn-small" style="margin-top: 10px;">SAVE NOTES</button>
                    </div>
                  </div>
                </div>

                <!-- Dispatch Notes -->
                <div class="form-group" style="margin-top: 20px;">
                  <div class="subsection-title">Dispatch Notes</div>
                  <textarea id="dispatchNotes" class="form-control" rows="4" placeholder="Enter dispatch notes..."></textarea>
                  <button class="btn btn-secondary btn-small" style="margin-top: 10px;">SAVE NOTES</button>
                </div>
              </div>
            </section>
          </div>

          <!-- Right Column: Complete Reservation Details -->
          <div class="right-column">
            <div class="action-buttons-vertical">
              <button class="action-btn btn-save">üíæ Save</button>
              <button class="action-btn btn-payments">üí≥ Payments</button>
              <button class="action-btn btn-copy-action">üìã Copy</button>
              <button class="action-btn btn-roundtrip">üîÑ Round Trip</button>
              <button class="action-btn btn-email">üìß Email/Fax</button>
              <button class="action-btn btn-print">üñ®Ô∏è Print</button>
              <div class="more-menu">
                <button class="action-btn btn-more" id="moreActionsBtn">‚ãØ More</button>
                <div class="more-menu-dropdown" id="moreActionsDropdown">
                  <button class="dropdown-item" id="deleteReservationBtn">üóëÔ∏è Delete Reservation</button>
                </div>
              </div>
            </div>

            <section class="panel">
              <div class="panel-header">
                <h2 class="panel-title">Reservation Details</h2>
              </div>

              <div class="form-section">
                <!-- Date/Time and Status -->
                <div class="form-row-2">
                  <div class="form-group">
                    <label>Date/Time:</label>
                    <input type="text" id="resDateTime" class="form-control" readonly />
                  </div>
                  <div class="form-group">
                    <label>Res. By:</label>
                    <input type="text" id="resBy" class="form-control" placeholder="Unassigned" />
                  </div>
                </div>

                <div class="form-group">
                  <label>Status:</label>
                  <select id="resStatus" class="form-control">
                    <option value="unassigned" selected>Unassigned</option>
                    <optgroup label="Booked / eFarm In">
                      <option value="pending">Pending</option>
                      <option value="confirmed">Confirmed</option>
                      <option value="in-progress">In Progress</option>
                      <option value="dispatched">Dispatched</option>
                      <option value="get_status_now">Get Status Now!</option>
                      <option value="flight_time_change">Flight Time Change</option>
                      <option value="offered_efarm_in">Offered and eFarm In</option>
                    </optgroup>
                    <optgroup label="Created">
                      <option value="unassigned">Unassigned</option>
                      <option value="farm_out_unassigned">Farm-out Unassigned</option>
                    </optgroup>
                    <optgroup label="Offered to Driver">
                      <option value="offered">Offered</option>
                      <option value="offered_to_affiliate">Offered to Affiliate</option>
                    </optgroup>
                    <optgroup label="Driver Is Assigned">
                      <option value="assigned">Assigned</option>
                      <option value="affiliate_assigned">Affiliate Is Assigned</option>
                      <option value="farm_out_assigned">Farm-out Assigned</option>
                      <option value="affiliate_driver_assigned">Affiliate Driver Is Assigned</option>
                    </optgroup>
                    <optgroup label="Driver Is En Route to Pickup">
                      <option value="driver_en_route">Driver En Route</option>
                      <option value="on_the_way">On The Way</option>
                    </optgroup>
                    <optgroup label="Driver Is Circling">
                      <option value="driver_circling">Circling</option>
                    </optgroup>
                    <optgroup label="Driver Is Waiting at Pickup">
                      <option value="driver_waiting_at_pickup">Arrived</option>
                      <option value="waiting_at_pickup">Waiting at Pickup</option>
                    </optgroup>
                    <optgroup label="Driving Passenger">
                      <option value="customer_in_car">Customer In Car</option>
                      <option value="driving_passenger">Driving Passenger</option>
                    </optgroup>
                    <optgroup label="Completing">
                      <option value="completed">Completed</option>
                      <option value="done">Done</option>
                    </optgroup>
                    <optgroup label="Cancelled">
                      <option value="cancelled">Cancelled</option>
                      <option value="cancelled_by_affiliate">Cancelled by Affiliate</option>
                      <option value="late_cancel">Late Cancel</option>
                      <option value="late_cancelled">Late Cancelled</option>
                      <option value="no_show">No Show</option>
                      <option value="covid19_cancellation">COVID-19 Cancellation</option>
                    </optgroup>
                  </select>
                </div>

                <div class="form-divider"></div>

                <!-- Trip Details -->
                <div class="form-row-4">
                  <div class="form-group">
                    <label>Duration:</label>
                    <input type="number" id="duration" class="form-control" value="1" min="0" step="0.5" />
                  </div>
                  <div class="form-group">
                    <label>Est Drv Time:</label>
                    <input type="number" id="estDrvTime" class="form-control" value="0" min="0" step="0.5" />
                  </div>
                  <div class="form-group">
                    <label># of Pax:</label>
                    <input type="number" id="numPax" class="form-control" value="1" min="1" />
                  </div>
                  <div class="form-group">
                    <label>Luggage:</label>
                    <input type="number" id="luggage" class="form-control" value="0" min="0" />
                  </div>
                </div>

                <div class="form-row-3">
                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" id="accessible" />
                      <span>Accessible:</span>
                    </label>
                  </div>
                  <div class="form-group">
                    <label>Child Seat Required:</label>
                    <select id="childSeatRequired" class="form-control">
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Child Seat Count:</label>
                    <select id="childSeatCount" class="form-control">
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                    </select>
                  </div>
                </div>

                <div class="additional-link">
                  <a href="#" id="additionalChildSeats">Additional Child Seats</a>
                  <span class="total-indicator">Total Seats (0)</span>
                </div>

                <div class="form-divider"></div>

                <!-- Service and Vehicle - Single Row -->
                <div class="form-row-3">
                  <div class="form-group">
                    <label>Service Type</label>
                    <select id="serviceType" class="form-control">
                      <option value="">- - - - NOT ASSIGNED - - - -</option>
                      <option value="point-to-point">Point to Point</option>
                      <option value="hourly">Hourly</option>
                      <option value="airport-transfer">Airport Transfer</option>
                      <option value="wedding">Wedding</option>
                      <option value="corporate">Corporate</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Vehicle Type</label>
                    <select id="vehicleTypeRes" class="form-control">
                      <option value="">-- Loading vehicles... --</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Promo Code</label>
                    <select id="promoCode" class="form-control">
                      <option value="">- - - - NOT ASSIGNED - - - -</option>
                      <option value="WINTER20">WINTER20 - 20% Off</option>
                      <option value="CORP10">CORP10 - Corporate 10%</option>
                      <option value="VIP15">VIP15 - VIP Discount</option>
                    </select>
                  </div>
                </div>

                <div class="form-divider"></div>

                <!-- Farm Options -->
                <div class="farm-row">
                  <div class="farm-options">
                    <label class="radio-inline">
                      <input type="radio" name="farmOption" value="in-house" checked />
                      <span>In-House</span>
                    </label>
                    <label class="radio-inline">
                      <input type="radio" name="farmOption" value="farm-in" />
                      <span>Farm-in</span>
                    </label>
                    <label class="radio-inline">
                      <input type="radio" name="farmOption" value="farm-out" />
                      <span>Farm-out</span>
                    </label>
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <label>eFarm Status:</label>
                    <input type="text" id="eFarmStatus" class="form-control status-indicator" value="Farm-out Unassigned" readonly />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>eFarm-out:</label>
                    <select id="eFarmOut" class="form-control">
                      <option value="manual">Manual</option>
                      <option value="automatic">Automatic</option>
                    </select>
                  </div>
                </div>

                <div class="form-group" style="position: relative;">
                  <label>Affiliate:</label>
                  <div style="display: flex; gap: 5px;">
                    <input type="text" id="affiliate" class="form-control" placeholder="Search affiliate..." style="flex: 1;" autocomplete="off" />
                    <button type="button" id="openAffiliateListBtn" class="btn-icon" title="View Affiliate List">...</button>
                    <button type="button" class="btn-icon" title="Add to favorites">+1</button>
                  </div>
                  <div id="affiliateSuggestions" class="affiliate-suggestions"></div>
                </div>

                <div class="form-group">
                  <label>Reference #</label>
                  <input type="text" id="referenceNumber" class="form-control" />
                </div>

                <div class="additional-link">
                  <a href="#" id="additionalAffiliateInfo">Additional Affiliate Information</a>
                </div>

                <div class="form-divider"></div>

                <!-- Action Buttons -->
                <div class="form-divider"></div>

                <!-- Rate Configuration Summary -->
                <div class="rate-config-panel" id="rateConfigPanel">
                  <div class="rate-config-header">
                    <span class="rate-config-title">üìä Pricing Configuration</span>
                    <button type="button" class="rate-config-toggle" id="toggleRateConfig" title="Show/Hide rate details">‚ñº</button>
                  </div>
                  <div class="rate-config-body" id="rateConfigBody">
                    <div class="rate-row">
                      <div class="rate-label">Service Type:</div>
                      <div class="rate-value" id="rateServiceType">--</div>
                      <div class="rate-label">Pricing Basis:</div>
                      <div class="rate-value" id="ratePricingBasis">--</div>
                    </div>
                    <div class="rate-row">
                      <div class="rate-label">Vehicle Type:</div>
                      <div class="rate-value" id="rateVehicleType">--</div>
                      <div class="rate-label">Base Rate:</div>
                      <div class="rate-value" id="rateBaseRate">$0.00</div>
                    </div>
                    <div class="rate-row">
                      <div class="rate-label">Per Hour:</div>
                      <div class="rate-value" id="ratePerHour">$0.00</div>
                      <div class="rate-label">Per Mile:</div>
                      <div class="rate-value" id="ratePerMile">$0.00</div>
                    </div>
                    <div class="rate-row">
                      <div class="rate-label">Min Hours:</div>
                      <div class="rate-value" id="rateMinHours">0</div>
                      <div class="rate-label">Gratuity:</div>
                      <div class="rate-value" id="rateGratuity">0%</div>
                    </div>
                    <div class="rate-config-actions">
                      <button type="button" class="btn btn-small btn-secondary" id="applyRatesBtn">Apply Rates to Costs</button>
                    </div>
                  </div>
                </div>

                <!-- Cost Tabs -->
                <div class="cost-tabs">
                  <button class="cost-tab active" data-tab="primary">Primary</button>
                  <button class="cost-tab" data-tab="secondary">Secondary</button>
                  <button class="cost-tab" data-tab="farmout">Farm-out Costs</button>
                </div>

                <div class="cost-tab-content active" id="primaryCostTab">
                  <!-- Primary Cost Breakdown -->
                <div class="cost-table">
                  <div class="cost-row header">
                    <div class="cost-cell">Charge</div>
                    <div class="cost-cell">Qty</div>
                    <div class="cost-cell">Rate</div>
                    <div class="cost-cell">Ext.</div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Flat Rate</div>
                    <div class="cost-cell"><input type="number" id="flatQty" class="cost-input" value="1" /></div>
                    <div class="cost-cell"><input type="number" id="flatRate" class="cost-input" value="0" step="0.01" /></div>
                    <div class="cost-cell"><input type="number" id="flatExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Per Hour</div>
                    <div class="cost-cell"><input type="number" id="hourQty" class="cost-input" value="0" step="0.5" /></div>
                    <div class="cost-cell"><input type="number" id="hourRate" class="cost-input" value="0" step="0.01" /></div>
                    <div class="cost-cell"><input type="number" id="hourExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Per Unit</div>
                    <div class="cost-cell"><input type="number" id="unitQty" class="cost-input" value="0" /></div>
                    <div class="cost-cell"><input type="number" id="unitRate" class="cost-input" value="0" step="0.01" /></div>
                    <div class="cost-cell"><input type="number" id="unitExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">OT/Wait Time</div>
                    <div class="cost-cell"><input type="number" id="otQty" class="cost-input" value="0" step="0.5" /></div>
                    <div class="cost-cell"><input type="number" id="otRate" class="cost-input" value="0" step="0.01" /></div>
                    <div class="cost-cell"><input type="number" id="otExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Extra Stops</div>
                    <div class="cost-cell"><input type="number" id="stopsQty" class="cost-input" value="0" /></div>
                    <div class="cost-cell"><input type="number" id="stopsRate" class="cost-input" value="0" step="0.01" /></div>
                    <div class="cost-cell"><input type="number" id="stopsExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Total Gratuity (%)</div>
                    <div class="cost-cell"><input type="number" id="gratuityQty" class="cost-input" value="0" step="1" /></div>
                    <div class="cost-cell"></div>
                    <div class="cost-cell"><input type="number" id="gratuityExt" class="cost-input" value="0" readonly /></div>
                  </div>

                  <div class="cost-row">
                    <div class="cost-cell">Late Night/Early/Mid Surch</div>
                    <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                    <div class="cost-cell"><span class="percent-label">%</span></div>
                    <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                  </div>

                  <div class="cost-row summary">
                    <div class="cost-cell">Grand Total (USD)</div>
                    <div class="cost-cell"></div>
                    <div class="cost-cell"></div>
                    <div class="cost-cell"><span id="grandTotal">0.00</span></div>
                  </div>

                  <div class="cost-row summary">
                    <div class="cost-cell">Payments/Deposits</div>
                    <div class="cost-cell"></div>
                    <div class="cost-cell"></div>
                    <div class="cost-cell"><span id="payments">0.00</span></div>
                  </div>

                  </div>

                  <!-- Secondary/Farm-out tabs content (hidden by default) -->

                </div>

                <div class="cost-tab-content" id="secondaryCostTab">
                    <div class="cost-table">
                      <div class="cost-row header">
                        <div class="cost-cell">Charge</div>
                        <div class="cost-cell">Qty</div>
                        <div class="cost-cell">Rate</div>
                        <div class="cost-cell">Ext.</div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Fuel Surcharge (%)</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Discount (%)</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Per Pass</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.01" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Per Mile</div>
                        <div class="cost-cell"><input type="number" id="secondaryPerMileQty" class="cost-input" value="0" step="0.1" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.01" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Surface Transp. Charge (%)</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Base Rate STC (%)</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Admin Fee</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.01" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Fuel Surch</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="4.9" step="0.1" /></div>
                        <div class="cost-cell"><span class="percent-label">%</span></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Discount</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="1" /></div>
                        <div class="cost-cell"><span class="percent-label">%</span></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Base</div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Base rate STC</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="20" step="1" /></div>
                        <div class="cost-cell"><span class="percent-label">%</span></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Per Mile</div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.1" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.01" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Per Hour</div>
                        <div class="cost-cell"><input type="number" id="secondaryPerHourQty" class="cost-input" value="0" step="0.5" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0" step="0.01" /></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Admin Fee</div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Base rate STC</div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Fuel Surcharge</div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>

                      <div class="cost-row">
                        <div class="cost-cell">Requested Gratuity</div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"></div>
                        <div class="cost-cell"><input type="number" class="cost-input" value="0.00" readonly /></div>
                      </div>
                    </div>
                </div>

                <div class="cost-tab-content" id="farmoutCostTab">
                  <p style="text-align: center; padding: 20px; color: #666;">Farm-out cost details</p>
                </div>

                <div class="form-divider" style="margin-top: 20px;"></div>

                <!-- Assignment Tabs -->
                <div class="assignment-tabs">
                  <button class="assignment-tab active" data-tab="primary">Primary</button>
                  <button class="assignment-tab" data-tab="secondary">Secondary</button>
                </div>

                <div class="assignment-content active" id="primaryAssignment">
                  <div class="form-group">
                    <label>Driver</label>
                    <select id="driverSelect" class="form-control">
                      <option value="">-- Loading drivers... --</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Fleet Vehicle</label>
                    <select id="carSelect" class="form-control">
                      <option value="">-- Loading Fleet Vehicles... --</option>
                    </select>
                  </div>
                </div>

                <div class="assignment-content" id="secondaryAssignment">
                  <div class="form-group">
                    <label>Secondary Driver</label>
                    <select id="secondaryDriverSelect" class="form-control">
                      <option value="">-- Loading drivers... --</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Secondary Fleet Vehicle</label>
                    <select id="secondaryCarSelect" class="form-control">
                      <option value="">-- Loading Fleet Vehicles... --</option>
                    </select>
                  </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                  <label>Rental Agreements:</label>
                  <select id="rentalAgreement" class="form-control">
                    <option value="erix">Erix Coach and Car Agreement</option>
                    <option value="standard">Standard Rental Agreement</option>
                    <option value="corporate">Corporate Contract</option>
                    <option value="wedding">Wedding Package Agreement</option>
                  </select>
                </div>

                <button type="button" id="saveReservationBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">
                  SAVE RESERVATION
                </button>
              </div>
            </section>
          </div>
        </div>
        </main>
      </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Contact</h3>
          <button class="modal-close" id="closeContactModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-section">
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="contactCompany" class="form-control" placeholder="Company name (optional)" />
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="contactFirstName" class="form-control" placeholder="First name" required />
              </div>

              <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="contactLastName" class="form-control" placeholder="Last name" required />
              </div>
            </div>

            <div class="form-group">
              <label>Cell Phone</label>
              <input type="tel" id="contactPhone" class="form-control" placeholder="Phone number" />
            </div>

            <div class="form-group">
              <label>Email</label>
              <input type="email" id="contactEmail" class="form-control" placeholder="Email address" />
            </div>

            <div class="form-group">
              <label>Address</label>
              <input type="text" id="contactAddress" class="form-control" placeholder="Street address" />
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="contactCity" class="form-control" placeholder="City" />
              </div>

              <div class="form-group">
                <label>State</label>
                <input type="text" id="contactState" class="form-control" placeholder="State" />
              </div>
            </div>

            <div class="form-row-2">
              <div class="form-group">
                <label>Zip Code</label>
                <input type="text" id="contactZip" class="form-control" placeholder="Zip code" />
              </div>

              <div class="form-group">
                <label>Country</label>
                <input type="text" id="contactCountry" class="form-control" placeholder="Country" value="United States" />
              </div>
            </div>

            <div class="form-group">
              <label>Notes</label>
              <textarea id="contactNotes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelContact">Cancel</button>
          <button class="btn btn-primary" id="saveContact">Save Contact</button>
        </div>
      </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Account Information</h3>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelAccount">Cancel</button>
          <button class="btn btn-primary" id="createAccount">Create Account</button>
        </div>
      </div>
    </div>

    <!-- Affiliate List Modal -->
    <div id="affiliateModal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>Affiliate List</h3>
          <button class="modal-close" id="closeAffiliateModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="affiliate-search-bar">
            <input type="text" id="affiliateModalSearch" class="form-control" placeholder="Search affiliates by name, company, or location..." />
          </div>
          <div class="affiliate-list-container">
            <table class="affiliate-table">
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Contact</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="affiliateListBody">
                <!-- Dynamic affiliate list -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="closeAffiliateListBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Address Confirmation Modal -->
    <div id="addressConfirmModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Confirm Address</h3>
          <button class="modal-close" id="closeAddressConfirmModal">&times;</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px; font-size: 13px;">We found similar addresses. Please select one or use your custom text:</p>
          
          <div class="address-confirm-list" id="addressConfirmList">
            <!-- Suggested addresses will be populated here -->
          </div>

          <div class="custom-address-option">
            <label class="address-option-item custom-option">
              <input type="radio" name="addressChoice" value="custom" checked />
              <div class="address-option-content">
                <strong>USE CUSTOM TEXT ENTERED</strong>
                <div class="custom-address-preview" id="customAddressPreview"></div>
              </div>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelAddressConfirm">Cancel</button>
          <button class="btn btn-primary" id="confirmAddressSelection">Continue</button>
        </div>
      </div>
    </div>

    <script>
      // Global stops array to store all trip stops
      let tripStops = [];
      
      // Debounce timer for API searches
      let locationSearchTimeout;
      let addressSearchTimeout;

      // Airport database
      const airports = [
        { code: 'MSP', name: 'Minneapolis-Saint Paul International', city: 'Minneapolis', state: 'MN' },
        { code: 'JFK', name: 'John F. Kennedy International', city: 'New York', state: 'NY' },
        { code: 'LAX', name: 'Los Angeles International', city: 'Los Angeles', state: 'CA' },
        { code: 'ORD', name: 'Chicago O\'Hare International', city: 'Chicago', state: 'IL' },
        { code: 'DFW', name: 'Dallas/Fort Worth International', city: 'Dallas', state: 'TX' },
        { code: 'DEN', name: 'Denver International', city: 'Denver', state: 'CO' },
        { code: 'SEA', name: 'Seattle-Tacoma International', city: 'Seattle', state: 'WA' },
        { code: 'SFO', name: 'San Francisco International', city: 'San Francisco', state: 'CA' },
        { code: 'LAS', name: 'Harry Reid International', city: 'Las Vegas', state: 'NV' },
        { code: 'MIA', name: 'Miami International', city: 'Miami', state: 'FL' }
      ];

      // Airline database
      const airlines = [
        { code: 'AA', name: 'American Airlines' },
        { code: 'DL', name: 'Delta Air Lines' },
        { code: 'UA', name: 'United Airlines' },
        { code: 'SW', name: 'Southwest Airlines' },
        { code: 'B6', name: 'JetBlue Airways' },
        { code: 'AS', name: 'Alaska Airlines' },
        { code: 'F9', name: 'Frontier Airlines' },
        { code: 'NK', name: 'Spirit Airlines' },
        { code: 'G4', name: 'Allegiant Air' },
        { code: 'SY', name: 'Sun Country Airlines' },
        { code: 'BA', name: 'British Airways' },
        { code: 'LH', name: 'Lufthansa' },
        { code: 'AF', name: 'Air France' },
        { code: 'KL', name: 'KLM Royal Dutch Airlines' },
        { code: 'AC', name: 'Air Canada' }
      ];

      // Minneapolis/St Paul FBO database
      const fboDatabase = {
        'signature-msp': {
          name: 'Signature Flight Support - Minneapolis',
          address: '7955 Uniform Avenue South',
          city: 'Minneapolis',
          state: 'MN',
          zip: '55450',
          phone: '(612) 726-2000',
          email: 'msp@signatureflight.com',
          services: 'Fuel, Maintenance, Crew, Catering'
        },
        'mercury-air-center': {
          name: 'Mercury Air Center - MSP',
          address: '6900 Singletree Lane',
          city: 'Bloomington',
          state: 'MN',
          zip: '55438',
          phone: '(612) 978-9000',
          email: 'info@mercuryair.com',
          services: 'Fuel, Ground Handling, Maintenance'
        },
        'north-star': {
          name: 'North Star Aviation - MSP',
          address: '7700 Singletree Road South',
          city: 'Bloomington',
          state: 'MN',
          zip: '55438',
          phone: '(612) 941-6000',
          email: 'ops@northstaraviation.com',
          services: 'Jet Fuel, Hangar, Aircraft Maintenance'
        },
        'jetlink-aviation': {
          name: 'JetLink Aviation - MSP',
          address: '7600 Uniform Avenue South',
          city: 'Minneapolis',
          state: 'MN',
          zip: '55450',
          phone: '(612) 721-2200',
          email: 'info@jetlinkaviation.com',
          services: 'Fuel, Catering, Crew Facilities'
        },
        'premier-aviation': {
          name: 'Premier Aviation Services - MSP',
          address: '7450 Humphrey Drive',
          city: 'Bloomington',
          state: 'MN',
          zip: '55438',
          phone: '(612) 825-3700',
          email: 'reservations@premieraviation.com',
          services: 'Full Service FBO, Maintenance'
        }
      };

      // Mock flight data
      const flightDatabase = {
        'AA100': {
          number: '100',
          airline: 'AA',
          origin: 'LAX',
          destination: 'MSP',
          terminal: '2',
          gate: 'B15',
          status: 'on-time',
          scheduled: '2:30 PM',
          estimated: '2:30 PM'
        },
        'AA200': {
          number: '200',
          airline: 'AA',
          origin: 'ORD',
          destination: 'MSP',
          terminal: '1',
          gate: 'A22',
          status: 'delayed',
          scheduled: '3:15 PM',
          estimated: '3:45 PM'
        },
        'DL500': {
          number: '500',
          airline: 'DL',
          origin: 'ATL',
          destination: 'MSP',
          terminal: '3',
          gate: 'C10',
          status: 'on-time',
          scheduled: '4:00 PM',
          estimated: '4:00 PM'
        },
        'DL501': {
          number: '501',
          airline: 'DL',
          origin: 'DEN',
          destination: 'MSP',
          terminal: '3',
          gate: 'C11',
          status: 'boarding',
          scheduled: '5:20 PM',
          estimated: '5:20 PM'
        },
        'UA1000': {
          number: '1000',
          airline: 'UA',
          origin: 'SFO',
          destination: 'MSP',
          terminal: '1',
          gate: 'A5',
          status: 'on-time',
          scheduled: '1:45 PM',
          estimated: '1:45 PM'
        },
        'UA1001': {
          number: '1001',
          airline: 'UA',
          origin: 'DFW',
          destination: 'MSP',
          terminal: '1',
          gate: 'A10',
          status: 'delayed',
          scheduled: '6:00 PM',
          estimated: '6:30 PM'
        },
        'SW250': {
          number: '250',
          airline: 'SW',
          origin: 'LAS',
          destination: 'MSP',
          terminal: '2',
          gate: 'B5',
          status: 'on-time',
          scheduled: '7:15 PM',
          estimated: '7:15 PM'
        }
      };

      // Inline handler for location type changes
      function handleLocationTypeChange(locationType) {
        console.log('Location type changed to:', locationType);
        
        // Hide all dropdowns
        document.getElementById('storedAddressDropdown').style.display = 'none';
        document.getElementById('airportDropdown').style.display = 'none';
        document.getElementById('fboDropdown').style.display = 'none';

        // Show the selected dropdown
        if (locationType === 'stored') {
          console.log('‚úÖ Showing stored address dropdown');
          document.getElementById('storedAddressDropdown').style.display = 'block';
        } else if (locationType === 'airport') {
          console.log('‚úÖ Showing airport dropdown');
          document.getElementById('airportDropdown').style.display = 'block';
        } else if (locationType === 'fbo') {
          console.log('‚úÖ Showing FBO dropdown');
          document.getElementById('fboDropdown').style.display = 'block';
        }
      }

      // Airport search handler
      function handleAirportSearch(query) {
        console.log('üîç Searching for:', query);
        
        if (query.length < 1) {
          document.getElementById('airportSuggestions').classList.remove('active');
          return;
        }

        // Search the airports
        const q = query.toLowerCase();
        const results = airports.filter(a => 
          a.code.toLowerCase().includes(q) || 
          a.name.toLowerCase().includes(q) ||
          a.city.toLowerCase().includes(q)
        );

        console.log('Found results:', results);
        displayAirportResults(results);
      }

      // Display airport results
      function displayAirportResults(results) {
        const container = document.getElementById('airportSuggestions');
        
        if (!results || results.length === 0) {
          container.innerHTML = '<div style="padding: 10px 12px; color: #999;">No airports found</div>';
          container.classList.add('active');
          return;
        }

        container.innerHTML = results.slice(0, 8).map(airport => `
          <div class="airport-suggestion-item" onclick="selectAirport('${airport.code}', '${airport.name}')">
            <span class="airport-code">${airport.code}</span>
            <span class="airport-name">${airport.name}</span>
            <span class="airport-city">${airport.city}, ${airport.state}</span>
          </div>
        `).join('');

        container.classList.add('active');
      }

      // Select airport
      function selectAirport(code, name) {
        console.log('‚úÖ Selected airport:', code, name);
        
        document.getElementById('airportSearch').value = `${code} - ${name}`;
        document.getElementById('airportSelect').value = code;
        document.getElementById('airportSuggestions').classList.remove('active');
        
        // Show airline section
        const airlineSection = document.getElementById('airlineSection');
        if (airlineSection) {
          airlineSection.style.display = 'block';
          // Focus on airline search
          setTimeout(() => {
            const airlineSearchInput = document.getElementById('airlineSearch');
            if (airlineSearchInput) {
              airlineSearchInput.focus();
            }
          }, 100);
          console.log('‚úÖ Airline section shown');
        }
      }

      // Airline search handler
      function handleAirlineSearch(query) {
        console.log('üîç Searching for airline:', query);
        
        if (query.length < 1) {
          document.getElementById('airlineSuggestions').classList.remove('active');
          return;
        }

        // Search the airlines
        const q = query.toLowerCase();
        const results = airlines.filter(a => 
          a.code.toLowerCase().includes(q) || 
          a.name.toLowerCase().includes(q)
        );

        console.log('Found airlines:', results);
        displayAirlineResults(results);
      }

      // Display airline results
      function displayAirlineResults(results) {
        const container = document.getElementById('airlineSuggestions');
        
        if (!results || results.length === 0) {
          container.innerHTML = '<div style="padding: 10px 12px; color: #999;">No airlines found</div>';
          container.classList.add('active');
          return;
        }

        container.innerHTML = results.slice(0, 8).map(airline => `
          <div class="airline-suggestion-item" onclick="selectAirline('${airline.code}', '${airline.name}')">
            <span class="airline-code">${airline.code}</span>
            <span class="airline-name">${airline.name}</span>
          </div>
        `).join('');

        container.classList.add('active');
      }

      // Select airline
      function selectAirline(code, name) {
        console.log('‚úÖ Selected airline:', code, name);
        
        document.getElementById('airlineSearch').value = `${code} - ${name}`;
        document.getElementById('airlineCode').value = code;
        document.getElementById('airlineName').value = name;
        document.getElementById('airlineSuggestions').classList.remove('active');
        
        // Focus on flight number after airline selection
        setTimeout(() => {
          const flightInput = document.getElementById('flightNumber');
          if (flightInput) {
            flightInput.focus();
          }
        }, 100);
        
        console.log('‚úÖ Airline fields populated');
      }

      // Flight number search handler
      function handleFlightNumberSearch(flightNumber) {
        console.log('üîç Searching for flight:', flightNumber);
        
        if (!flightNumber || flightNumber.length < 1) {
          document.getElementById('flightSuggestions').classList.remove('active');
          return;
        }

        // Get airline code
        const airlineCode = document.getElementById('airlineCode').value;
        if (!airlineCode) {
          console.log('‚ö†Ô∏è No airline selected');
          return;
        }

        // Build potential flight keys
        const flightKey = (airlineCode + flightNumber).toUpperCase();
        const flightData = flightDatabase[flightKey];

        if (flightData) {
          console.log('‚úÖ Flight found:', flightData);
          autoPopulateFlightDetails(flightData);
          showFlightSuggestion(flightData);
        } else {
          console.log('‚ÑπÔ∏è Flight not found in database, showing suggestions');
          showFlightSuggestions(airlineCode, flightNumber);
        }
      }

      // Show available flights for airline
      function showFlightSuggestions(airlineCode, searchTerm) {
        const results = Object.values(flightDatabase).filter(f => 
          f.airline === airlineCode && 
          f.number.toLowerCase().includes(searchTerm.toLowerCase())
        );

        const container = document.getElementById('flightSuggestions');
        
        if (results.length === 0) {
          container.innerHTML = '<div style="padding: 10px 12px; color: #999;">No flights found. Type flight number to continue.</div>';
          container.classList.add('active');
          return;
        }

        container.innerHTML = results.map(flight => `
          <div class="flight-suggestion-item" onclick="selectFlight('${flight.number}')">
            <strong>Flight ${flight.airline}${flight.number}</strong>
            <div>${flight.origin} ‚Üí ${flight.destination} | ${flight.scheduled}</div>
            <div style="font-size: 11px; color: #666;">Terminal ${flight.terminal}, Gate ${flight.gate} | ${flight.status}</div>
          </div>
        `).join('');

        container.classList.add('active');
      }

      // Show single flight suggestion
      function showFlightSuggestion(flightData) {
        const container = document.getElementById('flightSuggestions');
        
        container.innerHTML = `
          <div class="flight-suggestion-item" style="background: #e8f4f8; padding: 12px;">
            <strong>‚úì Flight ${flightData.airline}${flightData.number} - ${flightData.origin} to ${flightData.destination}</strong>
            <div>Terminal ${flightData.terminal}, Gate ${flightData.gate}</div>
            <div style="font-size: 11px; color: #666;">Status: ${flightData.status.toUpperCase()} | Scheduled: ${flightData.scheduled} | Est: ${flightData.estimated}</div>
          </div>
        `;
        
        container.classList.add('active');
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          container.classList.remove('active');
        }, 3000);
      }

      // Select flight from suggestions
      function selectFlight(flightNumber) {
        const airlineCode = document.getElementById('airlineCode').value;
        const flightKey = (airlineCode + flightNumber).toUpperCase();
        const flightData = flightDatabase[flightKey];
        
        if (flightData) {
          document.getElementById('flightNumber').value = flightNumber;
          autoPopulateFlightDetails(flightData);
          document.getElementById('flightSuggestions').classList.remove('active');
        }
      }

      // Auto-populate flight details
      function autoPopulateFlightDetails(flightData) {
        console.log('üìù Auto-populating flight details:', flightData);
        
        // Set terminal and gate
        const terminalGateField = document.getElementById('terminalGate');
        if (terminalGateField) {
          terminalGateField.value = `${flightData.terminal}/${flightData.gate}`;
        }

        // Set flight status with color coding
        const statusField = document.getElementById('flightStatus');
        if (statusField) {
          statusField.value = flightData.status.toUpperCase();
          
          // Color code based on status
          if (flightData.status === 'on-time') {
            statusField.style.color = '#155724';
            statusField.style.backgroundColor = '#d4edda';
          } else if (flightData.status === 'delayed') {
            statusField.style.color = '#856404';
            statusField.style.backgroundColor = '#fff3cd';
          } else if (flightData.status === 'boarding') {
            statusField.style.color = '#004085';
            statusField.style.backgroundColor = '#d1ecf1';
          }
          statusField.style.fontWeight = '600';
          statusField.style.padding = '4px 8px';
          statusField.style.borderRadius = '3px';
        }

        // Set scheduled arrival
        const scheduledField = document.getElementById('scheduledArrival');
        if (scheduledField) {
          scheduledField.value = flightData.scheduled;
        }

        // Set estimated arrival
        const estimatedField = document.getElementById('estimatedArrival');
        if (estimatedField) {
          estimatedField.value = flightData.estimated;
        }

        // Set origin airport
        const originField = document.getElementById('originAirport');
        if (originField) {
          originField.value = flightData.origin;
        }

        // Show status indicator
        const indicator = document.getElementById('flightStatusIndicator');
        if (indicator) {
          indicator.style.display = 'flex';
          setTimeout(() => {
            indicator.style.display = 'none';
          }, 3000);
        }

        console.log('‚úÖ Flight details populated successfully');
      }

      // Create stop handler - saves address, airport, and FBO to trip table
      // Global edit state for stop editing (used by Edit buttons in the table)
      if (typeof window.editingStopId === 'undefined') {
        window.editingStopId = null;
      }
      function handleCreateStop() {
        console.log('‚ûï handleCreateStop called!');
        
        // Get form values - use currentStopType from routing panel (new UI) or fallback to radio buttons
        const radioBtn = document.querySelector('input[name="stopType"]:checked');
        const stopType = radioBtn ? radioBtn.value : (window.reservationFormInstance?.currentStopType || 'pickup');
        console.log('üìã Stop type:', stopType);
        const locationName = document.getElementById('locationName').value.trim();
        const address1 = document.getElementById('address1').value.trim();
        
        // Get airport and FBO fields - these may not exist in all layouts
        const airportSelectEl = document.getElementById('airportSelect');
        const airportCode = airportSelectEl ? airportSelectEl.value.trim() : '';
        const airlineCodeEl = document.getElementById('airlineCode');
        const airlineCode = airlineCodeEl ? airlineCodeEl.value.trim() : '';
        const flightNumberEl = document.getElementById('flightNumber');
        const flightNumber = flightNumberEl ? flightNumberEl.value.trim() : '';
        const terminalGateEl = document.getElementById('terminalGate');
        const terminalGate = terminalGateEl ? terminalGateEl.value.trim() : '';
        const flightStatusEl = document.getElementById('flightStatus');
        const flightStatus = flightStatusEl ? flightStatusEl.value.trim() : '';
        const fboSelectEl = document.getElementById('fboSelect');
        const fboSelect = fboSelectEl ? fboSelectEl.value.trim() : '';
        
        // Get FBO info from selected option if available
        let fboInfo = null;
        if (fboSelect && fboSelectEl && fboSelectEl.selectedOptions && fboSelectEl.selectedOptions[0]) {
          const opt = fboSelectEl.selectedOptions[0];
          fboInfo = {
            name: opt.dataset.name || opt.textContent || '',
            address: opt.dataset.address || '',
            city: opt.dataset.city || '',
            state: opt.dataset.state || '',
            zip: opt.dataset.zip || '',
            phone: opt.dataset.phone || '',
            email: opt.dataset.email || '',
            services: opt.dataset.services || ''
          };
        }
        
        console.log('üìù Form values - locationName:', locationName, 'address1:', address1);
        console.log('‚úàÔ∏è Airport values - code:', airportCode, 'airline:', airlineCode, 'flight:', flightNumber);
        console.log('üõ©Ô∏è FBO values - fboSelect:', fboSelect, 'fboInfo:', fboInfo);
        
        // Validate - need either location name or address (unless airport or FBO)
        if (!locationName && !address1 && !airportCode && !fboSelect) {
          console.log('‚ö†Ô∏è Need location name, address, airport, or FBO');
          alert('Please enter a location name, address, select an airport, or select an FBO.');
          return;
        }
        console.log('‚úÖ Validation passed, proceeding to create stop');
        
        // Get all form values (with null safety for optional fields)
        const address2El = document.getElementById('address2');
        const address2 = address2El ? address2El.value.trim() : '';
        const cityEl = document.getElementById('city');
        const city = cityEl ? cityEl.value.trim() : '';
        const stateEl = document.getElementById('state');
        const state = stateEl ? stateEl.value.trim() : '';
        const zipCodeEl = document.getElementById('zipCode');
        const zipCode = zipCodeEl ? zipCodeEl.value.trim() : '';
        const countryEl = document.getElementById('country');
        const country = countryEl ? countryEl.value.trim() : 'US';
        const phoneEl = document.getElementById('locationPhone');
        const phone = phoneEl ? phoneEl.value.trim() : '';
        const notesEl = document.getElementById('locationNotes');
        const notes = notesEl ? notesEl.value.trim() : '';
        const timeInEl = document.getElementById('timeIn');
        const timeIn = timeInEl ? timeInEl.value.trim() : '';
        
        console.log('üìã All form values:', { locationName, address1, address2, city, state, zipCode, country, phone, notes, timeIn });
        
        // Build full address
        let fullAddress = address1;
        if (address2) fullAddress += `, ${address2}`;
        if (city) fullAddress += `, ${city}`;
        if (state) fullAddress += ` ${state}`;
        if (zipCode) fullAddress += ` ${zipCode}`;
        if (country && country !== 'US') fullAddress += `, ${country}`;
        
        console.log('üèóÔ∏è Built full address:', fullAddress);
        
        // Create / update stop object with ALL details including airport and FBO
        const isEditing = !!window.editingStopId;
        const stopId = isEditing ? window.editingStopId : ('stop_' + Date.now());
        console.log('üÜî Generated stopId:', stopId, 'isEditing:', isEditing);
        
        const stopData = {
          id: stopId,
          stopType: stopType,
          locationName: locationName || (fboInfo?.name) || (airportCode ? `Airport: ${airportCode}` : ''),
          address1: address1 || (fboInfo?.address) || '',
          address2: address2 || (fboInfo?.address ? '' : ''),
          city: city || (fboInfo?.city) || '',
          state: state || (fboInfo?.state) || '',
          zipCode: zipCode || (fboInfo?.zip) || '',
          country: country || 'US',
          phone: phone || (fboInfo?.phone) || '',
          notes: notes || (fboInfo?.services ? `Services: ${fboInfo.services}` : ''),
          timeIn: timeIn,
          fullAddress: fullAddress || (fboInfo ? `${fboInfo.address}, ${fboInfo.city}, ${fboInfo.state} ${fboInfo.zip}` : ''),
          // Airport info
          airportCode: airportCode,
          airline: airlineCode,
          flightNumber: flightNumber,
          terminalGate: terminalGate,
          flightStatus: flightStatus,
          // FBO info
          fboId: fboSelect,
          fboName: fboInfo?.name || '',
          fboEmail: fboInfo?.email || '',
          createdAt: new Date().toISOString()
        };
        console.log('üì¶ Created stopData object:', stopData);

        // Save to global trips array
        if (isEditing) {
          const idx = tripStops.findIndex(stop => stop && stop.id === stopId);
          if (idx >= 0) tripStops[idx] = stopData;
          else tripStops.push(stopData);
        } else {
          tripStops.push(stopData);
        }
        console.log('üíæ Stop saved to tripStops:', tripStops);

        // Get table body
        const tableBody = document.getElementById('addressTableBody');
        console.log('üìä Table body found:', !!tableBody);
        
        // Remove empty row if it exists
        const emptyRow = tableBody.querySelector('.empty-row');
        if (emptyRow) {
          emptyRow.remove();
          console.log('üóëÔ∏è Removed empty row');
        }

        // Create or update row with stop type badge
        const existingRow = document.getElementById(stopId);
        const row = existingRow || document.createElement('tr');
        row.id = stopId;
        row.dataset.stopId = stopId;
        console.log('üèóÔ∏è Creating/updating table row with ID:', stopId);
        // Store full stop data for reliable save/load
        row.dataset.stopType = stopData.stopType || '';
        row.dataset.locationName = stopData.locationName || '';
        row.dataset.address1 = stopData.address1 || '';
        row.dataset.address2 = stopData.address2 || '';
        row.dataset.city = stopData.city || '';
        row.dataset.state = stopData.state || '';
        row.dataset.zipCode = stopData.zipCode || '';
        row.dataset.country = stopData.country || '';
        row.dataset.phone = stopData.phone || '';
        row.dataset.notes = stopData.notes || '';
        row.dataset.timeIn = stopData.timeIn || '';
        row.dataset.fullAddress = stopData.fullAddress || '';
        row.dataset.airportCode = stopData.airportCode || '';
        row.dataset.airline = stopData.airline || '';
        row.dataset.flightNumber = stopData.flightNumber || '';
        row.dataset.terminalGate = stopData.terminalGate || '';
        row.dataset.flightStatus = stopData.flightStatus || '';
        row.dataset.fboId = stopData.fboId || '';
        row.dataset.fboName = stopData.fboName || '';
        row.dataset.fboEmail = stopData.fboEmail || '';
        const badgeColor = 
          stopType === 'pickup' ? '#28a745' :
          stopType === 'dropoff' ? '#dc3545' :
          stopType === 'stop' ? '#ffc107' :
          '#17a2b8';
        
        // Build display content with airport and FBO info
        let displayAddress = fullAddress;
        let displayExtras = '';
        
        if (airportCode) {
          displayAddress = `‚úàÔ∏è ${airportCode} Airport`;
          displayExtras = `<div style="font-size: 11px; color: #005aa3; margin-top: 3px; font-weight: 500;">
            Flight: ${airlineCode}${flightNumber} | Terminal: ${terminalGate} | Status: ${flightStatus}
          </div>`;
        }
        
        if (fboInfo) {
          displayAddress = `üõ©Ô∏è ${fboInfo.name}`;
          displayExtras = `<div style="font-size: 11px; color: #005aa3; margin-top: 3px;">
            ${fboInfo.address} | üìû ${fboInfo.phone}
          </div>`;
        }
        
        row.innerHTML = `
          <td><span class="stop-type-badge" style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: 600;">${stopType.toUpperCase()}</span></td>
          <td><strong>${stopData.locationName || 'Address'}</strong></td>
          <td>
            <div>${displayAddress}</div>
            <div style="font-size: 11px; color: #666; margin-top: 3px;">
              ${phone ? 'üìû ' + phone + ' | ' : ''}
              ${timeIn ? '‚è∞ ' + timeIn : ''}
            </div>
            ${displayExtras}
            ${notes ? '<div style="font-size: 11px; color: #666; margin-top: 3px; font-style: italic;">üìù ' + notes + '</div>' : ''}
          </td>
          <td>${timeIn || 'N/A'}</td>
          <td>
            <button class="btn-edit" style="padding: 4px 8px; font-size: 12px; cursor: pointer; margin-right: 6px;" onclick="editStop('${stopId}')">Edit</button>
            <button class="btn-remove" style="padding: 4px 8px; font-size: 12px; cursor: pointer;" onclick="removeStop('${stopId}')">‚úï Remove</button>
          </td>
        `;
        console.log('üìã Row HTML created:', row.innerHTML.substring(0, 200) + '...');

        if (!existingRow) {
          tableBody.appendChild(row);
          console.log('‚ûï New row added to table, total rows now:', tableBody.children.length);
        } else {
          console.log('üîÑ Existing row updated');
        }
        console.log('üéØ Final row element:', row);
        console.log('‚úÖ Stop added to trip table with stopType:', stopType);

        // Refresh route metrics so distance/duration and quantities stay in sync
        try {
          console.log('üîÑ Refreshing route metrics...');
          console.log('üìä window.reservationFormInstance:', window.reservationFormInstance);
          console.log('üìä updateTripMetricsFromStops exists:', typeof window.reservationFormInstance?.updateTripMetricsFromStops);
          
          if (window.reservationFormInstance && typeof window.reservationFormInstance.updateTripMetricsFromStops === 'function') {
            console.log('üöÄ Calling updateTripMetricsFromStops...');
            window.reservationFormInstance.updateTripMetricsFromStops()
              .then(() => console.log('‚úÖ Route metrics calculation complete'))
              .catch(err => console.error('‚ùå Route metrics calculation failed:', err));
          } else {
            console.warn('‚ö†Ô∏è reservationFormInstance or updateTripMetricsFromStops not available');
            console.log('üìä Available on window.reservationFormInstance:', Object.keys(window.reservationFormInstance || {}));
          }
        } catch (err) {
          console.error('‚ùå Failed to refresh route metrics after adding stop:', err);
        }

        // Clear the form (with null safety)
        const clearField = (id) => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        };
        clearField('locationName');
        clearField('address1');
        clearField('address2');
        clearField('city');
        clearField('state');
        clearField('zipCode');
        clearField('locationNotes');
        clearField('locationPhone');
        clearField('timeIn');
        clearField('airportSearch');
        clearField('airportSelect');
        clearField('airlineSearch');
        clearField('airlineCode');
        clearField('airlineName');
        clearField('flightNumber');
        clearField('terminalGate');
        clearField('flightStatus');
        clearField('fboSelect');
        console.log('üßπ Form cleared successfully');
        
        // Reset stop type radio if it exists, or reset routing panel state
        const pickupRadio = document.querySelector('input[name="stopType"][value="pickup"]');
        if (pickupRadio) pickupRadio.checked = true;
        if (window.reservationFormInstance) window.reservationFormInstance.currentStopType = 'pickup';

        // Close the entry card (new routing panel UI)
        const entryCard = document.getElementById('addressEntryCard');
        if (entryCard) entryCard.style.display = 'none';

        // Clear edit state
        window.editingStopId = null;

        // Show success feedback on the button
        const createBtn = document.getElementById('createStopBtn');
        const originalText = 'CREATE';
        createBtn.textContent = existingRow ? '‚úì Updated!' : '‚úì Added!';
        createBtn.style.background = '#28a745';
        createBtn.style.color = 'white';
        
        setTimeout(() => {
          createBtn.textContent = originalText;
          createBtn.style.background = '';
          createBtn.style.color = '';
        }, 1500);

        console.log('‚úÖ Form cleared and ready for next stop');
      }

      // Expose handleCreateStop globally so reservation-form.js can use it
      window.handleCreateStop = handleCreateStop;

      // Edit stop: load saved row data back into the address entry form
      function editStop(stopId) {
        console.log('‚úèÔ∏è Editing stop:', stopId);
        window.editingStopId = stopId;

        const row = document.getElementById(stopId);
        if (!row) return;

        const get = (k) => (row.dataset?.[k] || '').toString();

        const stopType = (get('stopType') || 'stop').toLowerCase().trim();
        
        // Set stop type via radio buttons if they exist, or via routing panel state
        const typeEl = document.querySelector(`input[name="stopType"][value="${stopType}"]`);
        if (typeEl) typeEl.checked = true;
        if (window.reservationFormInstance) window.reservationFormInstance.currentStopType = stopType;
        
        // Open the entry card for editing (new routing panel UI)
        const entryCard = document.getElementById('addressEntryCard');
        const entryLabel = document.getElementById('entryTypeLabel');
        if (entryCard) entryCard.style.display = 'block';
        if (entryLabel) {
          const labels = { pickup: 'üìç Editing: Pick-up', dropoff: 'üéØ Editing: Drop-off', stop: '‚è∏Ô∏è Editing: Stop', wait: '‚è±Ô∏è Editing: Wait' };
          entryLabel.textContent = labels[stopType] || 'Editing Location';
        }

        const setVal = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.value = value || '';
        };

        setVal('locationName', get('locationName'));
        setVal('address1', get('address1'));
        setVal('address2', get('address2'));
        setVal('city', get('city'));
        setVal('state', get('state'));
        setVal('zipCode', get('zipCode'));
        setVal('country', get('country') || 'US');
        setVal('locationPhone', get('phone'));
        setVal('locationNotes', get('notes'));
        setVal('timeIn', get('timeIn'));

        // Airport fields (best effort)
        const airportCode = get('airportCode');
        if (airportCode) {
          try {
            const radio = document.getElementById('airport');
            if (radio) radio.checked = true;
            if (typeof handleLocationTypeChange === 'function') handleLocationTypeChange('airport');
          } catch { /* ignore */ }
          setVal('airportSelect', airportCode);
          setVal('airportSearch', `${airportCode} - Airport`);
          const airlineSection = document.getElementById('airlineSection');
          if (airlineSection) airlineSection.style.display = 'block';
          setVal('airlineCode', get('airline'));
          setVal('airlineSearch', get('airline'));
          setVal('flightNumber', get('flightNumber'));
          setVal('terminalGate', get('terminalGate'));
          setVal('flightStatus', get('flightStatus'));
        }

        // FBO fields (best effort)
        const fboId = get('fboId');
        if (fboId) {
          try {
            const radio = document.getElementById('fbo');
            if (radio) radio.checked = true;
            if (typeof handleLocationTypeChange === 'function') handleLocationTypeChange('fbo');
          } catch { /* ignore */ }
          setVal('fboSelect', fboId);
          try {
            if (typeof handleFBOSelection === 'function') handleFBOSelection(fboId);
          } catch { /* ignore */ }
        }

        // Switch button to UPDATE mode
        const createBtn = document.getElementById('createStopBtn');
        if (createBtn) {
          createBtn.textContent = 'UPDATE';
          createBtn.style.background = '#ffc107';
          createBtn.style.color = '#333';
        }
      }

      // Remove stop from table and data array
      function removeStop(stopId) {
        console.log('üóëÔ∏è Removing stop:', stopId);

        // Cancel edit mode if we're deleting the row being edited
        if (window.editingStopId === stopId) {
          window.editingStopId = null;
          const createBtn = document.getElementById('createStopBtn');
          if (createBtn) {
            createBtn.textContent = 'CREATE';
            createBtn.style.background = '';
            createBtn.style.color = '';
          }
        }
        
        // Remove from DOM
        const row = document.getElementById(stopId);
        if (row) {
          row.remove();
        }

        // Remove from tripStops array
        tripStops = tripStops.filter(stop => stop.id !== stopId);
        console.log('‚úÖ Stop removed, remaining stops:', tripStops);

        // Show empty state if no stops left
        const tableBody = document.getElementById('addressTableBody');
        if (tableBody.children.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.className = 'empty-row';
          emptyRow.innerHTML = '<td colspan="5" class="empty-message">No addresses added yet. Use the form below to add addresses.</td>';
          tableBody.appendChild(emptyRow);
        }

        // Recompute route metrics after stop removal
        try {
          window.reservationFormInstance?.updateTripMetricsFromStops?.();
        } catch (err) {
          console.warn('‚ö†Ô∏è Failed to refresh route metrics after removing stop:', err);
        }
      }

      // Location search handler - searches for businesses and landmarks
      function handleLocationSearch(query) {
        console.log('üîç Searching locations:', query);
        
        // Clear previous timeout
        clearTimeout(locationSearchTimeout);
        
        if (query.length < 2) {
          document.getElementById('locationNameSuggestions').classList.remove('active');
          return;
        }

        // Debounce API call - wait 300ms after user stops typing
        locationSearchTimeout = setTimeout(() => {
          console.log('üì° Calling location API for:', query);
          searchNominatimLocations(query)
            .then(results => {
              console.log('‚úÖ Location results received:', results);
              displayLocationSuggestions(results);
            })
            .catch(error => {
              console.error('‚ùå Location search error:', error);
              document.getElementById('locationNameSuggestions').innerHTML = '<div style="padding: 10px 12px; color: #d00; font-size: 12px;">Error searching locations. Try again.</div>';
              document.getElementById('locationNameSuggestions').classList.add('active');
            });
        }, 300);
      }

      // Address search handler - searches for street addresses
      function handleAddressSearch(query) {
        console.log('üîç Searching addresses:', query);
        
        // Clear previous timeout
        clearTimeout(addressSearchTimeout);
        
        if (query.length < 3) {
          document.getElementById('addressSuggestions').classList.remove('active');
          return;
        }

        // Debounce API call - wait 300ms after user stops typing
        addressSearchTimeout = setTimeout(() => {
          console.log('üì° Calling address API for:', query);
          searchNominatimAddresses(query)
            .then(results => {
              console.log('‚úÖ Address results received:', results);
              displayAddressSuggestions(results);
            })
            .catch(error => {
              console.error('‚ùå Address search error:', error);
              document.getElementById('addressSuggestions').innerHTML = '<div style="padding: 10px 12px; color: #d00; font-size: 12px;">Error searching addresses. Try again.</div>';
              document.getElementById('addressSuggestions').classList.add('active');
            });
        }, 300);
      }

      // Search Nominatim API for locations and businesses
      async function searchNominatimLocations(query) {
        try {
          console.log('üåê Fetching from Nominatim API (locations)...');
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=8&type=amenity,tourism,shop,hotel,restaurant`,
            {
              headers: {
                'User-Agent': 'RELIA-LIMO-RESERVATION/1.0'
              }
            }
          );
          
          if (!response.ok) {
            console.error('API response not ok:', response.status);
            throw new Error(`API error: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('‚úÖ Nominatim location results:', data);
          
          if (!Array.isArray(data)) {
            console.error('Unexpected response format:', data);
            return [];
          }
          
          return data;
        } catch (error) {
          console.error('‚ùå Nominatim API error:', error);
          throw error;
        }
      }

      // Search Nominatim API for addresses
      async function searchNominatimAddresses(query) {
        try {
          console.log('üåê Fetching from Nominatim API (addresses)...');
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=8`,
            {
              headers: {
                'User-Agent': 'RELIA-LIMO-RESERVATION/1.0'
              }
            }
          );
          
          if (!response.ok) {
            console.error('API response not ok:', response.status);
            throw new Error(`API error: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('‚úÖ Nominatim address results:', data);
          
          if (!Array.isArray(data)) {
            console.error('Unexpected response format:', data);
            return [];
          }
          
          return data;
        } catch (error) {
          console.error('‚ùå Nominatim API error:', error);
          throw error;
        }
      }

      // Display location suggestions
      function displayLocationSuggestions(results) {
        const container = document.getElementById('locationNameSuggestions');
        
        if (!results || results.length === 0) {
          container.innerHTML = '<div style="padding: 10px 12px; color: #999; font-size: 12px;">No locations found. Try a different search.</div>';
          container.classList.add('active');
          console.log('No results to display');
          return;
        }

        console.log('Displaying', results.length, 'location suggestions');
        
        try {
          container.innerHTML = results.slice(0, 8).map((result, index) => {
            const resultStr = JSON.stringify(result).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            return `
              <div class="location-suggestion-item" onclick="selectLocationSuggestion(${index}, JSON.parse('${resultStr}'))">
                <div style="font-weight: 600; color: #333; font-size: 13px;">${result.name || 'Unknown'}</div>
                <div style="font-size: 11px; color: #666;">
                  ${result.address?.suburb || result.address?.city || ''} ${result.address?.state || ''} ${result.address?.postcode || ''}
                </div>
                <div style="font-size: 10px; color: #999;">
                  ${result.type || 'Location'} ‚Ä¢ Lat: ${parseFloat(result.lat).toFixed(4)}, Lon: ${parseFloat(result.lon).toFixed(4)}
                </div>
              </div>
            `;
          }).join('');

          container.classList.add('active');
        } catch (error) {
          console.error('Error rendering suggestions:', error);
          container.innerHTML = '<div style="padding: 10px 12px; color: #d00; font-size: 12px;">Error displaying results.</div>';
          container.classList.add('active');
        }
      }

      // Display address suggestions
      function displayAddressSuggestions(results) {
        const container = document.getElementById('addressSuggestions');
        
        if (!results || results.length === 0) {
          container.innerHTML = '<div style="padding: 10px 12px; color: #999; font-size: 12px;">No addresses found. Try a different search.</div>';
          container.classList.add('active');
          console.log('No results to display');
          return;
        }

        console.log('Displaying', results.length, 'address suggestions');
        
        try {
          container.innerHTML = results.slice(0, 8).map((result, index) => {
            const resultStr = JSON.stringify(result).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            return `
              <div class="address-suggestion-item" onclick="selectAddressSuggestion(${index}, JSON.parse('${resultStr}'))">
                <div style="font-weight: 600; color: #333; font-size: 13px;">${result.address?.road || result.name || 'Address'}</div>
                <div style="font-size: 11px; color: #666;">
                  ${result.address?.city || result.address?.town || ''}, 
                  ${result.address?.state || ''} 
                  ${result.address?.postcode || ''}
                </div>
                <div style="font-size: 10px; color: #999;">
                  ${result.address?.country || 'Unknown'} ‚Ä¢ Lat: ${parseFloat(result.lat).toFixed(4)}, Lon: ${parseFloat(result.lon).toFixed(4)}
                </div>
              </div>
            `;
          }).join('');

          container.classList.add('active');
        } catch (error) {
          console.error('Error rendering suggestions:', error);
          container.innerHTML = '<div style="padding: 10px 12px; color: #d00; font-size: 12px;">Error displaying results.</div>';
          container.classList.add('active');
        }
      }

      // Select location suggestion
      function selectLocationSuggestion(index, result) {
        console.log('‚úÖ Selected location:', result);
        
        // Populate location name
        document.getElementById('locationName').value = result.name || '';
        
        // Populate address details
        const address = result.address || {};
        document.getElementById('address1').value = address.road ? address.road : (address.footway || '');
        document.getElementById('address2').value = address.house_number || '';
        document.getElementById('city').value = address.city || address.town || address.suburb || '';
        
        // Set state/province
        const stateSelect = document.getElementById('state');
        if (address.state) {
          // Try to find matching state code
          const stateCode = address.state.substring(0, 2).toUpperCase();
          stateSelect.value = stateCode;
        }
        
        document.getElementById('zipCode').value = address.postcode || '';
        document.getElementById('country').value = address.country_code ? address.country_code.toUpperCase() : 'US';
        
        // Clear suggestions immediately
        document.getElementById('locationNameSuggestions').classList.remove('active');
        document.getElementById('locationNameSuggestions').innerHTML = '';
        
        console.log('‚úÖ Location details populated and suggestions cleared');
      }

      // Select address suggestion
      function selectAddressSuggestion(index, result) {
        console.log('‚úÖ Selected address:', result);
        
        // Populate address details
        const address = result.address || {};
        document.getElementById('address1').value = address.road || '';
        document.getElementById('address2').value = address.house_number || '';
        document.getElementById('city').value = address.city || address.town || address.suburb || '';
        
        // Set state/province
        const stateSelect = document.getElementById('state');
        if (address.state) {
          const stateCode = address.state.substring(0, 2).toUpperCase();
          stateSelect.value = stateCode;
        }
        
        document.getElementById('zipCode').value = address.postcode || '';
        document.getElementById('country').value = address.country_code ? address.country_code.toUpperCase() : 'US';
        
        // Auto-populate location name if empty
        if (!document.getElementById('locationName').value) {
          document.getElementById('locationName').value = result.name || (address.road + ' ' + (address.house_number || ''));
        }
        
        // Clear suggestions immediately
        document.getElementById('addressSuggestions').classList.remove('active');
        document.getElementById('addressSuggestions').innerHTML = '';
        
        console.log('‚úÖ Address details populated and suggestions cleared');
      }

      // FBO selection handler
      function handleFBOSelection(fboId) {
        console.log('üõ©Ô∏è FBO selected:', fboId);
        
        if (!fboId) {
          console.log('No FBO selected');
          return;
        }

        const fboData = fboDatabase[fboId];
        if (!fboData) {
          console.log('FBO not found in database');
          return;
        }

        // Auto-populate FBO details into the address form
        console.log('üìù Auto-populating FBO details:', fboData);
        
        // Set location name
        const locationNameInput = document.getElementById('locationName');
        if (locationNameInput) {
          locationNameInput.value = fboData.name;
        }

        // Set address 1
        const address1Input = document.getElementById('address1');
        if (address1Input) {
          address1Input.value = fboData.address;
        }

        // Set city
        const cityInput = document.getElementById('city');
        if (cityInput) {
          cityInput.value = fboData.city;
        }

        // Set state
        const stateInput = document.getElementById('state');
        if (stateInput) {
          stateInput.value = 'MN';
        }

        // Set zip code
        const zipInput = document.getElementById('zipCode');
        if (zipInput) {
          zipInput.value = fboData.zip;
        }

        // Set phone number
        const phoneInput = document.getElementById('locationPhone');
        if (phoneInput) {
          phoneInput.value = fboData.phone;
        }

        // Set services in location notes
        const notesInput = document.getElementById('locationNotes');
        if (notesInput) {
          notesInput.value = `Services: ${fboData.services}\nEmail: ${fboData.email}`;
        }

        // Show success feedback
        const fboSelect = document.getElementById('fboSelect');
        const originalStyle = fboSelect.style.backgroundColor;
        fboSelect.style.backgroundColor = '#d4edda';
        
        setTimeout(() => {
          fboSelect.style.backgroundColor = originalStyle;
        }, 1500);

        console.log('‚úÖ FBO details auto-populated successfully');
      }
    </script>
    <script src="env.js"></script>
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="reservation-form.js"></script>
    <script>
      // Fallback tab wiring so Primary/Secondary/Farm-out (and billing/assignment) work even if main module fails
      document.addEventListener('DOMContentLoaded', () => {
        const wireTabs = (btnSelector, panelSelector, keyAttr) => {
          const buttons = Array.from(document.querySelectorAll(btnSelector));
          const panels = Array.from(document.querySelectorAll(panelSelector));
          if (!buttons.length || !panels.length) return;
          buttons.forEach(btn => {
            btn.addEventListener('click', () => {
              const tab = btn.dataset[keyAttr];
              buttons.forEach(b => b.classList.remove('active'));
              panels.forEach(p => p.classList.remove('active'));
              btn.classList.add('active');
              const target = document.getElementById(`${tab}${panelSelector === '.cost-tab-content' ? 'CostTab' : keyAttr === 'billingTab' ? 'Tab' : 'Assignment'}`);
              if (target) target.classList.add('active');
            });
          });
        };

        wireTabs('.billing-tab', '.billing-tab-content', 'billingTab');
        wireTabs('.cost-tab', '.cost-tab-content', 'tab');
        wireTabs('.assignment-tab', '.assignment-content', 'tab');
      });
    </script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ChatManager.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ImageGenerator.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ProgressLogger.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/OGP.js"></script>
  </body>
</html>