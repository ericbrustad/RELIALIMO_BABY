<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Settings - RELIAüêÇLIMO‚Ñ¢</title>
  <script src="env.js"></script>
  <link rel="stylesheet" href="email-settings.css" />
  <style>
    .config-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-right: 10px;
    }
    .config-status.configured {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
    .config-status.not-configured {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    .config-status.partial {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffcc80;
    }
    .config-status .status-icon { font-size: 16px; }
    
    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 9999;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .toast.success {
      background: #2e7d32;
      color: white;
    }
    .toast.error {
      background: #c62828;
      color: white;
    }
    .toast.warning {
      background: #e65100;
      color: white;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <script>
    if (window.self !== window.top) {
      document.documentElement.classList.add('embedded');
      document.body.classList.add('embedded');
    }
  </script>
  <div class="email-settings-container">
    <aside class="settings-sidebar">
      <nav class="settings-nav">
        <a href="#" class="settings-nav-item">Contact Information</a>
        <a href="#" class="settings-nav-item">Company Preferences</a>
        <a href="#" class="settings-nav-item">System Users</a>
        <a href="#" class="settings-nav-item">Policies</a>
        <a href="#" class="settings-nav-item">ReadBack Script Templates</a>
        <a href="#" class="settings-nav-item">Messaging & Template Settings</a>
        <a href="#" class="settings-nav-item">Calendar Settings</a>
        <a href="#" class="settings-nav-item">Online Reservations</a>
        <a href="#" class="settings-nav-item">Payment Gateway</a>
        <a href="#" class="settings-nav-item">Third-party Plug-ins</a>
        <div class="settings-nav-section">
          <div class="settings-nav-item active-section">System Settings</div>
          <a href="service-types.html" class="settings-nav-subitem">Service Types</a>
          <a href="system-mapping.html" class="settings-nav-subitem">System Mapping</a>
          <a href="magic-link.html" class="settings-nav-subitem">Magic Link</a>
          <a href="sms-provider.html" class="settings-nav-subitem">Sms Provider</a>
          <a href="email-settings.html" class="settings-nav-subitem active">Email Settings</a>
          <a href="full-site-test-checklist.html" class="settings-nav-subitem">Test Checklist</a>
          <a href="test-supabase-integration.html" class="settings-nav-subitem">Supabase Integration Test</a>
          <a href="#" class="settings-nav-subitem">Digital Marketing</a>
        </div>
      </nav>
    </aside>

    <main class="email-settings-main">
      <header class="email-settings-header">
        <div>
          <h1 class="email-settings-title">Email Settings</h1>
          <p class="email-settings-subtitle">Configure outgoing email and manage HTML templates with trip and rate tags.</p>
        </div>
        <div class="header-actions">
          <div id="emailConfigStatus" class="config-status">
            <span class="status-icon">‚è≥</span>
            <span class="status-text">Checking...</span>
          </div>
          <button id="saveSettingsBtn" class="btn primary">üíæ Save Settings</button>
          <button id="saveSecureBtn" class="btn primary" style="background:#2e7d32;" title="Save to Supabase & create backup">üîí Save Secure</button>
          <button id="downloadEnvBtn" class="btn primary" style="background:#1565c0;" title="Download .env file">‚¨áÔ∏è Download .env</button>
          <button id="testSendBtn" class="btn secondary">üìß Test Email API</button>
        </div>
      </header>

      <section class="card">
        <div class="card-header">
          <h2>Email Test</h2>
        </div>
        <div class="card-body">
          <label class="form-row">Test Email Address
            <input id="testEmailInput" type="email" placeholder="test@example.com" />
          </label>
          <div class="hint">Uses /api/email-send endpoint with server environment variables for security.</div>
          <div class="hint" style="color: #2e7d32; margin-top: 8px;">
            <strong>Quick Setup:</strong> Run <code>npm install && npm start</code> in project root to start local server with email API.
          </div>
          <div class="hint" style="color: #f57c00; margin-top: 4px; font-size: 12px;">
            Alternative: Deploy to Vercel/Netlify for production use.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Outgoing Email (SMTP / Provider)</h2>
        </div>
        <div class="card-body grid-2">
          <label class="form-row">From Name
            <input id="fromNameInput" type="text" placeholder="Dispatch Team" />
          </label>
          <label class="form-row">From Email
            <input id="fromEmailInput" type="email" placeholder="dispatch@example.com" />
          </label>
          <label class="form-row">Reply-To
            <input id="replyToInput" type="email" placeholder="support@example.com" />
          </label>
          <label class="form-row">SMTP Host / API Endpoint
            <input id="smtpHostInput" type="text" placeholder="smtp.sendgrid.net" />
          </label>
          <label class="form-row">Port
            <input id="smtpPortInput" type="number" placeholder="587" />
          </label>
          <label class="form-row">Username
            <input id="smtpUserInput" type="text" placeholder="apikey or username" />
          </label>
          <label class="form-row">Password / Token
            <input id="smtpPassInput" type="password" placeholder="password or token" />
          </label>
          <label class="form-row checkbox-row">
            <input id="tlsInput" type="checkbox" /> Use TLS/STARTTLS
          </label>
        </div>
        <div class="card-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
          <button id="testEmailFormBtn" class="btn secondary" style="display: flex; align-items: center; gap: 6px;">
            üìß Send Test Email
          </button>
          <button id="saveEmailFormBtn" class="btn primary" style="display: flex; align-items: center; gap: 6px;">
            üíæ Save Email Settings
          </button>
        </div>
        <div class="hint">Saved locally only. Wire to your email provider backend to send for real.</div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Template Editor</h2>
          <div class="card-actions">
            <input id="templateNameInput" type="text" placeholder="Template name (e.g., Trip Confirmation)" />
            <button id="saveTemplateBtn" class="btn primary">Save Template</button>
          </div>
        </div>
        <div class="card-body">
          <label class="form-row">Subject
            <input id="subjectInput" type="text" placeholder="Your trip on #TRIP_DATE#" />
          </label>

          <div class="editor-toolbar">
            <div class="toolbar-left">
              <button data-cmd="bold" class="tool-btn">B</button>
              <button data-cmd="italic" class="tool-btn">I</button>
              <button data-cmd="underline" class="tool-btn">U</button>
              <button data-cmd="insertUnorderedList" class="tool-btn">‚Ä¢ List</button>
              <button data-cmd="insertOrderedList" class="tool-btn">1. List</button>
            </div>
            <div class="toolbar-right">
              <select id="tripTagSelect">
                <option value="">Insert Trip Tag‚Ä¶</option>
              </select>
              <select id="rateTagSelect">
                <option value="">Insert Rate Tag‚Ä¶</option>
              </select>
            </div>
          </div>

          <div id="templateEditor" class="editor" contenteditable="true">
            <p>Hello #TRIP_PAX_NAME#,</p>
            <p>Your trip #TRIP_CONFNUM# on #TRIP_DATE# at #TRIP_TIME# is confirmed.</p>
            <p>Pickup: #TRIP_PICKUP#<br/>Dropoff: #TRIP_DROPOFF#</p>
            <p>Total: #TRIP_RATES_TOTAL#</p>
            <p>Thank you!</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Saved Templates (local)</h2>
        </div>
        <div class="card-body" id="templateList"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Tag Reference</h2>
        </div>
        <div class="card-body tag-reference">
          <div>
            <h3>Trip Tags</h3>
            <ul id="tripTagList"></ul>
          </div>
          <div>
            <h3>Rate Tags</h3>
            <ul id="rateTagList"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="email-settings.js"></script>
  <script src="SecureSettingsManager.js"></script>
  <script>
    // Toast notification helper
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Direct Email Settings Save/Test (secure API approach)
    const EmailSettingsDirect = {
      STORAGE_KEY: 'emailSettings',
      
      // Test email via API (secure - uses server env vars)
      async testEmailAPI() {
        const testEmail = document.getElementById('testEmailInput')?.value?.trim();
        if (!testEmail) {
          showToast('‚ùå Enter a test email address', 'error');
          return;
        }
        
        if (!testEmail.includes('@')) {
          showToast('‚ùå Enter a valid email address', 'error');
          return;
        }
        
        const testBtn = document.getElementById('testSendBtn');
        const originalText = testBtn.textContent;
        testBtn.disabled = true;
        testBtn.textContent = 'üîÑ Sending...';
        
        try {
          const response = await fetch('/api/email-send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: testEmail,
              subject: 'ReliaLimo Email Test',
              html: `
                <h2>Email Test Successful!</h2>
                <p>If you received this email, your ReliaLimo email configuration is working correctly.</p>
                <p><strong>Sent at:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>From:</strong> ReliaLimo Email System</p>
                <hr>
                <p style="font-size: 12px; color: #666;">This is an automated test email.</p>
              `,
              text: 'ReliaLimo Email Test - If you got this, email sending works! Sent at: ' + new Date().toLocaleString()
            })
          });
          
          // Check if response is HTML (404 page) instead of JSON
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('text/html')) {
            throw new Error('API endpoint not available - configure email backend server');
          }
          
          const data = await response.json();
          
          if (response.ok && data.ok) {
            showToast(`‚úÖ Test email sent to ${testEmail}!`, 'success');
            console.log('Email sent successfully:', data);
            // Hide any error displays on success
            const errorDisplays = document.querySelectorAll('.error-display, .test-error');
            errorDisplays.forEach(el => el.style.display = 'none');
          } else {
            console.error('Email API error:', data);
            showToast(`‚ùå Email failed: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          console.error('Email test error:', error);
          
          // Handle specific error types
          if (error.message.includes('JSON')) {
            showToast('‚ùå API endpoint returned HTML - configure backend server', 'error');
          } else if (error.message.includes('fetch')) {
            showToast('‚ùå Network error - check API endpoint configuration', 'error');
          } else if (error.message.includes('API endpoint not available')) {
            showToast('‚ùå Email API not configured - deploy backend or use SMTP directly', 'error');
          } else {
            showToast(`‚ùå Error: ${error.message}`, 'error');
          }
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = originalText;
        }
      },
      
      // Save settings securely (localStorage only - sensitive data via env vars)
      saveEmailSettings() {
        const $ = id => document.getElementById(id)?.value?.trim() || '';
        
        const settings = {
          fromName: $('fromNameInput'),
          fromEmail: $('fromEmailInput'),
          replyTo: $('replyToInput'),
          smtpHost: $('smtpHostInput'),
          smtpPort: parseInt($('smtpPortInput')) || 0,
          smtpUser: $('smtpUserInput'),
          smtpPass: $('smtpPassInput'), // Note: This should be managed via env vars in production
          tls: document.getElementById('tlsInput')?.checked ?? true
        };
        
        // Basic validation
        if (!settings.fromEmail || !settings.fromEmail.includes('@')) {
          showToast('‚ùå Valid From Email is required', 'error');
          return false;
        }
        
        if (!settings.smtpHost) {
          showToast('‚ùå SMTP Host is required', 'error');
          return false;
        }
        
        if (settings.smtpPort <= 0) {
          showToast('‚ùå Valid SMTP Port is required', 'error');
          return false;
        }
        
        // Save to localStorage
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
        
        // Also save in legacy format for compatibility
        localStorage.setItem('emailSettingsConfig', JSON.stringify(settings));
        
        console.log('[Email] Settings saved:', { ...settings, smtpPass: '***' });
        
        // Trigger storage event
        window.dispatchEvent(new StorageEvent('storage', {
          key: this.STORAGE_KEY,
          newValue: JSON.stringify(settings)
        }));
        
        return true;
      },
      
      init() {
        console.log('[Email] Initializing EmailSettingsDirect...');
        
        // Wire up Test Email button
        const testBtn = document.getElementById('testSendBtn');
        if (testBtn) {
          testBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.testEmailAPI();
          });
        }
        
        // Wire up form Test Email button (duplicate functionality)
        const testFormBtn = document.getElementById('testEmailFormBtn');
        if (testFormBtn) {
          testFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.testEmailAPI();
          });
        }
        
        // Override the save settings button
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          // Remove existing event listeners by cloning the node
          const newSaveBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
          
          newSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.saveEmailSettings()) {
              showToast('‚úÖ Email settings saved!', 'success');
              // Re-check configuration status
              if (typeof EmailConfigChecker !== 'undefined') {
                EmailConfigChecker.checkConfiguration();
              }
            }
          });
        }
        
        // Wire up form Save Email Settings button (duplicate functionality)
        const saveFormBtn = document.getElementById('saveEmailFormBtn');
        if (saveFormBtn) {
          saveFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.saveEmailSettings()) {
              showToast('‚úÖ Email settings saved!', 'success');
              // Re-check configuration status
              if (typeof EmailConfigChecker !== 'undefined') {
                EmailConfigChecker.checkConfiguration();
              }
            }
          });
        }
        
        console.log('[Email] EmailSettingsDirect initialized');
      }
    };
    
    // Email Config Status Checker
    const EmailConfigChecker = {
      checkConfiguration() {
        const statusEl = document.getElementById('emailConfigStatus');
        if (!statusEl) return;
        
        const smtpHost = document.getElementById('smtpHostInput')?.value?.trim() || '';
        const smtpPort = document.getElementById('smtpPortInput')?.value?.trim() || '';
        const fromEmail = document.getElementById('fromEmailInput')?.value?.trim() || '';
        
        const checks = [
          { name: 'SMTP Host', valid: smtpHost.length > 3 },
          { name: 'SMTP Port', valid: parseInt(smtpPort) > 0 },
          { name: 'From Email', valid: fromEmail.includes('@') }
        ];
        
        const validCount = checks.filter(c => c.valid).length;
        const allValid = validCount === 3;
        const partialValid = validCount > 0 && validCount < 3;
        
        if (allValid) {
          statusEl.className = 'config-status configured';
          statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Email Configured</span>';
        } else if (partialValid) {
          statusEl.className = 'config-status partial';
          statusEl.innerHTML = `<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">Partial (${validCount}/3)</span>`;
        } else {
          statusEl.className = 'config-status not-configured';
          statusEl.innerHTML = '<span class="status-icon">‚ùå</span><span class="status-text">Not Configured</span>';
        }
      },
      
      init() {
        setTimeout(() => this.checkConfiguration(), 100);
        
        const inputs = ['smtpHostInput', 'smtpPortInput', 'fromEmailInput'];
        inputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', () => this.checkConfiguration());
            el.addEventListener('change', () => this.checkConfiguration());
          }
        });
        
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            setTimeout(() => this.checkConfiguration(), 200);
          });
        }
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      EmailSettingsDirect.init();
      EmailConfigChecker.init();
      
      // Save Secure button
      const saveSecureBtn = document.getElementById('saveSecureBtn');
      if (saveSecureBtn) {
        saveSecureBtn.addEventListener('click', async () => {
          saveSecureBtn.disabled = true;
          saveSecureBtn.textContent = 'üîÑ Saving...';
          
          try {
            // First save locally
            if (!EmailSettingsDirect.saveEmailSettings()) {
              saveSecureBtn.disabled = false;
              saveSecureBtn.textContent = 'üîí Save Secure';
              return;
            }
            
            await new Promise(r => setTimeout(r, 100));
            
            if (window.SecureSettingsManager) {
              const result = await window.SecureSettingsManager.saveSecurely();
              
              if (result.saved) {
                if (result.supabase) {
                  showToast('‚úÖ Saved to Supabase + local backup', 'success');
                } else {
                  showToast('‚úÖ Saved to local backup', 'success');
                }
              } else {
                showToast('‚ö†Ô∏è ' + (result.reason || 'Check configuration'), 'warning');
              }
            } else {
              showToast('‚úÖ Settings saved locally', 'success');
            }
          } catch (e) {
            console.error('Save secure error:', e);
            showToast('‚ùå Error: ' + e.message, 'error');
          } finally {
            saveSecureBtn.disabled = false;
            saveSecureBtn.textContent = 'üîí Save Secure';
            if (typeof EmailConfigChecker !== 'undefined') {
              EmailConfigChecker.checkConfiguration();
            }
          }
        });
      }
      
      // Download .env button
      const downloadEnvBtn = document.getElementById('downloadEnvBtn');
      if (downloadEnvBtn) {
        downloadEnvBtn.addEventListener('click', () => {
          if (window.SecureSettingsManager) {
            const status = window.SecureSettingsManager.getStatus();
            
            if (!status.sms.configured && !status.email.configured) {
              if (!confirm('No settings are fully configured yet. Download anyway?')) {
                return;
              }
            }
            
            window.SecureSettingsManager.downloadEnvFile();
            showToast('üì• .env file downloaded', 'success');
          } else {
            showToast('‚ùå SecureSettingsManager not loaded', 'error');
          }
        });
      }
    });
  </script>
</body>
</html>
