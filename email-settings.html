<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Settings - RELIAüêÇLIMO‚Ñ¢</title>
  <script src="env.js"></script>
  <link rel="stylesheet" href="email-settings.css" />
  <style>
    .config-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-right: 10px;
    }
    .config-status.configured {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
    .config-status.not-configured {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    .config-status.partial {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffcc80;
    }
    .config-status .status-icon { font-size: 16px; }
  </style>
</head>
<body>
  <script>
    if (window.self !== window.top) {
      document.documentElement.classList.add('embedded');
      document.body.classList.add('embedded');
    }
  </script>
  <div class="email-settings-container">
    <aside class="settings-sidebar">
      <nav class="settings-nav">
        <a href="#" class="settings-nav-item">Contact Information</a>
        <a href="#" class="settings-nav-item">Company Preferences</a>
        <a href="#" class="settings-nav-item">System Users</a>
        <a href="#" class="settings-nav-item">Policies</a>
        <a href="#" class="settings-nav-item">ReadBack Script Templates</a>
        <a href="#" class="settings-nav-item">Messaging & Template Settings</a>
        <a href="#" class="settings-nav-item">Calendar Settings</a>
        <a href="#" class="settings-nav-item">Online Reservations</a>
        <a href="#" class="settings-nav-item">Payment Gateway</a>
        <a href="#" class="settings-nav-item">Third-party Plug-ins</a>
        <div class="settings-nav-section">
          <div class="settings-nav-item active-section">System Settings</div>
          <a href="service-types.html" class="settings-nav-subitem">Service Types</a>
          <a href="system-mapping.html" class="settings-nav-subitem">System Mapping</a>
          <a href="magic-link.html" class="settings-nav-subitem">Magic Link</a>
          <a href="sms-provider.html" class="settings-nav-subitem">Sms Provider</a>
          <a href="email-settings.html" class="settings-nav-subitem active">Email Settings</a>
          <a href="full-site-test-checklist.html" class="settings-nav-subitem">Test Checklist</a>
          <a href="test-supabase-integration.html" class="settings-nav-subitem">Supabase Integration Test</a>
          <a href="#" class="settings-nav-subitem">Digital Marketing</a>
        </div>
      </nav>
    </aside>

    <main class="email-settings-main">
      <header class="email-settings-header">
        <div>
          <h1 class="email-settings-title">Email Settings</h1>
          <p class="email-settings-subtitle">Configure outgoing email and manage HTML templates with trip and rate tags.</p>
        </div>
        <div class="header-actions">
          <div id="emailConfigStatus" class="config-status">
            <span class="status-icon">‚è≥</span>
            <span class="status-text">Checking...</span>
          </div>
          <button id="saveSettingsBtn" class="btn primary">üíæ Save Settings</button>
          <button id="saveSecureBtn" class="btn primary" style="background:#2e7d32;" title="Save to Supabase & create backup">üîí Save Secure</button>
          <button id="downloadEnvBtn" class="btn primary" style="background:#1565c0;" title="Download .env file">‚¨áÔ∏è Download .env</button>
          <button id="testSendBtn" class="btn secondary">Test Send (local)</button>
        </div>
      </header>

      <section class="card">
        <div class="card-header">
          <h2>Outgoing Email (SMTP / Provider)</h2>
        </div>
        <div class="card-body grid-2">
          <label class="form-row">From Name
            <input id="fromNameInput" type="text" placeholder="Dispatch Team" />
          </label>
          <label class="form-row">From Email
            <input id="fromEmailInput" type="email" placeholder="dispatch@example.com" />
          </label>
          <label class="form-row">Reply-To
            <input id="replyToInput" type="email" placeholder="support@example.com" />
          </label>
          <label class="form-row">SMTP Host / API Endpoint
            <input id="smtpHostInput" type="text" placeholder="smtp.sendgrid.net" />
          </label>
          <label class="form-row">Port
            <input id="smtpPortInput" type="number" placeholder="587" />
          </label>
          <label class="form-row">Username
            <input id="smtpUserInput" type="text" placeholder="apikey or username" />
          </label>
          <label class="form-row">Password / Token
            <input id="smtpPassInput" type="password" placeholder="password or token" />
          </label>
          <label class="form-row checkbox-row">
            <input id="tlsInput" type="checkbox" /> Use TLS/STARTTLS
          </label>
        </div>
        <div class="hint">Saved locally only. Wire to your email provider backend to send for real.</div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Template Editor</h2>
          <div class="card-actions">
            <input id="templateNameInput" type="text" placeholder="Template name (e.g., Trip Confirmation)" />
            <button id="saveTemplateBtn" class="btn primary">Save Template</button>
          </div>
        </div>
        <div class="card-body">
          <label class="form-row">Subject
            <input id="subjectInput" type="text" placeholder="Your trip on #TRIP_DATE#" />
          </label>

          <div class="editor-toolbar">
            <div class="toolbar-left">
              <button data-cmd="bold" class="tool-btn">B</button>
              <button data-cmd="italic" class="tool-btn">I</button>
              <button data-cmd="underline" class="tool-btn">U</button>
              <button data-cmd="insertUnorderedList" class="tool-btn">‚Ä¢ List</button>
              <button data-cmd="insertOrderedList" class="tool-btn">1. List</button>
            </div>
            <div class="toolbar-right">
              <select id="tripTagSelect">
                <option value="">Insert Trip Tag‚Ä¶</option>
              </select>
              <select id="rateTagSelect">
                <option value="">Insert Rate Tag‚Ä¶</option>
              </select>
            </div>
          </div>

          <div id="templateEditor" class="editor" contenteditable="true">
            <p>Hello #TRIP_PAX_NAME#,</p>
            <p>Your trip #TRIP_CONFNUM# on #TRIP_DATE# at #TRIP_TIME# is confirmed.</p>
            <p>Pickup: #TRIP_PICKUP#<br/>Dropoff: #TRIP_DROPOFF#</p>
            <p>Total: #TRIP_RATES_TOTAL#</p>
            <p>Thank you!</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Saved Templates (local)</h2>
        </div>
        <div class="card-body" id="templateList"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Tag Reference</h2>
        </div>
        <div class="card-body tag-reference">
          <div>
            <h3>Trip Tags</h3>
            <ul id="tripTagList"></ul>
          </div>
          <div>
            <h3>Rate Tags</h3>
            <ul id="rateTagList"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="email-settings.js"></script>
  <script src="SecureSettingsManager.js"></script>
  <script>
    // Email Config Status Checker
    const EmailConfigChecker = {
      checkConfiguration() {
        const statusEl = document.getElementById('emailConfigStatus');
        if (!statusEl) return;
        
        const smtpHost = document.getElementById('smtpHostInput')?.value?.trim() || '';
        const smtpPort = document.getElementById('smtpPortInput')?.value?.trim() || '';
        const fromEmail = document.getElementById('fromEmailInput')?.value?.trim() || '';
        
        const checks = [
          { name: 'SMTP Host', valid: smtpHost.length > 3 },
          { name: 'SMTP Port', valid: parseInt(smtpPort) > 0 },
          { name: 'From Email', valid: fromEmail.includes('@') }
        ];
        
        const validCount = checks.filter(c => c.valid).length;
        const allValid = validCount === 3;
        const partialValid = validCount > 0 && validCount < 3;
        
        if (allValid) {
          statusEl.className = 'config-status configured';
          statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Email Configured</span>';
        } else if (partialValid) {
          statusEl.className = 'config-status partial';
          statusEl.innerHTML = `<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">Partial (${validCount}/3)</span>`;
        } else {
          statusEl.className = 'config-status not-configured';
          statusEl.innerHTML = '<span class="status-icon">‚ùå</span><span class="status-text">Not Configured</span>';
        }
      },
      
      init() {
        setTimeout(() => this.checkConfiguration(), 100);
        
        const inputs = ['smtpHostInput', 'smtpPortInput', 'fromEmailInput'];
        inputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', () => this.checkConfiguration());
            el.addEventListener('change', () => this.checkConfiguration());
          }
        });
        
        const saveBtn = document.getElementById('saveSettingsBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            setTimeout(() => this.checkConfiguration(), 200);
          });
        }
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      EmailConfigChecker.init();
      
      // Save Secure button
      const saveSecureBtn = document.getElementById('saveSecureBtn');
      if (saveSecureBtn) {
        saveSecureBtn.addEventListener('click', async () => {
          saveSecureBtn.disabled = true;
          saveSecureBtn.textContent = 'üîÑ Saving...';
          
          try {
            // First save locally
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) saveSettingsBtn.click();
            
            await new Promise(r => setTimeout(r, 300));
            
            if (window.SecureSettingsManager) {
              const result = await window.SecureSettingsManager.saveSecurely();
              
              if (result.saved) {
                if (result.supabase) {
                  alert('‚úÖ Settings saved securely to Supabase and local backup created.');
                } else {
                  alert('‚úÖ Settings saved to local backup. (Supabase table may need to be created)');
                }
              } else {
                alert('‚ö†Ô∏è ' + (result.reason || 'Could not save - check configuration'));
              }
            } else {
              alert('‚ùå SecureSettingsManager not loaded');
            }
          } catch (e) {
            console.error('Save secure error:', e);
            alert('‚ùå Error: ' + e.message);
          } finally {
            saveSecureBtn.disabled = false;
            saveSecureBtn.textContent = 'üîí Save Secure';
          }
        });
      }
      
      // Download .env button
      const downloadEnvBtn = document.getElementById('downloadEnvBtn');
      if (downloadEnvBtn) {
        downloadEnvBtn.addEventListener('click', () => {
          if (window.SecureSettingsManager) {
            const status = window.SecureSettingsManager.getStatus();
            
            if (!status.sms.configured && !status.email.configured) {
              if (!confirm('No settings are fully configured yet. Download anyway?')) {
                return;
              }
            }
            
            window.SecureSettingsManager.downloadEnvFile();
          } else {
            alert('‚ùå SecureSettingsManager not loaded');
          }
        });
      }
    });
  </script>
</body>
</html>
