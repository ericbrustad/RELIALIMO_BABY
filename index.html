<!DOCTYPE html>
<html lang="en" data-layout="vertical">
  <head>
    <!-- <script>
      // INSTANT startup page redirect - must be first script
      (function() {
        try {
          var s = localStorage.getItem('company_settings');
          if (s) {
            var p = JSON.parse(s).defaultStartPage;
            var r = {'new-reservation':'reservation-form.html','farmout-dashboard':'dashboard.html','office':'my-office.html','accounts':'accounts.html','calendar':'calendar.html','quotes':'quotes.html','dispatch':'dispatch-grid.html','network':'network.html','settle':'settle.html','receivables':'receivables.html','payables':'payables.html','memos':'memos.html','files':'files.html','tools':'tools.html','reports':'reports.html'};
            if (r[p] && window.location.pathname.indexOf(r[p]) === -1) {
              window.location.replace(r[p]);
              return;
            }
          }
        } catch(e) {
          console.error('Startup script failed:', e);
        }
        document.documentElement.style.visibility = 'visible';
      })();
    </script> -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RELIA LIMO‚Ñ¢</title>
    <link rel="icon" href="favicon.png" />
    <!-- Load Supabase SDK from unpkg CDN with ES module -->
    <!-- Supabase SDK is now loaded via ES Module import in config.js -->
    <!-- Load environment variables first -->
    <script src="env.js"></script>
    <script>
      // Apply saved layout mode early to avoid flash
      (function() {
        const savedLayout = localStorage.getItem('headerLayout') || 'vertical';
        document.documentElement.setAttribute('data-layout', savedLayout);
      })();
    </script>
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
    <script type="module" src="CompanySettingsManager.js"></script>
    <script type="module" src="SettingsApplicationManager.js"></script>
    <link rel="stylesheet" href="my-office.css" />
    <link rel="stylesheet" href="accounts.css" />
    <link rel="stylesheet" href="quotes.css" />
    <link rel="stylesheet" href="calendar.css" />
    <link rel="stylesheet" href="user-menu.css" />
    <style>
      :root {
        --sidebar-width: 170px;
      }

      /* Main section visibility control */
      .app-main-section {
        display: none !important;
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }
      .app-main-section.active {
        display: block !important;
        opacity: 1;
      }
      
      /* Smooth iframe transitions */
      .app-main-section iframe {
        transition: opacity 0.15s ease-in-out;
        width: 100% !important;
        height: calc(100vh - 24px) !important;
        border: none;
      }

      /* Base reset */
      body {
        margin: 0;
        padding: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Vertical layout */
      html[data-layout="vertical"] body {
        padding-left: var(--sidebar-width) !important;
      }

      html[data-layout="vertical"] #app > header.header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        bottom: 0 !important;
        width: var(--sidebar-width) !important;
        max-width: var(--sidebar-width) !important;
        min-width: var(--sidebar-width) !important;
        display: flex;
        flex-direction: column;
        background: #1f2a44;
        color: white;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        z-index: 1000;
      }

      html[data-layout="vertical"] #app > header.header .header-content {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
        height: 100%;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Logo + Controls container */
      html[data-layout="vertical"] #app > header.header .header-left {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 8px;
      }

      html[data-layout="vertical"] #app > header.header .main-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 4px;
      }

      /* Scrollbar styling for vertical nav */
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar {
        width: 6px;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 3px;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
      }
      html[data-layout="vertical"] #app > header.header .main-nav::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.35);
      }

      html[data-layout="vertical"] #app > header.header .nav-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
        color: white;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        border-radius: 6px;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      html[data-layout="vertical"] #app > header.header .nav-btn:hover {
        background: rgba(255,255,255,0.12);
        transform: translateX(2px);
      }

      html[data-layout="vertical"] #app > header.header .nav-btn.active {
        background: #e74c3c;
        border-color: #e74c3c;
      }

      html[data-layout="vertical"] #app > header.header .logo {
        font-size: 16px;
        font-weight: 800;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 0;
      }

      html[data-layout="vertical"] .app-main-section {
        padding: 12px;
        width: calc(100% - var(--sidebar-width)) !important;
        box-sizing: border-box;
      }

      /* Guard against global .header styles from iframes/other pages */
      #app > header.header {
        box-sizing: border-box;
      }

      /* Horizontal layout (original) */
      html[data-layout="horizontal"] body {
        padding: 0;
      }

      html[data-layout="horizontal"] #app > header.header {
        position: relative;
        width: 100%;
        display: block;
        background: #1f2a44;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      html[data-layout="horizontal"] #app > header.header .header-content {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 16px;
      }

      html[data-layout="horizontal"] #app > header.header .main-nav {
        display: flex;
        flex-direction: row;
        gap: 6px;
        flex: 1;
        flex-wrap: wrap;
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn {
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
        color: white;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        border-radius: 6px;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn:hover {
        background: rgba(255,255,255,0.12);
        transform: translateY(-1px);
      }

      html[data-layout="horizontal"] #app > header.header .nav-btn.active {
        background: #e74c3c;
        border-color: #e74c3c;
      }

      html[data-layout="horizontal"] .app-main-section {
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }

      html[data-layout="horizontal"] .app-main-section iframe {
        height: calc(100vh - 120px) !important;
      }

      /* Header Controls Inline (next to logo) */
      .header-controls-inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Layout switcher */
      .layout-toggle {
        position: fixed;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        width: 160px;
        z-index: 2001;
      }

      .layout-toggle button {
        padding: 6px 8px;
        font-size: 12px;
        font-weight: 700;
        border-radius: 6px;
        border: 1px solid #ccc;
        cursor: pointer;
        min-width: 0;
        width: calc(50% - 3px);
      }

      .layout-toggle button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
    </style>
    <script>
      function setLayout(mode) {
        const normalized = mode === 'horizontal' ? 'horizontal' : 'vertical';
        localStorage.setItem('headerLayout', normalized);
        document.documentElement.setAttribute('data-layout', normalized);
        document.querySelectorAll('.layout-toggle button').forEach(btn => {
          const isVerticalButton = btn.id === 'layoutVertical';
          const isActive = isVerticalButton ? normalized === 'vertical' : normalized === 'horizontal';
          btn.classList.toggle('active', isActive);
        });
      }

      function initLayoutToggle() {
        const savedLayout = localStorage.getItem('headerLayout') || 'vertical';
        setLayout(savedLayout);
        const verticalBtn = document.getElementById('layoutVertical');
        const horizontalBtn = document.getElementById('layoutHorizontal');
        if (verticalBtn && horizontalBtn) {
          verticalBtn.addEventListener('click', () => setLayout('vertical'));
          horizontalBtn.addEventListener('click', () => setLayout('horizontal'));
        }
      }

      document.addEventListener('DOMContentLoaded', initLayoutToggle);
    </script>
  </head>
  <body>
    <!-- Legacy layout toggle hidden - now in user menu pill -->
    <div class="layout-toggle" aria-label="Header layout selector" style="display:none;">
      <button id="layoutVertical">Vertical</button>
      <button id="layoutHorizontal">Horizontal</button>
    </div>
    <div id="app">
      <!-- UNIFIED HEADER -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="logo">RELIA<img src="https://rosebud.ai/assets/red-bull-logo.webp?5r88" alt="RELIA bull" class="logo-bull">LIMO‚Ñ¢</h1>
          </div>
          <div class="main-nav">
            <button class="nav-btn" data-section="new-reservation"><span>New Reservation</span><span style="font-size: 24px;">‚ûï</span></button>
            <button class="nav-btn" data-section="dashboard"><span>Farmout Dashboard</span><span style="font-size: 24px;">üè†</span></button>
            <button class="nav-btn active" data-section="office"><span>Office</span><span style="font-size: 24px;">üè¢</span></button>
            <button class="nav-btn" data-section="accounts"><span>Accounts</span><span style="font-size: 24px;">üë§</span></button>
            <button class="nav-btn" data-section="calendar"><span>Calendar</span><span style="font-size: 24px;">üìÖ</span></button>
            <button class="nav-btn" data-section="quotes"><span>Quotes</span><span style="font-size: 24px;">üìã</span></button>
            <button class="nav-btn" data-section="reservations"><span>Reservations</span><span style="font-size: 24px;">üöó</span></button>
            <button class="nav-btn" data-section="dispatch"><span>Dispatch</span><span style="font-size: 24px;">üöô</span></button>
            <button class="nav-btn" data-section="network"><span>Network</span><span style="font-size: 24px;">üåê</span></button>
            <button class="nav-btn" data-section="settle"><span>Settle</span><span style="font-size: 24px;">üí∞</span></button>
            <button class="nav-btn" data-section="receivables"><span>Receivables</span><span style="font-size: 24px;">üìä</span></button>
            <button class="nav-btn" data-section="payables"><span>Payables</span><span style="font-size: 24px;">üí≥</span></button>
            <button class="nav-btn" data-section="memos"><span>Memos</span><span style="font-size: 24px;">üìù</span></button>
            <button class="nav-btn" data-section="files"><span>Files</span><span style="font-size: 24px;">üìÅ</span></button>
            <button class="nav-btn" data-section="tools"><span>Tools</span><span style="font-size: 24px;">üîß</span></button>
            <button class="nav-btn" data-section="reports"><span>Reports</span><span style="font-size: 24px;">üìà</span></button>
          </div>
        </div>
      </header>

      <!-- FARMOUT DASHBOARD SECTION (User View, Driver View, Farm-out) -->
      <div id="dashboardSection" class="app-main-section">
        <iframe src="index-reservations.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- OFFICE SECTION -->
      <div id="officeSection" class="app-main-section active">
        <iframe src="my-office.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- ACCOUNTS SECTION -->
      <div id="accountsSection" class="app-main-section">
        <iframe src="accounts.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CALENDAR SECTION -->
      <div id="calendarSection" class="app-main-section">
        <iframe src="calendar.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- QUOTES SECTION -->
      <div id="quotesSection" class="app-main-section">
        <iframe src="quotes.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RESERVATIONS SECTION -->
      <div id="reservationsSection" class="app-main-section">
        <iframe src="reservations-list.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- DISPATCH SECTION -->
      <div id="dispatchSection" class="app-main-section">
        <iframe src="dispatch-grid.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NETWORK SECTION -->
      <div id="networkSection" class="app-main-section">
        <iframe src="network.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- SETTLE SECTION -->
      <div id="settleSection" class="app-main-section">
        <iframe src="settle.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- RECEIVABLES SECTION -->
      <div id="receivablesSection" class="app-main-section">
        <iframe src="receivables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- PAYABLES SECTION -->
      <div id="payablesSection" class="app-main-section">
        <iframe src="payables.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- MEMOS SECTION -->
      <div id="memosSection" class="app-main-section">
        <iframe src="memos.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- FILES SECTION -->
      <div id="filesSection" class="app-main-section">
        <iframe src="files.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- TOOLS SECTION -->
      <div id="toolsSection" class="app-main-section">
        <iframe src="tools.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- REPORTS SECTION -->
      <div id="reportsSection" class="app-main-section">
        <iframe src="reports.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- NEW RESERVATION SECTION -->
      <div id="new-reservationSection" class="app-main-section">
        <iframe src="reservation-form.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>

      <!-- CONFIRMED RESERVATION SECTION (VIEW MODE) -->
      <div id="confirmedReservationSection" class="app-main-section">
        <iframe src="confirmed-reservation.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
      </div>
    </div>

    <script>
      // Track which section is currently active to prevent redundant switches
      let currentActiveSection = 'office';
      const iframeCache = new Map();

      // Wire all navigation buttons with event delegation
      document.addEventListener('DOMContentLoaded', () => {
        // Check if user has a startup page preference and navigate there
        checkStartupPagePreference();
        
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.addEventListener('click', (e) => {
            const target = e.target;
            const btn = target instanceof Element ? target.closest('.nav-btn') : null;
            if (btn && btn.dataset.section) {
              switchMainSection(btn.dataset.section);
            }
          });
        }
      });

      /**
       * Check for startup page preference and navigate if applicable
       */
      function checkStartupPagePreference() {
        try {
          // Only navigate from index.html, index-reservations.html, or root path
          const currentPath = (window.location.pathname || '').toLowerCase();
          let currentFile = currentPath.split('/').pop() || '';
          
          // Remove .html extension for comparison
          if (currentFile.endsWith('.html')) {
            currentFile = currentFile.replace('.html', '');
          }
          
          console.log('[StartupPage] ========== CHECKING STARTUP PAGE NAVIGATION ==========');
          console.log('[StartupPage] Current file (normalized):', currentFile);
          
          // Valid entry points for startup page navigation (normalized without .html)
          const validEntryPoints = ['index', 'index-reservations', ''];
          const isValidEntry = validEntryPoints.includes(currentFile) || !currentFile;
          console.log('[StartupPage] Is valid entry point?', isValidEntry);
          
          if (!isValidEntry) {
            console.log('[StartupPage] Not on a valid entry point, skipping navigation');
            return;
          }

          // Check if CompanySettingsManager is available
          if (!window.CompanySettingsManager) {
            console.log('[StartupPage] CompanySettingsManager not available yet');
            return;
          }

          console.log('[StartupPage] ===== LOADING SETTINGS =====');
          const settingsManager = new window.CompanySettingsManager();
          const startPage = settingsManager.getSetting('defaultStartPage');
          console.log('[StartupPage] Raw getSetting("defaultStartPage"):', startPage);
          const finalPage = startPage || 'reservations';
          console.log('[StartupPage] After fallback:', finalPage);

          // Map setting values to section names
          const STARTUP_SECTIONS = {
            'new-reservation': 'new-reservation',
            'farmout-dashboard': 'dashboard',
            'office': 'office',
            'accounts': 'accounts',
            'calendar': 'calendar',
            'quotes': 'quotes',
            'reservations': 'reservations',
            'dispatch': 'dispatch',
            'network': 'network',
            'settle': 'settle',
            'receivables': 'receivables',
            'payables': 'payables',
            'memos': 'memos',
            'files': 'files',
            'tools': 'tools',
            'reports': 'reports'
          };

          const section = STARTUP_SECTIONS[finalPage];
          console.log('[StartupPage] ===== SECTION LOOKUP =====');
          console.log('[StartupPage] Looking up section for:', finalPage);
          console.log('[StartupPage] Available sections:', Object.keys(STARTUP_SECTIONS));
          console.log('[StartupPage] Section lookup result:', section);
          
          // If we found a valid section and it's not the default, navigate to it
          if (section && section !== 'office') { // 'office' is the default
            console.log('[StartupPage] ‚úÖ Navigating to startup section:', section);
            switchMainSection(section);
            return;
          }
          
          console.log('[StartupPage] Using default section (office)');
        } catch (error) {
          console.error('[StartupPage] Error checking startup page:', error);
        }
      }

      function switchMainSection(section) {
        const isNewReservationRequest = section === 'new-reservation';

        // Skip if already on this section unless forcing a fresh new reservation load
        if (currentActiveSection === section && !isNewReservationRequest) {
          console.log('‚ÑπÔ∏è Already on section:', section);
          return;
        }

        console.log('Switching to section:', section);
        currentActiveSection = section;
        
        // Update nav button active state
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.section === section) {
            btn.classList.add('active');
          }
        });

        // Hide all sections
        document.querySelectorAll('.app-main-section').forEach(sec => {
          sec.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(section + 'Section');
        if (sectionElement) {
          sectionElement.classList.add('active');
          console.log('‚úì Activated section:', section);
          
          // For reservations, ensure we're on the list view but don't reload if already there
          if (section === 'reservations') {
            const reservationsIframe = sectionElement.querySelector('iframe');
            if (reservationsIframe) {
              const currentSrc = (reservationsIframe.src || '').toLowerCase();
              if (!currentSrc.includes('reservations-list.html')) {
                console.log('üîÑ Loading reservations-list.html');
                reservationsIframe.src = 'reservations-list.html';
              } else {
                console.log('‚úì Reservations iframe already on list view, no reload');
              }
            }
          } else if (section === 'new-reservation') {
            const reservationIframe = sectionElement.querySelector('iframe');
            if (reservationIframe) {
              console.log('üîÑ Preparing fresh reservation form');
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              const timestamp = Date.now();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }
        } else {
          console.error('Section not found:', section + 'Section');
        }
      }

      // Listen for messages from iframes
      window.addEventListener('message', function(event) {
        // Handle reservation form signals
        if (event.data.action === 'reservationFormScriptLoaded') {
          console.log('üì® [iframe‚Üíparent] Reservation form script loaded, readyState:', event.data.readyState);
        } else if (event.data.action === 'reservationFormInitialized') {
          console.log('üì® [iframe‚Üíparent] Reservation form initialized, editMode:', event.data.editMode);
        }
        if (event.data.action === 'switchSection') {
          switchMainSection(event.data.section);
            if (event.data.section === 'reservations' && event.data.openConf) {
              // Give iframe time to load/become active before sending message
              setTimeout(() => {
                const reservationsIframe = document.querySelector('#reservationsSection iframe');
                if (reservationsIframe && reservationsIframe.contentWindow) {
                  console.log('üì§ Sending openReservation message to reservations list:', event.data.openConf);
                  reservationsIframe.contentWindow.postMessage({
                    action: 'openReservation',
                    conf: event.data.openConf
                  }, '*');
                }
              }, 300);
            }
        } else if (event.data.action === 'openReservation') {
          // Handle opening a saved reservation from reservations-list iframe
          const confNumber = event.data.openConf || event.data.conf;
          // Switch to confirmed-reservation section (view mode) - NOT new-reservation
          switchMainSection('confirmedReservation');
          
          // Small delay to ensure section is visible
          setTimeout(() => {
            const reservationIframe = document.querySelector('#confirmedReservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              reservationIframe.dataset.viewMode = 'true';
              // Load confirmed-reservation.html (view mode) instead of the edit form
              const timestamp = new Date().getTime();
              const encodedConf = encodeURIComponent(confNumber);
              reservationIframe.src = `confirmed-reservation.html?conf=${encodedConf}&_reload=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'newReservation') {
          // Handle new reservation request from reservation form
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Clear any stored conf number
              reservationIframe.dataset.confNumber = '';
              delete reservationIframe.dataset.viewMode;
              // Force reload to get a fresh blank form
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_new=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'editReservation') {
          // Handle edit mode request from confirmed-reservation iframe
          const confNumber = event.data.conf;
          // Switch to new-reservation section for editing
          switchMainSection('new-reservation');
          
          setTimeout(() => {
            const reservationIframe = document.querySelector('#new-reservationSection iframe');
            if (reservationIframe) {
              // Store conf as data attribute on the iframe
              reservationIframe.dataset.confNumber = confNumber;
              delete reservationIframe.dataset.viewMode;
              // Load reservation-form.html in edit mode
              const timestamp = new Date().getTime();
              reservationIframe.src = `reservation-form.html?_edit=${timestamp}`;
            }
          }, 50);
        } else if (event.data.action === 'switchToReservations') {
          // Switch back to reservations list
          switchMainSection('reservations');
        } else if (event.data.action === 'navigate') {
        } else if (event.data.action === 'switchToDashboard') {
          // Switch to dashboard first
          switchMainSection('dashboard');
          // Then send message to dashboard iframe to switch view
          setTimeout(() => {
            const dashboardIframe = document.querySelector('#dashboardSection iframe');
            if (dashboardIframe && dashboardIframe.contentWindow) {
              dashboardIframe.contentWindow.postMessage({
                action: 'switchView',
                view: event.data.view
              }, '*');
            }
          }, 100);
        } else if (event.data.action === 'navigateToSystemMapping') {
          // Switch to Office section
          switchMainSection('office');
          // Then send message to office iframe to navigate to System Settings > System Mapping
          setTimeout(() => {
            const officeIframe = document.querySelector('#officeSection iframe');
            if (officeIframe && officeIframe.contentWindow) {
              officeIframe.contentWindow.postMessage({
                action: 'navigateToSystemSettings',
                page: 'system-mapping'
              }, '*');
            }
          }, 100);
        }
      });
      
      // Utility to purge ghost reservations from localStorage
      window.purgeAllGhostReservations = function() {
        localStorage.removeItem('relia_reservations');
        sessionStorage.removeItem('relia_ghost_purge_v1');
        console.log('[ManualPurge] Cleared all cached reservations. Reloading...');
        location.reload();
      };
    </script>

    <!-- Authentication Protection & User Menu -->
    <script type="module" src="auth-guard.js"></script>
    <script type="module" src="user-menu.js"></script>
    <!-- Company Settings & Application -->
    <script src="CompanySettingsManager.js"></script>
    <script src="SettingsApplicationManager.js"></script>
  </body>
</html>
