<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <title>Driver Dashboard | RELIALIMO</title>
  <link rel="icon" href="favicon.ico">
  <link rel="manifest" href="driver-portal-manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="driver-portal.css">
  <!-- Load ENV first -->
  <script src="../shared/env.js"></script>
  <script>
    // Auth guard - redirect to auth.html if not logged in
    (function() {
      try {
        const session = localStorage.getItem('supabase_session');
        if (!session) {
          window.location.replace('auth.html');
          return;
        }
        const parsed = JSON.parse(session);
        if (!parsed?.access_token) {
          window.location.replace('auth.html');
          return;
        }
        // Check if token is expired (basic check)
        if (parsed.expires_at) {
          const expiresAt = parsed.expires_at < 1e11 ? parsed.expires_at * 1000 : parsed.expires_at;
          if (Date.now() > expiresAt) {
            console.log('Session expired, redirecting to auth');
            localStorage.removeItem('supabase_session');
            localStorage.removeItem('supabase_access_token');
            window.location.replace('auth.html');
            return;
          }
        }
      } catch (e) {
        console.warn('Auth guard error:', e);
        window.location.replace('auth.html');
      }
    })();
  </script>
</head>
<body>
  <div id="app">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active">
      <div class="loading-content">
        <div class="logo-pulse"><img src="favicon.ico" alt="Logo" class="favicon-logo"></div>
        <h1 class="brand-name">RELIA<img src="favicon.ico" alt="" class="brand-icon">LIMO<span class="trademark">â„¢</span></h1>
        <p>Driver Portal</p>
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; color: var(--text-secondary);">Loading dashboard...</p>
      </div>
    </div>

    <!-- Dashboard content will be loaded by driver-portal.js -->
    <div id="dashboardContainer"></div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>
  </div>

  <script src="../shared/sms-service.js"></script>
  <script type="module">
    import { getSupabaseCredentials } from '../shared/supabase-config.js';
    
    // Redirect to driver's personal portal URL
    async function redirectToDriverPortal() {
      try {
        const session = JSON.parse(localStorage.getItem('supabase_session') || '{}');
        const user = session.user;
        
        if (!user) {
          window.location.href = 'auth.html';
          return;
        }
        
        console.log('[DriverDashboard] User:', user.email);
        
        // Check for cached driver info
        const driverInfo = localStorage.getItem('current_driver');
        if (driverInfo) {
          const driver = JSON.parse(driverInfo);
          const slug = driver.portal_slug || 
            `${(driver.first_name || '').toLowerCase()}_${(driver.last_name || '').toLowerCase()}`.replace(/[^a-z0-9_]/g, '');
          window.location.href = `/${slug}`;
          return;
        }
        
        // Fetch driver info
        const creds = getSupabaseCredentials();
        const response = await fetch(
          `${creds.url}/rest/v1/drivers?email=eq.${encodeURIComponent(user.email.toLowerCase())}&select=id,first_name,last_name,portal_slug`,
          {
            headers: {
              'apikey': creds.anonKey,
              'Authorization': `Bearer ${session.access_token}`
            }
          }
        );
        
        if (response.ok) {
          const drivers = await response.json();
          if (drivers && drivers.length > 0) {
            const driver = drivers[0];
            localStorage.setItem('current_driver', JSON.stringify(driver));
            const slug = driver.portal_slug || 
              `${(driver.first_name || '').toLowerCase()}_${(driver.last_name || '').toLowerCase()}`.replace(/[^a-z0-9_]/g, '');
            window.location.href = `/${slug}`;
            return;
          }
        }
        
        // Fallback
        window.location.href = 'driver-portal.html?view=dashboard';
        
      } catch (err) {
        console.error('[DriverDashboard] Error:', err);
        window.location.href = 'auth.html';
      }
    }
    
    redirectToDriverPortal();
  </script>
</body>
</html>
